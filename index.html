<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED & EVG Drag-and-Drop Werkbank</title>
    <style>
        :root {
            /* Standard-Elektrofarben */
            --wire-brown: #683c11;           /* Phase L1 */
            --wire-blue: #1d71b8;            /* Neutral N */
            --wire-yellow-green: #ffed00;    /* Schutzleiter PE */
            --wire-black: #1d1d1b;           /* Allgemein/Minus */
            --wire-red: #e30613;             /* Plus/Phase */
            
            /* Standard-Materialien */
            --metal-dark: #3c3c3b;           /* Dunkles Metall */
            --metal-light: #878787;          /* Helles Metall */
            --plastic-light: #e8e8e8;        /* Heller Kunststoff */
            --plastic-dark: #9e9e9e;         /* Dunkler Kunststoff */
            --housing-white: #ffffff;        /* Weißes Gehäuse */
            
            /* Interface-Farben */
            --font-family: Arial, sans-serif;
            --font-size-h1: 18px;
            --font-size-h2: 14px;
            --font-size-text: 16px;
            --font-size-small: 12px;
            --font-weight-h1: bold;
            --font-weight-h2: bold;
            --font-weight-text: normal;
            --font-weight-small: normal;
            --color-primary: #333;
            --color-secondary: #666;
            --color-light: #f8f9fa;
            --color-border: #dee2e6;
            --color-hover: #e8f5e8;
            --color-hover-border: #4CAF50;
            --color-background: #f0f0f0;
            --color-white: white;
            --color-success: #008800;
            --color-error: #cc0000;
            --color-warning: #856404;
            --color-success-bg: #e6ffe6;
            --color-error-bg: #ffe6e6;
            --color-warning-bg: #fff3cd;
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 10px;
            --spacing-lg: 15px;
            --spacing-xl: 20px;
            --border-radius: 8px;
            --border-width: 2px;
            --border-color: #333;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --box-shadow-hover: 0 4px 12px rgba(76, 175, 80, 0.2);
            --svg-stroke-width: 2px;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--color-background);
            display: flex;
            height: 100vh;
        }

        /* Typography */
        .text-h1 {
            font-size: var(--font-size-h1);
            font-weight: var(--font-weight-h1);
            color: var(--color-primary);
            margin: 0;
            padding-bottom: var(--spacing-md);
            border-bottom: var(--border-width) solid #eee;
        }

        .text-h2 {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin: 0;
        }

        .text-body {
            font-size: var(--font-size-text);
            font-weight: var(--font-weight-text);
            color: var(--color-secondary);
            line-height: 1.5;
            margin: 0;
        }

        .text-small {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-small);
            color: var(--color-secondary);
            line-height: 1.4;
        }

        /* Layout */
        .layout-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        .sidebar-left {
            width: 260px;
            background: var(--color-white);
            border-right: var(--border-width) solid var(--border-color);
            padding: var(--spacing-lg);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-xl);
            min-width: 0;
        }

        /* Task Area */
        .task-area {
            background: var(--color-white);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .task-menu-btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }

        .task-menu-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }

        /* Workspace */
        .workspace {
            flex: 1;
            background: var(--color-white);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            min-height: 400px;
        }

        .workspace-info-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            width: 30px;
            height: 30px;
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: bold;
            color: var(--color-primary);
            z-index: 100;
        }

        .workspace-info-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: scale(1.1);
        }

        .version-display {
            position: absolute;
            top: var(--spacing-md);
            right: 50px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-family: monospace;
            z-index: 95;
            pointer-events: none;
        }

        .info-tooltip {
            position: absolute;
            top: 45px;
            right: -10px;
            width: 320px;
            max-height: 500px;
            background: var(--color-white);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
            color: var(--color-primary);
            font-size: var(--font-size-small);
            overflow-y: auto;
        }

        .workspace-info-btn:hover + .info-tooltip,
        .info-tooltip:hover {
            opacity: 1;
            visibility: visible;
        }

        .info-category {
            margin-bottom: var(--spacing-lg);
        }

        .info-category:last-child {
            margin-bottom: 0;
        }

        .info-category-title {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            border-bottom: 1px solid #eee;
            padding-bottom: var(--spacing-xs);
        }

        .info-rule {
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }

        .info-rule:last-child {
            margin-bottom: 0;
        }

        /* Components Section */
        .components-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .components-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-sm);
        }

        .components-list {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-xs);
        }

        /* Datasheet Section */
        .datasheet-section {
            flex-shrink: 0;
            height: 300px;
            display: flex;
            flex-direction: column;
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .datasheet-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .datasheet-toggle {
            background: var(--color-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            min-width: 60px;
            text-align: center;
        }

        .datasheet-toggle:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
        }

        .datasheet-section.collapsed {
            height: auto;
        }

        .datasheet-section.collapsed .datasheet-content {
            display: none;
        }

        .technical-datasheet {
            flex-shrink: 0;
        }

        .datasheet-content {
            height: 200px;
            overflow-y: auto;
            padding: var(--spacing-md) 0;
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            background: var(--color-light);
        }

        /* Component Items */
        .component-item {
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }

        .component-item:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }

        .component-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }

        .component-name {
            margin-bottom: var(--spacing-xs);
        }

        .component-category {
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .category-title {
            margin-bottom: var(--spacing-md);
        }

        /* Buttons */
        .btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            margin: var(--spacing-xs);
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }

        .btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            border-color: #ccc;
            transform: none;
        }

        /* Function Controls */
        .function-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: var(--border-width) solid #eee;
            justify-content: flex-start;
            align-items: center;
        }

        .function-controls .btn {
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
            justify-content: center;
            min-width: 0;
        }

        .power-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .power-icon svg {
            width: 100%;
            height: 100%;
        }

        .btn-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        /* Component States */
        .component {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: border 0.3s ease;
            border: var(--border-width) solid transparent;
        }

        .component:hover {
            border: var(--border-width) solid var(--color-hover-border);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        .component.dragging {
            z-index: 1000;
            border: var(--border-width) solid #FF9800;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.5);
        }

        .component.selected {
            border: 2px solid #4CAF50 !important;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5) !important;
        }

        .component.dragging {
            z-index: 1000 !important;
            opacity: 0.8 !important;
            cursor: grabbing !important;
            border: 2px solid #FF9800 !important;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.5) !important;
        }

        .component {
            transition: transform 0.3s ease !important;
            transform-origin: center center !important;
        }

        /* Power Source */
        .power-source {
            position: absolute;
            top: var(--spacing-xl);
            left: var(--spacing-xl);
            background: transparent;
            border: none;
            border-radius: var(--border-radius);
            padding: 0;
            color: var(--color-warning);
            box-shadow: none;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }

        .power-source svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        /* Connection System */
        .connection-point {
            cursor: crosshair;
            transition: all 0.3s ease;
        }

        .connection-point:hover {
            transform: scale(1.5);
            opacity: 1 !important;
        }

        .connection-point.dragging-connection {
            opacity: 1 !important;
            transform: scale(1.8);
        }

        .connection-socket { 
            fill: #888; 
            stroke: #666; 
            stroke-width: 1; 
            cursor: crosshair; 
            transition: all 0.3s; 
            opacity: 0.7; 
        }

        .connection-socket:hover { 
            opacity: 1; 
            transform: scale(1.3); 
            fill: #4CAF50;
        }

        .connection-line {
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.8;
        }

        .connection-line:hover {
            opacity: 1;
            stroke-width: 4;
            filter: drop-shadow(0 0 3px currentColor);
        }

        .connection-area {
            cursor: crosshair;
            transition: all 0.3s;
            opacity: 0;
        }

        .connection-area:hover {
            opacity: 0.2;
            fill: #4CAF50;
        }

        .connection-area:hover + .connection-visual {
            opacity: 1;
            transform: scale(1.3);
            filter: drop-shadow(0 0 5px #4CAF50);
        }

        .connection-visual {
            transition: all 0.3s;
            opacity: 0.8;
        }

        /* Bezier Connections */
        .bezier-connection {
            fill: none;
            stroke-width: 3;
            opacity: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.9;
            pointer-events: all;
            stroke-width: 4;
        }

        .bezier-connection:hover {
            opacity: 1;
            stroke-width: 6;
            filter: drop-shadow(0 0 5px currentColor);
        }

        .bezier-connection.red-wire {
            stroke: #ff0000;
        }

        .bezier-connection.black-wire {
            stroke: #000000;
        }

        /* LED Cables */
        .led-cable {
            fill: none;
            stroke-width: 3;
            pointer-events: none;
        }

        .led-cable.plus {
            stroke: #ff0000;
        }

        .led-cable.minus {
            stroke: #000000;
        }

        .temp-line {
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            opacity: 0.7;
        }

        /* Dragging Component */
        .dragging-component {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
        }

        /* LED Module */
        .led-module-svg {
            width: auto;
            height: 30px;
        }

        /* Transformer Module */
        .transformer-svg {
            width: auto;
            height: 45px; /* Trafos sind höher als LEDs */
        }

        /* Transformer Styles */
        .trafo-housing { 
            fill: #e8e8e8; 
            stroke: #1d1d1b; 
            stroke-width: 2; 
        }
        
        .trafo-text { 
            fill: #1d1d1b; 
            font-family: Arial, sans-serif; 
            font-size: 8px; 
        }
        
        .trafo-label { 
            fill: #1d1d1b; 
            font-family: Arial, sans-serif; 
            font-size: 6px; 
        }



        /* Info Box */
        .info-box {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--color-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
        }

        .info-box h4 {
            margin-top: 0;
            color: var(--color-primary);
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }

        .info-box p {
            margin-bottom: var(--spacing-sm);
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }

        /* LED States - JavaScript + CSS Hybrid */
        .state-off .cls-5, 
        .state-off .led24-center {
            fill: #ddd !important;
        }

        .state-on .cls-5, 
        .state-on .led24-center {
            fill: #ffff00 !important;
        }

        .state-blinking .cls-5, 
        .state-blinking .led24-center {
            fill: #ffff00 !important;
        }

        .state-broken .cls-5, 
        .state-broken .led24-center {
            fill: #1a1a1a !important;
        }

        .state-overloaded .cls-5, 
        .state-overloaded .led24-center {
            fill: #e91e63 !important;
        }

        /* Rauch-Animationen für kaputte LEDs */
        .smoke-group {
            animation: smokeFloat 5s infinite linear;
        }
        
        .smoke-group-alt {
            animation: smokeFloatAlt 5s infinite linear;
        }
        
        .smoke-1 {
            animation-delay: 0s;
        }
        
        .smoke-2 {
            animation-delay: 0.5s;
        }
        
        .smoke-3 {
            animation-delay: 1s;
        }
        
        .smoke-alt-1 {
            animation-delay: 0s;
        }
        
        .smoke-alt-2 {
            animation-delay: 0.5s;
        }
        
        .smoke-alt-3 {
            animation-delay: 1s;
        }
        
        @keyframes smokeFloat {
            0% { 
                opacity: 0.7; 
                transform: translateY(0) scale(0.8) rotate(0deg); 
            }
            50% { 
                opacity: 0.4; 
                transform: translateY(-15px) scale(1.1) rotate(5deg); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-30px) scale(1.4) rotate(10deg); 
            }
        }
        
        @keyframes smokeFloatAlt {
            0% { 
                opacity: 0.6; 
                transform: translateY(0) scale(0.9) rotate(0deg); 
            }
            50% { 
                opacity: 0.3; 
                transform: translateY(-18px) scale(1.2) rotate(-7deg); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-35px) scale(1.6) rotate(-12deg); 
            }
        }

        /* Connection States */
        .connection-socket.connected,
        .connection-line.connected {
            opacity: 0 !important;
            pointer-events: none;
        }

        /* === LED FOUNDATION SVG STANDARDS v1.0 === */

        /* Standard Elektro-Farben */
        .std-wire-plus { stroke: var(--wire-red); fill: none; stroke-width: 3; }
        .std-wire-minus { stroke: var(--wire-black); fill: none; stroke-width: 3; }
        .std-wire-phase { stroke: var(--wire-brown); fill: none; stroke-width: 3; }
        .std-wire-neutral { stroke: var(--wire-blue); fill: none; stroke-width: 3; }
        .std-wire-earth { stroke: var(--wire-yellow-green); fill: none; stroke-width: 3; }

        /* Standard Material-Farben */
        .std-housing-light { fill: var(--plastic-light); stroke: var(--color-primary); stroke-width: 1; }
        .std-housing-dark { fill: var(--plastic-dark); stroke: var(--color-primary); stroke-width: 1; }
        .std-metal-light { fill: var(--metal-light); stroke: var(--color-primary); stroke-width: 1; }
        .std-metal-dark { fill: var(--metal-dark); stroke: var(--color-primary); stroke-width: 1; }
        .std-led-off { fill: #ccc; stroke: var(--color-primary); stroke-width: 1; }

        /* Standard Strichstärken */
        .std-hairline { stroke-width: 0.5; }
        .std-thin { stroke-width: 1; }
        .std-cable { stroke-width: 3; }
        .std-connection { stroke-width: 3; }
        .std-thick { stroke-width: 5; }

        /* Standard Text */
        .std-text { fill: var(--color-primary); font-family: Arial, sans-serif; stroke: none; }
        .std-text-small { font-size: 6px; }
        .std-text-medium { font-size: 8px; }
        .std-text-large { font-size: 10px; }

        /* Connection Line Hover Effects */
        .connection-line {
            stroke-width: 4;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.8;
            fill: none;
        }

        .connection-line:hover {
            opacity: 1;
            stroke-width: 6;
            filter: drop-shadow(0 0 3px currentColor);
        }

        .connection-socket {
            fill: #4CAF50;
            stroke: #333;
            stroke-width: 1;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .connection-socket:hover { 
            opacity: 1; 
            transform: scale(1.3); 
            fill: #4CAF50;
        }



        /* Wire Type Colors for Power Source */
        .connection-line.std-wire-plus { stroke: var(--wire-red); }
        .connection-line.std-wire-minus { stroke: var(--wire-black); }
        .connection-line.std-wire-phase { stroke: var(--wire-brown); }
        .connection-line.std-wire-neutral { stroke: var(--wire-blue); }
        .connection-line.std-wire-earth { stroke: var(--wire-yellow-green); }

        .wire-hover-area.std-wire-plus { color: var(--wire-red); }
        .wire-hover-area.std-wire-minus { color: var(--wire-black); }
        .wire-hover-area.std-wire-phase { color: var(--wire-brown); }
        .wire-hover-area.std-wire-neutral { color: var(--wire-blue); }
        .wire-hover-area.std-wire-earth { color: var(--wire-yellow-green); }

        /* Standard Gradients für Schalter */
        .std-gradient-off {
            stop-color: var(--color-border);
        }

        .std-gradient-on {
            stop-color: var(--color-success);
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <div class="sidebar-left">
            <div class="datasheet-section" id="datasheet-section">
                <div class="datasheet-header">
                    <h3 class="text-h1">Technisches Datenblatt</h3>
                    <button class="datasheet-toggle" onclick="toggleDatasheet()" id="datasheet-toggle">
                        ▲
                    </button>
                </div>
                
                <div class="technical-datasheet">
                    <div class="datasheet-content" id="datasheet-content-wrapper">
                        <div id="datasheet-content" class="text-small">
                            <p><em>Bewege den Cursor über ein Bauteil, um technische Informationen und Schaltskizzen anzuzeigen.</em></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="components-section">
                <div class="components-header">
                    <h2 class="text-h1">Bauteile</h2>
                </div>
                
                <div class="components-list">
                    <div class="component-category">
                        <div class="category-title text-h2">Schutzschalter</div>
                        <div class="component-item" data-component-type="fi-schalter">
                            <div class="component-name text-h2">FI-Schutzschalter</div>
                            <div class="component-specs text-small">
                                30mA, 16A<br>
                                Fehlerstromschutz
                            </div>
                        </div>
                        <div class="component-item" data-component-type="ls-schalter">
                            <div class="component-name text-h2">LS-Schalter</div>
                            <div class="component-specs text-small">
                                16A, Überlastschutz<br>
                                Charakteristik B
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-title text-h2">Steuerungen</div>
                        <div class="component-item" data-component-type="zeitschaltuhr">
                            <div class="component-name text-h2">Zeitschaltuhr</div>
                            <div class="component-specs text-small">
                                Digital, 16A<br>
                                Tages-/Wochenprogramm
                            </div>
                        </div>
                        <div class="component-item" data-component-type="daemmerungsschalter">
                            <div class="component-name text-h2">Dämmerungsschalter</div>
                            <div class="component-specs text-small">
                                10A, einstellbar<br>
                                2-200 Lux
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-title text-h2">Transformatoren</div>
                        <div class="component-item" data-component-type="trafo-12v-40w">
                            <div class="component-name text-h2">Trafo 12V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 12V DC, 40W
                            </div>
                        </div>
                        <div class="component-item" data-component-type="trafo-24v-60w">
                            <div class="component-name text-h2">Trafo 24V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 24V DC, 60W
                            </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-title text-h2">LED-Module</div>
                        <div class="component-item" data-component-type="led-12v-1.2w">
                            <div class="component-name text-h2">LED-Modul 12V-1,2W-WW</div>
                            <div class="component-specs text-small">
                                1,2W, Warmweiß<br>
                                12V DC, 3x LED
                            </div>
                        </div>
                        <div class="component-item" data-component-type="led-24v-5w">
                            <div class="component-name text-h2">LED-Modul 24V</div>
                            <div class="component-specs text-small">
                                5W, Warmweiß<br>
                                24V DC
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-area">
            <div class="task-area">
                <div class="task-header">
                    <h3 class="text-h1">Aufgabenstellung</h3>
                    <button class="task-menu-btn" onclick="openTaskMenu()">
                        Zum Aufgaben-Menü
                    </button>
                </div>
                
                <p class="text-body">
                    Baue eine Schaltung mit einem 12V Transformator und verbinde die LED-Module korrekt. 
                    Achte auf die richtige Polarität und die maximale Leistung des Transformators.
                </p>
                
                <div class="function-controls">
                    <button id="powerBtn" class="btn" onclick="togglePower()">
                        <span class="power-icon">
                            <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                        <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                        <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                        <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                        <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                                <g>
                                    <g>
                                        <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                                 points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                              x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                              x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                    </g>
                                    <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x="5.36" y="7.68" width="11.18" height="4.98"/>
                                    <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                          transform="translate(6.36 11.7)">
                                        <tspan x="0" y="0">O</tspan>
                                        <tspan x="2.92" y="0">-</tspan>
                                        <tspan x="4.27" y="0">off</tspan>
                                    </text>
                                </g>
                            </svg>
                        </span>
                        <span class="btn-text">
                            <span>Haupt-</span>
                            <span>schalter</span>
                        </span>
                    </button>
                    
                    <button class="btn" onclick="clearWorkspace()">
                        Arbeitsfläche leeren
                    </button>
                    
                    <button class="btn" onclick="resetConnections()">
                        Verbindungen zurücksetzen
                    </button>
                </div>
            </div>
            
            <div class="workspace" id="workspace">
                <div class="version-display">v0.00.32</div>
                <div class="workspace-info-btn" id="info-btn">
                    i
                </div>
                <div class="info-tooltip" id="info-tooltip">
                    <div class="info-category">
                        <div class="info-category-title">Bauteile</div>
                        <div class="info-rule">• Aus Sidebar ziehen zum Platzieren</div>
                        <div class="info-rule">• Klick: Einzelnes Bauteil auswählen</div>
                        <div class="info-rule">• Strg + Klick: Mehrere Bauteile auswählen</div>
                        <div class="info-rule">• Rechteck aufziehen: Gruppenauswahl</div>
                        <div class="info-rule">• Doppelklick: 90° Drehung</div>
                        <div class="info-rule">• Ziehen: Ausgewählte Bauteile verschieben</div>
                        <div class="info-rule">• Entf-Taste: Ausgewählte Bauteile löschen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Verbindungen</div>
                        <div class="info-rule">• Anschlusspunkte verbinden durch Klicken und Ziehen</div>
                        <div class="info-rule">• Klick auf Verbindung: Auswählen</div>
                        <div class="info-rule">• Entf-Taste: Ausgewählte Verbindung löschen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Allgemein</div>
                        <div class="info-rule">• Klick ins Leere: Auswahl aufheben</div>
                        <div class="info-rule">• Esc-Taste: Alle Auswahlen aufheben</div>
                        <div class="info-rule">• Strg + Z: Rückgängig (geplant)</div>
                    </div>
                </div>
                
                <div class="power-source" id="power-source-svg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50.29 115.10" width="50.29" height="115.10">
                        <defs>
                            <style>
                                .power-cls-4 {
                                    fill: #3c3c3b;
                                    stroke: #1d1d1b;
                                    stroke-width: 1.6px;
                                }
                                .power-cls-5 {
                                    fill: #878787;
                                }
                            </style>
                        </defs>
                        <g data-name="Ebene_1">
                            <!-- Gehäuse (×1.6 skaliert) -->
                            <circle class="std-metal-dark" cx="25.14" cy="25.14" r="24.34"/>
                            <path class="std-metal-light" d="M14.19,26.98c0-7.09,4.94-12.93,10.94-12.93s10.94,5.84,10.94,12.93v59.71l-21.87-.27c0-19.81,0-39.62-.01-59.43Z"/>
                        </g>
                        
                        <!-- Connection Points -->
                        <g data-name="connections">

                            
                            <!-- Connection Lines (Workspace-Koordinaten) -->
                            <line class="connection-line" 
                                  x1="18.83" y1="86.4" x2="18.83" y2="102.4" 
                                  stroke="#683c11"
                                  data-connection-type="output-line"
                                  data-connection-id="out-phase"
                                  data-wire-type="phase"
                                  data-voltage="230"
                                  data-bezier-start-x="38.83" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                                  
                            <line class="connection-line" 
                                  x1="31.44" y1="86.4" x2="31.44" y2="102.4" 
                                  stroke="#1d71b8"
                                  data-connection-type="output-line"
                                  data-connection-id="out-neutral"
                                  data-wire-type="neutral"
                                  data-voltage="230"
                                  data-bezier-start-x="51.44" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                                  
                            <line class="connection-line" 
                                  x1="25.09" y1="86.4" x2="25.09" y2="102.4" 
                                  stroke="#ffed00"
                                  data-connection-type="output-line"
                                  data-connection-id="out-earth"
                                  data-wire-type="earth"
                                  data-voltage="230"
                                  data-bezier-start-x="45.09" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                        </g>
                    </svg>
                </div>
                
                <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                </svg>
            </div>
        </div>
    </div>

    <script>
        // ===== CIRCUIT SIMULATION ENGINE =====

        // Globale Variablen
        let systemPower = false;
        let connections = [];
        let components = [];

        // Komponenten-Typen
        const ComponentTypes = {
            POWER_SOURCE: 'power-source',
            TRANSFORMER_12V: 'trafo-12v-40w',
            TRANSFORMER_24V: 'trafo-24v-60w',
            LED_12V_1_2W: 'led-12v-1.2w',
            LED_12V: 'led-12v-3.5w',
            LED_24V: 'led-24v-5w',
            FI_SWITCH: 'fi-schalter',
            LS_SWITCH: 'ls-schalter'
        };

        // Technische Spezifikationen
        const ComponentSpecs = {
            [ComponentTypes.POWER_SOURCE]: {
                voltage: 230,
                maxCurrent: 16,
                type: 'source'
            },
            [ComponentTypes.TRANSFORMER_12V]: {
                inputVoltage: 230,
                outputVoltage: 12,
                maxPower: 40,
                type: 'transformer'
            },
            [ComponentTypes.TRANSFORMER_24V]: {
                inputVoltage: 230,
                outputVoltage: 24,
                maxPower: 60,
                type: 'transformer'
            },
            [ComponentTypes.LED_12V_1_2W]: {
                ratedVoltage: 12,
                power: 1.2,
                tolerance: 1.1,
                type: 'load'
            },
            [ComponentTypes.LED_12V]: {
                ratedVoltage: 12,
                power: 3.5,
                tolerance: 1.1,
                type: 'load'
            },
            [ComponentTypes.LED_24V]: {
                ratedVoltage: 24,
                power: 5,
                tolerance: 1.1,
                type: 'load'
            }
        };

        // Zustände der Komponenten
        const ComponentStates = {
            OFF: 'off',
            ON: 'on',
            BLINKING: 'blinking',
            BROKEN: 'broken',
            OVERLOADED: 'overloaded'
        };

        // ===== COMPONENT STATE MACHINE =====
        class ComponentStateMachine {
            constructor(componentType, elementId) {
                this.type = componentType;
                this.elementId = elementId;
                this.state = ComponentStates.OFF;
                this.specs = ComponentSpecs[componentType];
                this.currentVoltage = 0;
                this.currentPower = 0;
                
                // Blink-Animation State
                this.blinkInterval = null;
                this.blinkState = true;
                
                // Rauch-Animation State
                this.smokeElements = [];
                
                // Initial state CSS setzen
                this.applyStateCSS();
                
                // Warte kurz bis SVG im DOM ist, dann färbe
                setTimeout(() => {
                    this.applyDynamicColors();
                }, 100);
            }
            
            updateState(voltage, current) {
                this.currentVoltage = voltage;
                this.currentPower = voltage * current;
                
                const previousState = this.state;
                
                if (this.specs.type === 'load') {
                    this.state = this.calculateLEDState(voltage);
                } else if (this.specs.type === 'transformer') {
                    this.state = this.calculateTransformerState();
                }
                
                if (previousState !== this.state) {
                    this.animateStateChange();
                    this.updateBlinkAnimation();
                    this.updateSmokeAnimation();
                }
            }
            
            calculateLEDState(voltage) {
                if (voltage === 0) return ComponentStates.OFF;
                
                const ratedVoltage = this.specs.ratedVoltage;
                const tolerance = this.specs.tolerance;
                
                // Toleranz 1.1 = 110% zusätzlich, also Faktoren:
                const maxNormal = ratedVoltage * tolerance;        // 12V * 1.1 = 13.2V
                const maxBlink = ratedVoltage * (tolerance * 2);   // 12V * 2.2 = 26.4V  
                const minVoltage = ratedVoltage * 0.8;             // 12V * 0.8 = 9.6V (20% unter Nennspannung)
                
                console.log(`🔍 LED State Calc: ${voltage}V für ${ratedVoltage}V LED`);
                console.log(`📊 Grenzen: ON>${minVoltage}V, BLINK>${maxNormal}V, BROKEN>${maxBlink}V`);
                
                if (voltage > maxBlink) {
                    console.log(`🔴 BROKEN: ${voltage}V > ${maxBlink}V`);
                    return ComponentStates.BROKEN;
                }
                
                if (voltage > maxNormal) {
                    console.log(`🟠 BLINKING: ${voltage}V > ${maxNormal}V`);
                    return ComponentStates.BLINKING;
                }
                
                if (voltage >= minVoltage) {
                    console.log(`🟡 ON: ${voltage}V >= ${minVoltage}V`);
                    return ComponentStates.ON;
                }
                
                console.log(`⚫ OFF: ${voltage}V < ${minVoltage}V`);
                return ComponentStates.OFF;
            }
            
            calculateTransformerState() {
                if (this.currentPower > this.specs.maxPower * 1.2) {
                    return ComponentStates.BROKEN;
                }
                if (this.currentPower > this.specs.maxPower) {
                    return ComponentStates.OVERLOADED;
                }
                return this.currentVoltage > 0 ? ComponentStates.ON : ComponentStates.OFF;
            }
            
            animateStateChange() {
                this.applyStateCSS();
                console.log(`${this.type} (${this.elementId}): ${this.state} (${this.currentVoltage}V, ${this.currentPower.toFixed(2)}W)`);
            }
            
            applyStateCSS() {
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                element.classList.remove('state-off', 'state-on', 'state-blinking', 'state-broken', 'state-overloaded');
                element.classList.add(`state-${this.state}`);
            }
            
            updateBlinkAnimation() {
                // Stoppe vorherige Blink-Animation
                if (this.blinkInterval) {
                    clearInterval(this.blinkInterval);
                    this.blinkInterval = null;
                }
                
                // Starte Blink-Animation nur bei BLINKING state
                if (this.state === ComponentStates.BLINKING) {
                    console.log(`🟠 Starte Blink-Animation für ${this.elementId}`);
                    this.blinkInterval = setInterval(() => {
                        this.blinkState = !this.blinkState;
                        console.log(`🔄 Blink ${this.elementId}: ${this.blinkState}`);
                        this.applyBlinkColors();
                    }, 500); // Blinkt alle 500ms wie im React-Code
                } else {
                    this.blinkState = true;
                    this.applyDynamicColors();
                }
            }
            
            applyBlinkColors() {
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                // Nur LEDs färben, nicht Trafos oder andere Komponenten
                if (this.specs.type !== 'load') return;
                
                const ledCenters = element.querySelectorAll('.cls-5, .led24-center');
                
                ledCenters.forEach((led, index) => {
                    const color = this.blinkState ? '#ffff00' : '#ddd';
                    const filter = this.blinkState ? this.getGlowEffect(this.state, true) : null;
                    
                    console.log(`🔄 Blink LED ${index}: ${color}, Filter: ${filter}`);
                    
                    led.style.setProperty('fill', color, 'important');
                    
                    if (filter) {
                        led.style.filter = filter;
                        led.setAttribute('filter', filter);
                    } else {
                        led.style.filter = '';
                        led.removeAttribute('filter');
                    }
                });
            }
            
            applyDynamicColors() {
                const element = document.getElementById(this.elementId);
                if (!element) {
                    console.log(`❌ Element nicht gefunden: ${this.elementId}`);
                    return;
                }
                
                // Nur LEDs färben, nicht Trafos oder andere Komponenten
                if (this.specs.type !== 'load') {
                    return;
                }
                
                console.log(`🎨 Setze LED State für ${this.elementId}: ${this.state}`);
                
                // Für statische States (nicht BLINKING) nur CSS-Klassen verwenden
                if (this.state !== ComponentStates.BLINKING) {
                    const ledCenters = element.querySelectorAll('.cls-5, .led24-center');
                    ledCenters.forEach((led, index) => {
                        const filter = this.getGlowEffect(this.state, true);
                        
                        if (filter) {
                            led.style.filter = filter;
                            led.setAttribute('filter', filter);
                        } else {
                            led.style.filter = '';
                            led.removeAttribute('filter');
                        }
                    });
                }
            }
            
            getLedColor(state, isBlinking) {
                switch (state) {
                    case ComponentStates.OFF:
                        return '#ddd'; // Grau (aus)
                    case ComponentStates.ON:
                        return '#ffff00'; // Gelb (an)
                    case ComponentStates.BLINKING:
                        return isBlinking ? '#ffff00' : '#ddd'; // Gelb blinkend
                    case ComponentStates.BROKEN:
                        return '#1a1a1a'; // Schwarz (kaputt)
                    case ComponentStates.OVERLOADED:
                        return '#e91e63'; // Pink (überlastet)
                    default:
                        return '#ddd';
                }
            }
            
            getGlowEffect(state, isBlinking) {
                if (state === ComponentStates.OFF) return null;
                if (state === ComponentStates.BROKEN) return null;
                if (state === ComponentStates.BLINKING && !isBlinking) return null;
                
                // Verwende die passenden Filter IDs basierend auf LED-Typ
                const filterId = this.type.includes('24v') ? 'ledGlow24' : 'ledGlow';
                const strongFilterId = this.type.includes('24v') ? 'ledGlowStrong24' : 'ledGlowStrong';
                
                return state === ComponentStates.BLINKING ? `url(#${strongFilterId})` : `url(#${filterId})`;
            }
            
            updateSmokeAnimation() {
                console.log(`🔧 updateSmokeAnimation: State=${this.state}, BROKEN=${ComponentStates.BROKEN}`);
                if (this.state === ComponentStates.BROKEN) {
                    console.log(`💨 State ist BROKEN - Erstelle Rauch-Effekte`);
                    this.createSmokeEffects();
                } else {
                    console.log(`🧹 State ist nicht BROKEN - Entferne Rauch-Effekte`);
                    this.removeSmokeEffects();
                }
            }
            
            createSmokeEffects() {
                const element = document.getElementById(this.elementId);
                console.log(`🔍 createSmokeEffects: Element=${!!element}, Type=${this.specs.type}`);
                if (!element || this.specs.type !== 'load') {
                    console.log(`❌ Rauch-Erstellung abgebrochen: Element=${!!element}, Type=${this.specs.type}`);
                    return;
                }
                
                const ledCenters = element.querySelectorAll('.cls-5, .led24-center');
                console.log(`🔍 LED-Centers gefunden: ${ledCenters.length}`);
                
                ledCenters.forEach((led, index) => {
                    if (this.smokeElements[index]) {
                        console.log(`⚠️ Rauch bereits vorhanden für LED ${index}`);
                        return; // Rauch bereits vorhanden
                    }
                    
                    const ledRect = led.getBoundingClientRect();
                    const elementRect = element.getBoundingClientRect();
                    
                    const relativeX = ledRect.left - elementRect.left + ledRect.width / 2;
                    const relativeY = ledRect.top - elementRect.top + ledRect.height / 2;
                    
                    console.log(`📍 LED ${index} Position: (${relativeX}, ${relativeY})`);
                    
                    const smokeContainer = this.createSmokeElement(relativeX, relativeY);
                    element.appendChild(smokeContainer);
                    this.smokeElements[index] = smokeContainer;
                    
                    console.log(`💨 Rauch-Effekt erstellt für LED ${index} bei (${relativeX}, ${relativeY})`);
                });
            }
            
            createSmokeElement(centerX, centerY) {
                const smokeContainer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                smokeContainer.setAttribute('class', 'smoke-container');
                smokeContainer.style.position = 'absolute';
                smokeContainer.style.pointerEvents = 'none';
                smokeContainer.style.zIndex = '10';
                
                smokeContainer.innerHTML = `
                    <g style="transform: translate(${centerX}px, ${centerY}px)">
                        <!-- Erste Rauchserie -->
                        <g class="smoke-group">
                            <svg x="0" y="-18" width="5.34" height="13.79" viewBox="0 0 5.34 13.79" class="smoke smoke-1" style="transform: translateX(-2.67px)">
                                                                 <path fill="#333" opacity="0.8" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>
                        
                        <g class="smoke-group">
                            <svg x="0" y="-16" width="4.5" height="12" viewBox="0 0 5.34 13.79" class="smoke smoke-2" style="transform: translateX(-2.2px)">
                                                                 <path fill="#444" opacity="0.6" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>
                        
                        <g class="smoke-group">
                            <svg x="0" y="-14" width="3.6" height="10" viewBox="0 0 5.34 13.79" class="smoke smoke-3" style="transform: translateX(-1.8px)">
                                                                 <path fill="#555" opacity="0.4" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>

                        <!-- Zweite Rauchserie - gespiegelt -->
                        <g class="smoke-group-alt">
                            <svg x="0" y="-18" width="5.34" height="13.79" viewBox="0 0 5.34 13.79" class="smoke smoke-alt-1" style="transform: translateX(-2.67px) scaleX(-1)">
                                                                 <path fill="#222" opacity="0.7" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>
                        
                        <g class="smoke-group-alt">
                            <svg x="0" y="-16" width="4.8" height="12.5" viewBox="0 0 5.34 13.79" class="smoke smoke-alt-2" style="transform: translateX(-2.4px) scaleX(-1)">
                                                                 <path fill="#333" opacity="0.5" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>
                        
                        <g class="smoke-group-alt">
                            <svg x="0" y="-15" width="4.0" height="11" viewBox="0 0 5.34 13.79" class="smoke smoke-alt-3" style="transform: translateX(-2.0px) scaleX(-1)">
                                                                 <path fill="#444" opacity="0.3" d="M2.3,13.79C.19,11.79-.12,10.37.03,9.41c.31-1.95,2.6-2.42,3.65-4.96.67-1.63.5-3.27.22-4.45,1.64,2.73,1.6,4.54,1.24,5.69-.51,1.64-1.76,2.25-2.48,4.45-.48,1.45-.45,2.77-.36,3.65Z"/>
                            </svg>
                        </g>
                    </g>
                `;
                
                return smokeContainer;
            }
            
            removeSmokeEffects() {
                this.smokeElements.forEach(smokeElement => {
                    if (smokeElement && smokeElement.parentNode) {
                        smokeElement.parentNode.removeChild(smokeElement);
                    }
                });
                this.smokeElements = [];
            }
        }

        // ===== CIRCUIT GRAPH =====
        class CircuitGraph {
            constructor() {
                this.nodes = new Map();
                this.edges = new Map();
                this.stateMachines = new Map();
            }
            
            addComponent(id, type, position) {
                this.nodes.set(id, {
                    id: id,
                    type: type,
                    position: position,
                    connections: new Set()
                });
                
                this.stateMachines.set(id, new ComponentStateMachine(type, id));
                
                console.log(`Bauteil hinzugefügt: ${type} (${id})`);
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.edges.set(id, {
                    from: fromComponent,
                    to: toComponent
                });
                
                if (this.nodes.has(fromComponent)) {
                    this.nodes.get(fromComponent).connections.add(toComponent);
                }
                if (this.nodes.has(toComponent)) {
                    this.nodes.get(toComponent).connections.add(fromComponent);
                }
                
                console.log(`Verbindung erstellt: ${fromComponent} → ${toComponent}`);
            }
            
            findPath(startNode, endNode, visited = new Set()) {
                if (startNode === endNode) return [startNode];
                if (visited.has(startNode)) return null;
                
                visited.add(startNode);
                
                const component = this.nodes.get(startNode);
                if (!component) return null;
                
                for (const neighbor of component.connections) {
                    const path = this.findPath(neighbor, endNode, new Set(visited));
                    if (path) {
                        return [startNode, ...path];
                    }
                }
                
                return null;
            }
            
            getConnectedComponents(startNode) {
                const visited = new Set();
                const connected = [];
                
                const dfs = (nodeId) => {
                    if (visited.has(nodeId)) return;
                    visited.add(nodeId);
                    connected.push(nodeId);
                    
                    const component = this.nodes.get(nodeId);
                    if (component) {
                        for (const neighbor of component.connections) {
                            dfs(neighbor);
                        }
                    }
                };
                
                dfs(startNode);
                return connected;
            }
        }

        // ===== PHYSICS ENGINE =====
        class PhysicsEngine {
            constructor(graph) {
                this.graph = graph;
            }
            
            calculateCircuit() {
                if (!systemPower) {
                    this.powerOffAllComponents();
                    return;
                }
                
                const powerSource = this.findPowerSource();
                if (!powerSource) {
                    console.log('❌ Keine Stromquelle gefunden');
                    return;
                }
                
                const connectedComponents = this.graph.getConnectedComponents(powerSource);
                
                this.calculateVoltagesAndCurrents(connectedComponents);
            }
            
            findPowerSource() {
                for (const [id, component] of this.graph.nodes) {
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        return id;
                    }
                }
                return null;
            }
            
            calculateVoltagesAndCurrents(components) {
                for (const componentId of components) {
                    const component = this.graph.nodes.get(componentId);
                    const stateMachine = this.graph.stateMachines.get(componentId);
                    
                    if (!component || !stateMachine) continue;
                    
                    let voltage = 0;
                    let current = 0;
                    
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        voltage = ComponentSpecs[component.type].voltage;
                        current = this.calculateSourceCurrent(componentId);
                    } else if (ComponentSpecs[component.type].type === 'transformer') {
                        voltage = ComponentSpecs[component.type].inputVoltage;
                        current = this.calculateTransformerCurrent(componentId);
                    } else {
                        const result = this.calculateComponentPower(componentId);
                        voltage = result.voltage;
                        current = result.current;
                    }
                    
                    stateMachine.updateState(voltage, current);
                }
            }
            
            calculateComponentPower(componentId) {
                const component = this.graph.nodes.get(componentId);
                
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (connectedComponent && ComponentSpecs[connectedComponent.type].type === 'transformer') {
                        const specs = ComponentSpecs[connectedComponent.type];
                        return {
                            voltage: specs.outputVoltage,
                            current: ComponentSpecs[component.type].power / specs.outputVoltage
                        };
                    }
                }
                
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (connectedComponent && connectedComponent.type === ComponentTypes.POWER_SOURCE) {
                        return {
                            voltage: ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage,
                            current: ComponentSpecs[component.type].power / ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage
                        };
                    }
                }
                
                return { voltage: 0, current: 0 };
            }
            
            calculateSourceCurrent(sourceId) {
                let totalCurrent = 0;
                const connectedComponents = this.graph.getConnectedComponents(sourceId);
                
                for (const componentId of connectedComponents) {
                    const component = this.graph.nodes.get(componentId);
                    if (component && ComponentSpecs[component.type].type === 'load') {
                        const specs = ComponentSpecs[component.type];
                        totalCurrent += specs.power / ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage;
                    }
                }
                
                return totalCurrent;
            }
            
            calculateTransformerCurrent(transformerId) {
                const transformer = this.graph.nodes.get(transformerId);
                const specs = ComponentSpecs[transformer.type];
                let outputPower = 0;
                
                // Berechne die gesamte Last auf der Ausgangsseite
                for (const connectedId of transformer.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (connectedComponent && ComponentSpecs[connectedComponent.type].type === 'load') {
                        outputPower += ComponentSpecs[connectedComponent.type].power;
                    }
                }
                
                // Eingangsstrom = Ausgangsstrom / Effizienz
                const efficiency = 0.87; // 87% Effizienz für Trafos
                const inputCurrent = (outputPower / efficiency) / specs.inputVoltage;
                
                return inputCurrent;
            }
            
            powerOffAllComponents() {
                for (const [id, stateMachine] of this.graph.stateMachines) {
                    stateMachine.updateState(0, 0);
                }
            }
        }

        // ===== REALTIME SIMULATION =====
        class RealtimeSimulation {
            constructor() {
                this.graph = new CircuitGraph();
                this.physics = new PhysicsEngine(this.graph);
                this.isRunning = false;
            }
            
            start() {
                this.isRunning = true;
                console.log('🔄 Echtzeit-Simulation gestartet');
            }
            
            stop() {
                this.isRunning = false;
                console.log('⏸️ Echtzeit-Simulation gestoppt');
            }
            
            update() {
                if (!this.isRunning) return;
                this.physics.calculateCircuit();
            }
            
            addComponent(id, type, position) {
                this.graph.addComponent(id, type, position);
                this.update();
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.graph.addConnection(id, fromComponent, toComponent);
                this.update();
            }
            
            powerStateChanged() {
                console.log(`⚡ Hauptschalter: ${systemPower ? 'EIN' : 'AUS'}`);
                this.update();
            }
        }

        // Export für globalen Zugriff
        let circuit = null;

        console.log('🔬 Circuit Simulation Engine geladen');

        // ===== COMPONENT LIBRARY =====

        // Datenblatt-Informationen für Bauteile
        const DatasheetInfo = {
            'fi-schalter': {
                name: 'FI-Schutzschalter',
                specs: 'Nennstrom: 16A<br>Auslösestrom: 30mA<br>Schutzart: IP20<br>Einbauart: Hutschiene',
                description: 'Schutz vor Fehlerstrom durch defekte Geräte oder Berührung spannungsführender Teile.'
            },
            'ls-schalter': {
                name: 'LS-Schalter',
                specs: 'Nennstrom: 16A<br>Charakteristik: B<br>Auslösezeit: < 0,1s<br>Schutzart: IP20',
                description: 'Schutz vor Überlast und Kurzschluss in elektrischen Anlagen.'
            },
            'trafo-12v-40w': {
                name: 'Trafo 12V',
                specs: 'Eingang: 230V AC<br>Ausgang: 12V DC<br>Leistung: 40W<br>Wirkungsgrad: >85%',
                description: 'Elektronischer Transformator für LED-Beleuchtung mit 12V Ausgangsspannung.'
            },
            'trafo-24v-60w': {
                name: 'Trafo 24V',
                specs: 'Eingang: 230V AC<br>Ausgang: 24V DC<br>Leistung: 60W<br>Wirkungsgrad: >85%',
                description: 'Elektronischer Transformator für LED-Beleuchtung mit 24V Ausgangsspannung.'
            },
            'led-12v-1.2w': {
                name: 'LED-Modul 12V-1,2W-WW',
                specs: 'Spannung: 12V DC<br>Leistung: 1,2W<br>Lichtstrom: 120lm<br>Farbtemperatur: 3000K',
                description: 'Kompaktes LED-Modul mit drei LEDs für Niedervolt-Beleuchtungsanlagen.'
            },
            'led-12v-3.5w': {
                name: 'LED-Modul 12V',
                specs: 'Spannung: 12V DC<br>Leistung: 3,5W<br>Lichtstrom: 350lm<br>Farbtemperatur: 3000K',
                description: 'Warmweißes LED-Modul für Niedervolt-Beleuchtungsanlagen.'
            },
            'led-24v-5w': {
                name: 'LED-Modul 24V',
                specs: 'Spannung: 24V DC<br>Leistung: 5W<br>Lichtstrom: 500lm<br>Farbtemperatur: 3000K',
                description: 'Warmweißes LED-Modul für Niedervolt-Beleuchtungsanlagen.'
            },
            'zeitschaltuhr': {
                name: 'Zeitschaltuhr',
                specs: 'Spannung: 230V AC<br>Schaltleistung: 16A<br>Programme: 20<br>Gangreserve: 100h',
                description: 'Digitale Zeitschaltuhr für automatische Schaltung von Beleuchtung.'
            },
            'daemmerungsschalter': {
                name: 'Dämmerungsschalter',
                specs: 'Spannung: 230V AC<br>Schaltleistung: 10A<br>Einstellbereich: 2-200 Lux<br>Verzögerung: 30s',
                description: 'Automatischer Schalter basierend auf Umgebungshelligkeit.'
            }
        };

        console.log('📦 Component Library geladen');

        // ===== WORKSPACE MANAGER =====

        class WorkspaceManager {
            constructor() {
                this.setupEventDelegation();
                this.selectedComponents = new Set();
                this.isDraggingComponents = false;
                this.dragStartPos = null;
                this.componentStartPositions = new Map();
                this.componentRotations = new Map();
                this.isDrawingSelection = false;
                this.selectionStart = null;
                this.selectionRectangle = null;
                this.justFinishedRectangleSelection = false;
                
                // Connection System
                this.activeConnection = null;
                this.tempConnectionLine = null;
                this.connections = new Map();
                
                console.log('🎯 WorkspaceManager initialisiert');
            }
            
            setupEventDelegation() {
                const workspace = document.getElementById('workspace');
                
                workspace.addEventListener('mousedown', this.handleMouseDown.bind(this));
                workspace.addEventListener('mousemove', this.handleMouseMove.bind(this));
                workspace.addEventListener('mouseup', this.handleMouseUp.bind(this));
                workspace.addEventListener('click', this.handleClick.bind(this));
                workspace.addEventListener('dblclick', this.handleDblClick.bind(this));
                
                this.setupKeyboardEvents();
                
                console.log('✅ Event-Delegierung eingerichtet');
            }
            
            setupKeyboardEvents() {
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                
                const workspace = document.getElementById('workspace');
                workspace.setAttribute('tabindex', '0');
                workspace.style.outline = 'none';
                
                workspace.addEventListener('mousedown', () => {
                    workspace.focus();
                });
                
                console.log('⌨️ Keyboard Events eingerichtet');
            }
            
            isComponent(element) {
                const component = element.classList.contains('component') || 
                                element.closest('.component');
                
                if (component && component.id === 'power-source-svg') {
                    return false;
                }
                
                return !!component;
            }
            
            getComponent(element) {
                const component = element.classList.contains('component') ? 
                                element : element.closest('.component');
                
                if (component && component.id === 'power-source-svg') {
                    return null;
                }
                
                return component;
            }
            
            // ===== MOUSE EVENT HANDLERS =====
            handleMouseDown(e) {
                if (this.isConnectionPoint(e.target)) {
                    this.handleConnectionMouseDown(e);
                    return;
                }
                
                const component = this.getComponent(e.target);
                
                if (component) {
                    console.log('🖱️ MouseDown auf Bauteil:', component.dataset.componentType);
                    
                    if (!this.selectedComponents.has(component)) {
                        if (!e.ctrlKey) {
                            this.selectSingle(component);
                        } else {
                            this.toggleSelection(component);
                        }
                    }
                    
                    this.startDragging(e);
                    e.preventDefault();
                } else {
                    console.log('🖱️ MouseDown auf leere Fläche');
                    this.startRectangleSelection(e);
                }
            }
            
            handleMouseMove(e) {
                if (this.activeConnection) {
                    this.updateConnectionLine(e);
                    return;
                }
                
                if (this.isDraggingComponents) {
                    this.updateDragging(e);
                } else if (this.isDrawingSelection) {
                    this.updateRectangleSelection(e);
                }
            }
            
            handleMouseUp(e) {
                if (this.activeConnection) {
                    this.handleConnectionMouseUp(e);
                    return;
                }
                
                if (this.isDraggingComponents) {
                    this.endDragging(e);
                } else if (this.isDrawingSelection) {
                    this.endRectangleSelection(e);
                }
            }
            
            handleClick(e) {
                if (this.justFinishedRectangleSelection) {
                    this.justFinishedRectangleSelection = false;
                    console.log('🚫 Click nach Rectangle Selection ignoriert');
                    return;
                }
                
                if (this.isDraggingComponents) return;
                
                const component = this.getComponent(e.target);
                
                if (component) {
                    if (e.ctrlKey) {
                        console.log('🎯 Strg+Klick - Multi-Select auf:', component.dataset.componentType);
                        this.toggleSelection(component);
                    } else {
                        console.log('🎯 Klick - Single-Select auf:', component.dataset.componentType);
                        this.selectSingle(component);
                    }
                } else {
                    console.log('🎯 Klick auf leere Fläche - Auswahl löschen');
                    this.clearSelection();
                }
            }
            
            handleDblClick(e) {
                const component = this.getComponent(e.target);
                if (component) {
                    console.log('🔄 Doppelklick - Drehe Bauteil:', component.dataset.componentType);
                    this.rotateComponent(component);
                    e.preventDefault();
                }
            }
            
            handleKeyDown(e) {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    console.log('🗑️ Delete/Backspace-Taste - Lösche ausgewählte Bauteile');
                    this.deleteSelectedComponents();
                    e.preventDefault();
                } else if (e.key === 'Escape') {
                    console.log('🚫 Escape - Alle Auswahlen aufheben');
                    this.clearSelection();
                }
            }
            
            // ===== DRAG & DROP SYSTEM =====
            startDragging(e) {
                this.isDraggingComponents = true;
                this.dragStartPos = { x: e.clientX, y: e.clientY };
                
                this.componentStartPositions.clear();
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                
                this.selectedComponents.forEach(component => {
                    const currentLeft = parseFloat(component.style.left) || 0;
                    const currentTop = parseFloat(component.style.top) || 0;
                    
                    const mouseX = e.clientX - workspaceRect.left;
                    const mouseY = e.clientY - workspaceRect.top;
                    const mouseOffsetX = mouseX - currentLeft;
                    const mouseOffsetY = mouseY - currentTop;
                    
                    this.componentStartPositions.set(component, {
                        x: currentLeft,
                        y: currentTop,
                        mouseOffsetX: mouseOffsetX,
                        mouseOffsetY: mouseOffsetY
                    });
                    
                    component.classList.add('dragging');
                });
                
                console.log('🚀 Drag gestartet für', this.selectedComponents.size, 'Bauteile');
            }
            
            updateDragging(e) {
                if (!this.isDraggingComponents) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = e.clientX - workspaceRect.left;
                const mouseY = e.clientY - workspaceRect.top;
                
                this.selectedComponents.forEach((component) => {
                    const startData = this.componentStartPositions.get(component);
                    if (startData) {
                        const newLeft = mouseX - startData.mouseOffsetX;
                        const newTop = mouseY - startData.mouseOffsetY;
                        
                        component.style.left = newLeft + 'px';
                        component.style.top = newTop + 'px';
                        
                        try {
                            this.updateConnectionsForComponent(component);
                        } catch (error) {
                            console.log('⚠️ Fehler beim Connection-Update:', error.message);
                        }
                    }
                });
            }
            
            endDragging(e) {
                this.isDraggingComponents = false;
                this.dragStartPos = null;
                this.componentStartPositions.clear();
                
                this.selectedComponents.forEach(component => {
                    component.classList.remove('dragging');
                });
                
                console.log('🎯 Drag beendet');
            }
            
            // ===== SELECTION SYSTEM =====
            selectSingle(component) {
                this.clearSelection();
                this.selectedComponents.add(component);
                component.classList.add('selected');
                console.log('✅ Ausgewählt:', component.id);
            }
            
            toggleSelection(component) {
                if (this.selectedComponents.has(component)) {
                    this.selectedComponents.delete(component);
                    component.classList.remove('selected');
                    console.log('➖ Abgewählt:', component.id);
                } else {
                    this.selectedComponents.add(component);
                    component.classList.add('selected');
                    console.log('➕ Hinzugefügt:', component.id);
                }
            }
            
            clearSelection() {
                this.selectedComponents.forEach(component => {
                    component.classList.remove('selected');
                });
                this.selectedComponents.clear();
                console.log('🧹 Auswahl geleert');
            }
            
            // ===== ROTATION SYSTEM =====
            rotateComponent(component) {
                let currentRotation = this.componentRotations.get(component) || 0;
                currentRotation = (currentRotation + 90) % 360;
                this.componentRotations.set(component, currentRotation);
                component.style.transform = `rotate(${currentRotation}deg)`;
                
                // Verbindungen sofort nach Rotation aktualisieren
                this.updateConnectionsForComponent(component);
                
                console.log(`🔄 Bauteil ${component.id} gedreht auf ${currentRotation}°`);
            }
            
            // ===== DELETION SYSTEM =====
            deleteSelectedComponents() {
                if (this.selectedComponents.size === 0) {
                    console.log('⚠️ Keine Bauteile zum Löschen ausgewählt');
                    return;
                }
                
                const deletedComponents = [];
                
                this.selectedComponents.forEach(component => {
                    const componentId = component.id;
                    const componentType = component.dataset.componentType;
                    
                    component.remove();
                    this.componentRotations.delete(component);
                    
                    if (circuit && circuit.graph && circuit.graph.nodes.has(componentId)) {
                        circuit.graph.nodes.delete(componentId);
                        circuit.graph.stateMachines.delete(componentId);
                    }
                    
                    deletedComponents.push(`${componentType} (${componentId})`);
                });
                
                this.selectedComponents.clear();
                console.log(`🗑️ ${deletedComponents.length} Bauteile gelöscht:`, deletedComponents);
            }
            
            // ===== RECTANGLE SELECTION SYSTEM =====
            startRectangleSelection(e) {
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                
                this.isDrawingSelection = true;
                this.selectionStart = {
                    x: e.clientX - workspaceRect.left,
                    y: e.clientY - workspaceRect.top
                };
                
                if (!e.ctrlKey) {
                    this.clearSelection();
                }
                
                this.createSelectionRectangle();
                console.log('📐 Rectangle Selection gestartet');
                e.preventDefault();
            }
            
            createSelectionRectangle() {
                this.selectionRectangle = document.createElement('div');
                this.selectionRectangle.className = 'selection-rectangle';
                this.selectionRectangle.style.position = 'absolute';
                this.selectionRectangle.style.border = '2px dashed #4CAF50';
                this.selectionRectangle.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                this.selectionRectangle.style.pointerEvents = 'none';
                this.selectionRectangle.style.zIndex = '999';
                
                document.getElementById('workspace').appendChild(this.selectionRectangle);
            }
            
            updateRectangleSelection(e) {
                if (!this.isDrawingSelection || !this.selectionRectangle) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const currentX = e.clientX - workspaceRect.left;
                const currentY = e.clientY - workspaceRect.top;
                
                const left = Math.min(this.selectionStart.x, currentX);
                const top = Math.min(this.selectionStart.y, currentY);
                const width = Math.abs(currentX - this.selectionStart.x);
                const height = Math.abs(currentY - this.selectionStart.y);
                
                this.selectionRectangle.style.left = left + 'px';
                this.selectionRectangle.style.top = top + 'px';
                this.selectionRectangle.style.width = width + 'px';
                this.selectionRectangle.style.height = height + 'px';
            }
            
            endRectangleSelection(e) {
                if (!this.isDrawingSelection) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const currentX = e.clientX - workspaceRect.left;
                const currentY = e.clientY - workspaceRect.top;
                
                const selectionRect = {
                    left: Math.min(this.selectionStart.x, currentX),
                    top: Math.min(this.selectionStart.y, currentY),
                    right: Math.max(this.selectionStart.x, currentX),
                    bottom: Math.max(this.selectionStart.y, currentY)
                };
                
                const components = document.querySelectorAll('.component:not(#power-source-svg)');
                let selectedCount = 0;
                
                components.forEach(component => {
                    const left = parseInt(component.style.left) || 0;
                    const top = parseInt(component.style.top) || 0;
                    const width = component.offsetWidth;
                    const height = component.offsetHeight;
                    
                    const componentRect = {
                        left: left,
                        top: top,
                        right: left + width,
                        bottom: top + height
                    };
                    
                    if (selectionRect.left < componentRect.right &&
                        selectionRect.right > componentRect.left &&
                        selectionRect.top < componentRect.bottom &&
                        selectionRect.bottom > componentRect.top) {
                        
                        this.selectedComponents.add(component);
                        component.classList.add('selected');
                        selectedCount++;
                    }
                });
                
                this.isDrawingSelection = false;
                this.selectionStart = null;
                this.justFinishedRectangleSelection = true;
                
                if (this.selectionRectangle) {
                    this.selectionRectangle.remove();
                    this.selectionRectangle = null;
                }
                
                console.log(`📐 Rectangle Selection beendet: ${selectedCount} Bauteile ausgewählt`);
            }
            
            // ===== CONNECTION SYSTEM =====
            isConnectionPoint(element) {
                return element.classList.contains('connection-line') || 
                       element.classList.contains('connection-socket') ||
                       element.classList.contains('connection-area');
            }
            
            handleConnectionMouseDown(e) {
                if (e.target.classList.contains('connection-line') && 
                    e.target.dataset.connectionType === 'output-line') {
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.startConnection(e.target, e);
                }
            }
            
            startConnection(outputLine, event) {
                const componentElement = outputLine.closest('.component');
                const componentId = componentElement ? componentElement.id : 'power-source-svg';
                
                this.activeConnection = {
                    outputLine: outputLine,
                    componentId: componentId,
                    outputData: this.getConnectionData(outputLine),
                    startPos: this.getConnectionPosition(outputLine, componentElement)
                };
                
                this.createTempConnectionLine(event);
                
                console.log('🚀 Verbindung gestartet:', this.activeConnection.outputData);
            }
            
            createTempConnectionLine(event) {
                const svg = document.getElementById('connectionSvg');
                this.tempConnectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                
                this.tempConnectionLine.setAttribute('class', 'temp-connection');
                this.tempConnectionLine.setAttribute('stroke', this.getWireColor(this.activeConnection.outputData.wireType));
                this.tempConnectionLine.setAttribute('stroke-width', '3');
                this.tempConnectionLine.setAttribute('stroke-dasharray', '5,5');
                this.tempConnectionLine.setAttribute('opacity', '0.8');
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = event.clientX - workspaceRect.left;
                const mouseY = event.clientY - workspaceRect.top;
                
                this.tempConnectionLine.setAttribute('x1', this.activeConnection.startPos.x);
                this.tempConnectionLine.setAttribute('y1', this.activeConnection.startPos.y);
                this.tempConnectionLine.setAttribute('x2', mouseX);
                this.tempConnectionLine.setAttribute('y2', mouseY);
                
                svg.appendChild(this.tempConnectionLine);
            }
            
            updateConnectionLine(e) {
                if (!this.tempConnectionLine) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = e.clientX - workspaceRect.left;
                const mouseY = e.clientY - workspaceRect.top;
                
                this.tempConnectionLine.setAttribute('x2', mouseX);
                this.tempConnectionLine.setAttribute('y2', mouseY);
            }
            
            handleConnectionMouseUp(e) {
                if (e.target.classList.contains('connection-socket') && 
                    e.target.dataset.connectionType === 'input-socket') {
                    
                    this.completeConnection(e.target);
                } else {
                    this.cancelConnection();
                }
            }
            
            completeConnection(inputSocket) {
                const targetComponent = inputSocket.closest('.component');
                const targetComponentId = targetComponent ? targetComponent.id : 'unknown';
                const inputData = this.getConnectionData(inputSocket);
                
                console.log('✅ Verbindung erfolgreich:', 
                    `${this.activeConnection.componentId}.${this.activeConnection.outputData.id}`, 
                    '→', 
                    `${targetComponentId}.${inputData.id}`);
                
                this.createBezierConnection(this.activeConnection.outputLine, inputSocket, targetComponent);
                this.cancelConnection();
            }
            
            createBezierConnection(outputLine, inputSocket, targetComponent) {
                const svg = document.getElementById('connectionSvg');
                const connectionId = `conn-${Date.now()}`;
                
                const startPos = this.getConnectionPosition(outputLine, outputLine.closest('.component'));
                const endPos = this.getConnectionPosition(inputSocket, targetComponent);
                
                // Dynamische Bezier-Berechnung mit Rotation
                const { cp1X, cp1Y, cp2X, cp2Y } = this.calculateRotatedBezierPoints(
                    startPos, endPos, outputLine, inputSocket, 
                    outputLine.closest('.component') || document.getElementById('power-source-svg'), 
                    targetComponent
                );
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M ${startPos.x},${startPos.y} C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${endPos.x},${endPos.y}`;
                
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'bezier-connection');
                path.setAttribute('stroke', this.getWireColor(this.activeConnection.outputData.wireType));
                path.setAttribute('stroke-width', '4');
                path.setAttribute('fill', 'none');
                path.setAttribute('id', connectionId);
                path.setAttribute('data-from-component', this.activeConnection.componentId);
                path.setAttribute('data-to-component', targetComponent ? targetComponent.id : 'unknown');
                path.setAttribute('data-from-connection', this.activeConnection.outputData.id);
                path.setAttribute('data-to-connection', this.getConnectionData(inputSocket).id);
                
                path.addEventListener('click', (e) => {
                    console.log('🔗 Click auf Verbindung:', connectionId);
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteConnection(path);
                });
                
                svg.appendChild(path);
                
                // Verbindung in der Physik-Engine registrieren
                if (circuit) {
                    circuit.addConnection(connectionId, 
                        this.activeConnection.componentId, 
                        targetComponent ? targetComponent.id : 'unknown'
                    );
                }
                
                this.connections.set(connectionId, {
                    path: path,
                    from: outputLine,
                    to: inputSocket,
                    fromComponent: this.activeConnection.componentId,
                    toComponent: targetComponent ? targetComponent.id : 'unknown'
                });
                
                // Connection Points als "connected" markieren
                outputLine.classList.add('connected');
                inputSocket.classList.add('connected');
                
                console.log('🔗 Bezier-Verbindung erstellt:', connectionId);
            }
            
            deleteConnection(path) {
                const connectionId = path.id;
                const connection = this.connections.get(connectionId);
                
                // Connection Points wieder als "available" markieren
                if (connection) {
                    connection.from.classList.remove('connected');
                    connection.to.classList.remove('connected');
                }
                
                path.remove();
                this.connections.delete(connectionId);
                console.log('🗑️ Verbindung gelöscht:', connectionId);
            }
            
            cancelConnection() {
                if (this.tempConnectionLine) {
                    this.tempConnectionLine.remove();
                    this.tempConnectionLine = null;
                }
                
                if (this.activeConnection) {
                    console.log('❌ Verbindung abgebrochen');
                    this.activeConnection = null;
                }
            }
            
            getConnectionData(element) {
                return {
                    id: element.dataset.connectionId,
                    type: element.dataset.connectionType,
                    wireType: element.dataset.wireType,
                    voltage: parseFloat(element.dataset.voltage)
                };
            }
            
            getConnectionPosition(element, component) {
                // Basis-Position aus data-Attributen lesen
                let x = parseFloat(element.dataset.bezierStartX) || parseFloat(element.dataset.bezierEndX) || 0;
                let y = parseFloat(element.dataset.bezierStartY) || parseFloat(element.dataset.bezierEndY) || 0;
                
                // Rotation anwenden falls Bauteil rotiert ist
                if (component && component.id !== 'power-source-svg') {
                    const rotation = this.componentRotations.get(component) || 0;
                    if (rotation !== 0) {
                        // SVG-Dimensionen dynamisch auslesen
                        const svg = component.querySelector('svg');
                        if (svg) {
                            const viewBox = svg.getAttribute('viewBox');
                            if (viewBox) {
                                const viewBoxValues = viewBox.split(' ');
                                const svgWidth = parseFloat(viewBoxValues[2]);
                                const svgHeight = parseFloat(viewBoxValues[3]);
                                
                                // Dynamisches Zentrum berechnen
                                const centerX = svgWidth / 2;
                                const centerY = svgHeight / 2;
                                
                                // Koordinaten relativ zum Zentrum machen
                                const relativeX = x - centerX;
                                const relativeY = y - centerY;
                                
                                // Rotieren um das Zentrum
                                const rad = (rotation * Math.PI) / 180;
                                const rotatedX = relativeX * Math.cos(rad) - relativeY * Math.sin(rad);
                                const rotatedY = relativeX * Math.sin(rad) + relativeY * Math.cos(rad);
                                
                                // Zurück zu absoluten Koordinaten
                                x = rotatedX + centerX;
                                y = rotatedY + centerY;
                            }
                        }
                    }
                }
                
                // Position relativ zur Component berechnen
                if (component) {
                    const left = parseFloat(component.style.left) || 0;
                    const top = parseFloat(component.style.top) || 0;
                    
                    return {
                        x: left + x,
                        y: top + y
                    };
                }
                
                return { x: x, y: y };
            }
            
            getWireColor(wireType) {
                const colors = {
                    'plus': '#e30613',
                    'minus': '#1d1d1b', 
                    'phase': '#683c11',
                    'neutral': '#1d71b8',
                    'earth': '#ffed00'
                };
                return colors[wireType] || '#666';
            }
            
            updateConnectionsForComponent(component) {
                const componentId = component.id;
                console.log('🔄 updateConnectionsForComponent aufgerufen für:', componentId);
                
                let foundConnections = 0;
                
                this.connections.forEach((connectionData, connectionId) => {
                    if (connectionData.fromComponent === componentId || 
                        connectionData.toComponent === componentId) {
                        
                        foundConnections++;
                        this.redrawConnection(connectionId, connectionData);
                    }
                });
                
                console.log(`📊 ${foundConnections} Verbindungen für ${componentId} aktualisiert`);
            }
            
            redrawConnection(connectionId, connectionData) {
                const path = connectionData.path;
                if (!path) return;
                
                const fromComponent = document.getElementById(connectionData.fromComponent);
                const toComponent = document.getElementById(connectionData.toComponent);
                
                if (!fromComponent || !toComponent) return;
                
                const startPos = this.getConnectionPosition(connectionData.from, fromComponent);
                const endPos = this.getConnectionPosition(connectionData.to, toComponent);
                
                // Dynamische Bezier-Berechnung mit Rotation
                const { cp1X, cp1Y, cp2X, cp2Y } = this.calculateRotatedBezierPoints(
                    startPos, endPos, connectionData.from, connectionData.to, fromComponent, toComponent
                );
                
                const pathData = `M ${startPos.x},${startPos.y} C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${endPos.x},${endPos.y}`;
                path.setAttribute('d', pathData);
                
                console.log('🔄 Verbindung aktualisiert:', connectionId);
            }
            
            calculateRotatedBezierPoints(startPos, endPos, fromElement, toElement, fromComponent, toComponent) {
                // Basis-Offset für Kontrollpunkte
                const baseOffset = 60;
                
                // Start-Kontrollpunkt
                let cp1X, cp1Y;
                const fromRotation = this.componentRotations.get(fromComponent) || 0;
                
                if (fromComponent.id === 'power-source-svg') {
                    // Stromquelle: statische Richtung nach unten
                    cp1X = startPos.x;
                    cp1Y = startPos.y + baseOffset;
                } else {
                    // Rotiertes Bauteil: Berechne Richtung basierend auf Rotation
                    const fromRad = (fromRotation * Math.PI) / 180;
                    const outputSide = fromElement.dataset.connectionId?.includes('out-') ? 'right' : 'left';
                    
                    if (outputSide === 'right') {
                        cp1X = startPos.x + baseOffset * Math.cos(fromRad);
                        cp1Y = startPos.y + baseOffset * Math.sin(fromRad);
                    } else {
                        const leftDirection = fromRad + Math.PI;
                        cp1X = startPos.x + baseOffset * Math.cos(leftDirection);
                        cp1Y = startPos.y + baseOffset * Math.sin(leftDirection);
                    }
                }
                
                // End-Kontrollpunkt
                let cp2X, cp2Y;
                const toRotation = this.componentRotations.get(toComponent) || 0;
                
                if (toComponent.id === 'power-source-svg') {
                    // Stromquelle: statische Richtung nach oben
                    cp2X = endPos.x;
                    cp2Y = endPos.y - baseOffset;
                } else {
                    // Rotiertes Bauteil: Berechne Richtung basierend auf Rotation
                    const toRad = (toRotation * Math.PI) / 180;
                    const inputSide = toElement.dataset.connectionId?.includes('in-') ? 'left' : 'right';
                    
                    if (inputSide === 'left') {
                        const leftDirection = toRad + Math.PI;
                        cp2X = endPos.x + (baseOffset * 0.5) * Math.cos(leftDirection);
                        cp2Y = endPos.y + (baseOffset * 0.5) * Math.sin(leftDirection);
                    } else {
                        cp2X = endPos.x + (baseOffset * 0.5) * Math.cos(toRad);
                        cp2Y = endPos.y + (baseOffset * 0.5) * Math.sin(toRad);
                    }
                }
                
                return { cp1X, cp1Y, cp2X, cp2Y };
            }
        }

        // ===== DRAG & DROP SYSTEM =====
        let isDragging = false;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };

        function initializeDragAndDrop() {
            const componentItems = document.querySelectorAll('.component-item');
            
            componentItems.forEach(item => {
                item.addEventListener('mousedown', startDrag);
            });
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
        }

        function startDrag(e) {
            e.preventDefault();
            
            const componentType = e.currentTarget.getAttribute('data-component-type');
            console.log('🎯 Drag gestartet für Typ:', componentType);
            
            const svg = createComponentSVG(componentType);
            
            if (!svg) {
                console.log('❌ Kein SVG für Typ erstellt:', componentType);
                return;
            }
            
            isDragging = true;
            
            dragElement = document.createElement('div');
            dragElement.className = 'dragging-component';
            dragElement.appendChild(svg);
            
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            updateDragPosition(e);
            document.body.appendChild(dragElement);
            
            console.log('✅ Drag-Element erstellt und hinzugefügt');
        }

        function handleDrag(e) {
            if (!isDragging || !dragElement) return;
            
            updateDragPosition(e);
        }

        function updateDragPosition(e) {
            if (!dragElement) return;
            
            dragElement.style.left = (e.clientX - dragOffset.x) + 'px';
            dragElement.style.top = (e.clientY - dragOffset.y) + 'px';
        }

        function endDrag(e) {
            if (!isDragging || !dragElement) return;
            
            const workspace = document.getElementById('workspace');
            const workspaceRect = workspace.getBoundingClientRect();
            
            if (e.clientX >= workspaceRect.left && 
                e.clientX <= workspaceRect.right && 
                e.clientY >= workspaceRect.top && 
                e.clientY <= workspaceRect.bottom) {
                
                const relativeX = e.clientX - workspaceRect.left;
                const relativeY = e.clientY - workspaceRect.top;
                
                placeComponent(relativeX, relativeY, dragElement.firstChild.getAttribute('data-component-type'));
                
                console.log('✅ Bauteil platziert bei:', relativeX, relativeY);
            }
            
            if (dragElement && dragElement.parentNode) {
                dragElement.parentNode.removeChild(dragElement);
            }
            
            isDragging = false;
            dragElement = null;
        }

        function placeComponent(x, y, componentType) {
            const workspace = document.getElementById('workspace');
            const svg = createComponentSVG(componentType);
            
            if (!svg) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'component placed-component';
            wrapper.style.position = 'absolute';
            wrapper.style.left = x + 'px';
            wrapper.style.top = y + 'px';
            wrapper.setAttribute('data-component-type', componentType);
            wrapper.setAttribute('id', 'component-' + Date.now());
            
            wrapper.appendChild(svg);
            workspace.appendChild(wrapper);
            
            if (circuit) {
                circuit.addComponent(wrapper.id, componentType, {x: x, y: y});
            }
        }

        // Connection Point Hover Effects
        function setupConnectionHoverEffects() {
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('connection-line') || 
                    e.target.classList.contains('connection-socket')) {
                    
                    const connectionData = {
                        type: e.target.dataset.connectionType,
                        id: e.target.dataset.connectionId,
                        wireType: e.target.dataset.wireType,
                        voltage: e.target.dataset.voltage
                    };
                    
                    console.log('🔌 Hover über Anschlusspunkt:', connectionData);
                }
            });
        }

        // Datasheet Hover
        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.component-item')) {
                const componentItem = e.target.closest('.component-item');
                const type = componentItem.getAttribute('data-component-type');
                showDatasheet(type);
            }
        });

        // Globale Instanz
        let workspaceManager = null;

        console.log('🎮 Workspace Manager geladen');

        // ===== HAUPTANWENDUNG =====

        // ===== GLOBALE FUNKTIONEN =====

        function openTaskMenu() {
            alert('Hier wird später das Aufgaben-Menü geöffnet.\n\nFunktionen:\n• Aufgaben-Übersicht\n• Schwierigkeitsgrade\n• Fortschritt anzeigen\n• Neue Aufgaben laden');
        }

        function toggleDatasheet() {
            const section = document.getElementById('datasheet-section');
            const toggle = document.getElementById('datasheet-toggle');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                toggle.textContent = '▼';
                toggle.title = 'Datenblatt ausklappen';
            } else {
                toggle.textContent = '▲';
                toggle.title = 'Datenblatt einklappen';
            }
        }

        function togglePower() {
            systemPower = !systemPower;
            const powerBtn = document.getElementById('powerBtn');
            
            if (systemPower) {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOn" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOn)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                  x="2.13" y=".91" width="17.49" height="20.74" transform="translate(22.15 .41) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                             points="5.22 8.66 5.22 17.05 16.38 17.05 16.38 8.66 18.52 8.66 18.52 .5 3.22 .5 3.22 8.66 5.22 8.66"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="16.63" y1="2.78" x2="5.5" y2="2.78"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="16.63" y1="4.46" x2="5.5" y2="4.46"/>
                                </g>
                                <rect fill="var(--color-error)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="5.21" y="9.83" width="11.18" height="4.98" transform="translate(21.59 24.63) rotate(180)"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(7.47 13.58)">
                                    <tspan x="0" y="0">I</tspan>
                                    <tspan x=".99" y="0">-</tspan>
                                    <tspan x="2.34" y="0">on</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            } else {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                  x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                             points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                </g>
                                <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="5.36" y="7.68" width="11.18" height="4.98"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(6.36 11.7)">
                                    <tspan x="0" y="0">O</tspan>
                                    <tspan x="2.92" y="0">-</tspan>
                                    <tspan x="4.27" y="0">off</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            }
            
            if (circuit) {
                circuit.powerStateChanged();
            }
        }

        function clearWorkspace() {
            const workspace = document.getElementById('workspace');
            const powerSource = workspace.querySelector('.power-source');
            const svg = workspace.querySelector('#connectionSvg');
            const infoBtn = workspace.querySelector('.workspace-info-btn');
            const infoTooltip = workspace.querySelector('.info-tooltip');
            
            Array.from(workspace.children).forEach(child => {
                if (child !== powerSource && child !== svg && child !== infoBtn && child !== infoTooltip) {
                    child.remove();
                }
            });
            
            // Verbindungen in WorkspaceManager löschen
            if (workspaceManager) {
                workspaceManager.connections.clear();
            }
            
            // Globale Arrays leeren
            connections = [];
            components = [];
            
            // Circuit-Graph zurücksetzen
            if (circuit) {
                circuit.graph.nodes.clear();
                circuit.graph.edges.clear();
                circuit.graph.stateMachines.clear();
                
                // Stromquelle wieder hinzufügen
                circuit.addComponent('power-source-svg', ComponentTypes.POWER_SOURCE, {x: 20, y: 20});
            }
            
            console.log('🧹 Arbeitsfläche geleert');
        }

        function resetConnections() {
            const svg = document.getElementById('connectionSvg');
            svg.innerHTML = '';
            
            // Verbindungen in WorkspaceManager löschen
            if (workspaceManager) {
                workspaceManager.connections.clear();
            }
            
            connections = [];
            
            // Circuit-Graph Verbindungen zurücksetzen
            if (circuit) {
                circuit.graph.edges.clear();
                
                // Alle Komponenten-Verbindungen löschen
                circuit.graph.nodes.forEach(node => {
                    node.connections.clear();
                });
            }
            
            console.log('🔗 Alle Verbindungen zurückgesetzt');
        }

        // ===== SVG FACTORY =====
        function createComponentSVG(componentType) {
            switch(componentType) {
                case 'led-12v-1.2w':
                    return createLEDModuleSVG();
                case 'trafo-12v-40w':
                    return createTransformer12VSVG();
                case 'trafo-24v-60w':
                    return createTransformer24VSVG();
                case 'fi-schalter':
                    return createFISwitchSVG();
                case 'ls-schalter':
                    return createLSSwitchSVG();
                case 'zeitschaltuhr':
                    return createTimerSwitchSVG();
                case 'daemmerungsschalter':
                    return createDuskSwitchSVG();
                case 'led-24v-5w':
                    return createLED24VSVG();
                default:
                    console.log('⚠️ Unbekannter Komponententyp:', componentType);
                    return null;
            }
        }

        // ===== LED-MODUL 12V 1,2W =====
        function createLEDModuleSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 133.29 27.54');
            svg.setAttribute('class', 'led-module-svg');
            svg.setAttribute('data-component-type', 'led-12v-1.2w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-plus", "to":"out-plus", "resistance":0.1},
                {"from":"in-minus", "to":"out-minus", "resistance":0.1}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-plus", "in-minus"],
                "power": 1.2,
                "voltage": 12,
                "type": "led"
            }));
            
            svg.innerHTML = `
                <defs>
                    <style>
                        .cls-1 { fill: #9e9e9e; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-2 { fill: #e8e8e8; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-5 { fill: #fff; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-7 { fill: #1d1d1b; font-family: Arial, sans-serif; font-size: 7.77px; }
                    </style>
                    
                    <!-- Glow-Filter für LEDs -->
                    <filter id="ledGlow" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="0.8" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <filter id="ledGlowStrong" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="1.0" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <g>
                    <!-- Anschlusskabel Links -->
                    <line stroke="#1d1d1b" stroke-width="4" x1="8" y1="9.225" x2="16.53" y2="9.225"/>
                    <line stroke="#e30613" stroke-width="4" x1="8" y1="18.315" x2="16.53" y2="18.315"/>
            
                    <g>
                        <rect class="cls-2" x="16.605" y=".75" width="100.14" height="26.04" rx="8.475" ry="8.475"/>
                        <g>
                            <circle class="cls-1" cx="90.18" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="90.18" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="44.73" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="44.73" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="67.455" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="67.455" cy="13.77" r="4.125"/>
                        </g>
                        <text class="cls-7" transform="translate(101.34 5.01) rotate(90)">
                            <tspan x="0" y="0">1,2 W</tspan>
                        </text>
                        <text class="cls-7" transform="translate(24.84 20.61) rotate(-90)">
                            <tspan x="0" y="0">12 V</tspan>
                            <tspan x=".195" y="9.315">WW</tspan>
                        </text>
                        <text class="cls-7" transform="translate(113.82 17.01) rotate(-180)">+</text>
                        <text class="cls-7" transform="translate(112.68 5.685) rotate(-180)">-</text>
                    </g>
                </g>
                
                <!-- Connection Points Links (Eingangsbuchsen) -->
                <circle class="connection-socket" 
                        cx="8" cy="9.225" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-minus"
                        data-wire-type="minus"
                        data-voltage="12"
                        data-bezier-end-x="8" data-bezier-end-y="9.225"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="8" cy="18.315" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-plus"
                        data-wire-type="plus"
                        data-voltage="12"
                        data-bezier-end-x="8" data-bezier-end-y="18.315"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Connection Points Rechts (Ausgehende Linien) -->
                <line class="connection-line" 
                      x1="113" y1="9.225" x2="123.29" y2="9.225" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="12"
                      data-bezier-start-x="123" data-bezier-start-y="9.225"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="113" y1="18.315" x2="123.29" y2="18.315" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="12"
                      data-bezier-start-x="123" data-bezier-start-y="18.315"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== TRANSFORMATOR 12V =====
        function createTransformer12VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 120 80');
            svg.setAttribute('class', 'transformer-svg');
            svg.setAttribute('data-component-type', 'trafo-12v-40w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-phase", "to":"out-plus", "resistance":0.02, "efficiency":0.87},
                {"from":"in-neutral", "to":"out-minus", "resistance":0.02, "efficiency":0.87}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-phase", "in-neutral"],
                "power": 40,
                "voltage": 230,
                "type": "transformer",
                "output_voltage": 12,
                "output_power": 40
            }));
            
            svg.innerHTML = `
                <!-- Gehäuse -->
                <rect class="trafo-housing" x="20" y="10" width="80" height="60" rx="5"/>
                
                <!-- Beschriftung -->
                <text class="trafo-text" x="60" y="30" text-anchor="middle">TRAFO</text>
                <text class="trafo-text" x="60" y="45" text-anchor="middle">12V DC</text>
                <text class="trafo-label" x="60" y="55" text-anchor="middle">40W</text>
                
                <!-- Eingangskabel (230V) -->
                <line stroke="#683c11" stroke-width="4" x1="5" y1="25" x2="20" y2="25"/>
                <line stroke="#1d71b8" stroke-width="4" x1="5" y1="35" x2="20" y2="35"/>
                <line stroke="#ffed00" stroke-width="4" x1="5" y1="45" x2="20" y2="45"/>
                
                <!-- Ausgangskabel (12V) -->
                <line stroke="#e30613" stroke-width="4" x1="100" y1="30" x2="115" y2="30"/>
                <line stroke="#1d1d1b" stroke-width="4" x1="100" y1="50" x2="115" y2="50"/>
                
                <!-- Eingangs-Connection Points -->
                <circle class="connection-socket" 
                        cx="5" cy="25" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-phase"
                        data-wire-type="phase"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="25"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="35" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-neutral"
                        data-wire-type="neutral"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="35"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="45" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-earth"
                        data-wire-type="earth"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="45"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Ausgangs-Connection Points -->
                <line class="connection-line" 
                      x1="115" y1="30" x2="120" y2="30" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="30"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="115" y1="50" x2="120" y2="50" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="50"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== TRANSFORMATOR 24V =====
        function createTransformer24VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 120 80');
            svg.setAttribute('class', 'transformer-svg');
            svg.setAttribute('data-component-type', 'trafo-24v-60w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-phase", "to":"out-plus", "resistance":0.02, "efficiency":0.90},
                {"from":"in-neutral", "to":"out-minus", "resistance":0.02, "efficiency":0.90}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-phase", "in-neutral"],
                "power": 60,
                "voltage": 230,
                "type": "transformer",
                "output_voltage": 24,
                "output_power": 60
            }));
            
            svg.innerHTML = `
                <!-- Gehäuse -->
                <rect class="trafo-housing" x="20" y="10" width="80" height="60" rx="5"/>
                
                <!-- Beschriftung -->
                <text class="trafo-text" x="60" y="30" text-anchor="middle">TRAFO</text>
                <text class="trafo-text" x="60" y="45" text-anchor="middle">24V DC</text>
                <text class="trafo-label" x="60" y="55" text-anchor="middle">60W</text>
                
                <!-- Eingangskabel (230V) -->
                <line stroke="#683c11" stroke-width="4" x1="5" y1="25" x2="20" y2="25"/>
                <line stroke="#1d71b8" stroke-width="4" x1="5" y1="35" x2="20" y2="35"/>
                <line stroke="#ffed00" stroke-width="4" x1="5" y1="45" x2="20" y2="45"/>
                
                <!-- Ausgangskabel (24V) -->
                <line stroke="#e30613" stroke-width="4" x1="100" y1="30" x2="115" y2="30"/>
                <line stroke="#1d1d1b" stroke-width="4" x1="100" y1="50" x2="115" y2="50"/>
                
                <!-- Connection Points analog zu 12V Trafo -->
                <circle class="connection-socket" cx="5" cy="25" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-phase"
                        data-wire-type="phase" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="25"
                        data-bezier-direction="-20,0,0,0"/>
                <circle class="connection-socket" cx="5" cy="35" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-neutral"
                        data-wire-type="neutral" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="35"
                        data-bezier-direction="-20,0,0,0"/>
                <circle class="connection-socket" cx="5" cy="45" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-earth"
                        data-wire-type="earth" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="45"
                        data-bezier-direction="-20,0,0,0"/>
                
                <line class="connection-line" x1="115" y1="30" x2="120" y2="30" stroke="#e30613" 
                      data-connection-type="output-line" data-connection-id="out-plus"
                      data-wire-type="plus" data-voltage="24" data-bezier-start-x="117" data-bezier-start-y="30"
                      data-bezier-direction="20,0,0,0"/>
                <line class="connection-line" x1="115" y1="50" x2="120" y2="50" stroke="#1d1d1b" 
                      data-connection-type="output-line" data-connection-id="out-minus"
                      data-wire-type="minus" data-voltage="24" data-bezier-start-x="117" data-bezier-start-y="50"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== LED-MODUL 24V =====
        function createLED24VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 133.29 27.54');
            svg.setAttribute('class', 'led-module-svg');
            svg.setAttribute('data-component-type', 'led-24v-5w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-plus", "to":"out-plus", "resistance":0.1},
                {"from":"in-minus", "to":"out-minus", "resistance":0.1}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-plus", "in-minus"],
                "power": 5,
                "voltage": 24,
                "type": "led"
            }));
            
            svg.innerHTML = `
                <defs>
                    <style>
                        .cls-1 { fill: #9e9e9e; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-2 { fill: #e8e8e8; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-5 { fill: #fff; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-7 { fill: #1d1d1b; font-family: Arial, sans-serif; font-size: 7.77px; }
                    </style>
                    
                    <!-- Glow-Filter für LEDs -->
                    <filter id="ledGlow24" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="0.8" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <filter id="ledGlowStrong24" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="1.0" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <g>
                    <!-- Anschlusskabel Links -->
                    <line stroke="#1d1d1b" stroke-width="4" x1="8" y1="9.225" x2="16.53" y2="9.225"/>
                    <line stroke="#e30613" stroke-width="4" x1="8" y1="18.315" x2="16.53" y2="18.315"/>
            
                    <g>
                        <rect class="cls-2" x="16.605" y=".75" width="100.14" height="26.04" rx="8.475" ry="8.475"/>
                        <g>
                            <circle class="cls-1" cx="90.18" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="90.18" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="44.73" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="44.73" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="67.455" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="67.455" cy="13.77" r="4.125"/>
                        </g>
                        <text class="cls-7" transform="translate(101.34 5.01) rotate(90)">
                            <tspan x="0" y="0">5 W</tspan>
                        </text>
                        <text class="cls-7" transform="translate(24.84 20.61) rotate(-90)">
                            <tspan x="0" y="0">24 V</tspan>
                            <tspan x=".195" y="9.315">WW</tspan>
                        </text>
                        <text class="cls-7" transform="translate(113.82 17.01) rotate(-180)">+</text>
                        <text class="cls-7" transform="translate(112.68 5.685) rotate(-180)">-</text>
                    </g>
                </g>
                
                <!-- Connection Points Links (Eingangsbuchsen) -->
                <circle class="connection-socket" 
                        cx="8" cy="9.225" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-minus"
                        data-wire-type="minus"
                        data-voltage="24"
                        data-bezier-end-x="8" data-bezier-end-y="9.225"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="8" cy="18.315" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-plus"
                        data-wire-type="plus"
                        data-voltage="24"
                        data-bezier-end-x="8" data-bezier-end-y="18.315"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Connection Points Rechts (Ausgehende Linien) -->
                <line class="connection-line" 
                      x1="113" y1="9.225" x2="123.29" y2="9.225" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="24"
                      data-bezier-start-x="123" data-bezier-start-y="9.225"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="113" y1="18.315" x2="123.29" y2="18.315" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="24"
                      data-bezier-start-x="123" data-bezier-start-y="18.315"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== PLACEHOLDER SVGs für andere Komponenten =====
        function createFISwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 60 80');
            svg.setAttribute('data-component-type', 'fi-schalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="40" height="60" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="8" x="30" y="30" text-anchor="middle">FI</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="45" text-anchor="middle">30mA</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="55" text-anchor="middle">16A</text>
            `;
            
            return svg;
        }

        function createLSSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 60 80');
            svg.setAttribute('data-component-type', 'ls-schalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="40" height="60" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="8" x="30" y="30" text-anchor="middle">LS</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="45" text-anchor="middle">16A</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="55" text-anchor="middle">B</text>
            `;
            
            return svg;
        }

        function createTimerSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 80 60');
            svg.setAttribute('data-component-type', 'zeitschaltuhr');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="60" height="40" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="7" x="40" y="25" text-anchor="middle">TIMER</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="5" x="40" y="35" text-anchor="middle">16A</text>
                <rect fill="#1d1d1b" x="20" y="20" width="20" height="8" rx="2"/>
                <text fill="#00ff00" font-family="Arial" font-size="4" x="30" y="25" text-anchor="middle">12:00</text>
            `;
            
            return svg;
        }

        function createDuskSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 80 60');
            svg.setAttribute('data-component-type', 'daemmerungsschalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="60" height="40" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="40" y="25" text-anchor="middle">DÄMMER</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="5" x="40" y="35" text-anchor="middle">10A</text>
                <circle fill="#ffed00" stroke="#1d1d1b" stroke-width="1" cx="25" cy="25" r="5"/>
                <circle fill="#1d1d1b" cx="55" cy="25" r="3"/>
            `;
            
            return svg;
        }



        // ===== DATASHEET FUNCTIONS =====
        function showDatasheet(componentType) {
            const content = document.getElementById('datasheet-content');
            const info = DatasheetInfo[componentType];
            
            if (!info) {
                content.innerHTML = `
                    <h4 class="text-h2">${componentType}</h4>
                    <p class="text-small">Technische Daten werden geladen...</p>
                `;
                return;
            }
            
            content.innerHTML = `
                <h4 class="text-h2">${info.name}</h4>
                <p class="text-small">${info.description}</p>
                <div class="info-box">
                    <h4>Technische Daten</h4>
                    <p class="text-small">${info.specs}</p>
                </div>
                <div class="info-box">
                    <h4>Schaltskizze</h4>
                    <p class="text-small"><em>Schaltskizze wird hier als SVG dargestellt</em></p>
                </div>
            `;
        }

        // ===== ANWENDUNGS-INITIALISIERUNG =====
        function initializeApplication() {
            console.log('🚀 LED Foundation v0.00.32 - Rauch-Fix: Dunkle Farben + Debug-Logs...');
            
            // 1. Circuit Simulation initialisieren
            try {
                circuit = new RealtimeSimulation();
                circuit.addComponent('power-source-svg', ComponentTypes.POWER_SOURCE, {x: 20, y: 20});
                circuit.start();
                console.log('✅ Circuit Simulation initialisiert');
            } catch (error) {
                console.error('❌ Fehler bei Circuit Simulation:', error);
            }
            
            // 2. WorkspaceManager initialisieren
            try {
                workspaceManager = new WorkspaceManager();
                console.log('✅ WorkspaceManager initialisiert');
            } catch (error) {
                console.error('❌ Fehler bei WorkspaceManager:', error);
            }
            
            // 3. Drag & Drop initialisieren
            try {
                initializeDragAndDrop();
                console.log('✅ Drag & Drop initialisiert');
            } catch (error) {
                console.error('❌ Fehler bei Drag & Drop:', error);
            }
            
            // 4. Connection Hover Effects initialisieren
            try {
                setupConnectionHoverEffects();
                console.log('✅ Connection Hover Effects initialisiert');
            } catch (error) {
                console.error('❌ Fehler bei Connection Hover Effects:', error);
            }
            
            // 5. Initial Power State setzen
            try {
                if (circuit) {
                    circuit.powerStateChanged();
                }
                console.log('✅ Initial Power State gesetzt');
            } catch (error) {
                console.error('❌ Fehler bei Initial Power State:', error);
            }
            
            // 6. Datasheet Toggle initialisieren
            try {
                const toggle = document.getElementById('datasheet-toggle');
                if (toggle) {
                    toggle.title = 'Datenblatt einklappen';
                }
                console.log('✅ Datasheet Toggle initialisiert');
            } catch (error) {
                console.error('❌ Fehler bei Datasheet Toggle:', error);
            }
            
            console.log('🎉 LED-Lernspiel vollständig initialisiert!');
            
            // Status-Report ausgeben
            outputStatusReport();
        }

        function outputStatusReport() {
            console.log('\n=== LED-LERNSPIEL STATUS REPORT ===');
            console.log('📦 Module geladen:');
            console.log('   ✅ Circuit Simulation Engine');
            console.log('   ✅ Component Library');
            console.log('   ✅ Workspace Manager');
            console.log('   ✅ Main Application');
            
            console.log('\n🎮 Verfügbare Funktionen:');
            console.log('   • Drag & Drop von Bauteilen aus der Sidebar');
            console.log('   • Bauteil-Auswahl (Einzeln & Mehrfach)');
            console.log('   • Rechteck-Auswahl für Gruppen');
            console.log('   • Bauteile verschieben und rotieren (Doppelklick)');
            console.log('   • Bauteile löschen (Delete/Backspace)');
            console.log('   • Verbindungen zwischen Anschlusspunkten');
            console.log('   • Verbindungen löschen (Klick auf Verbindung)');
            console.log('   • Echtzeit Physik-Simulation');
            console.log('   • Technische Datenblätter (Hover über Bauteile)');
            console.log('   • Hauptschalter für Stromversorgung');
            
            console.log('\n🎯 Tastatur-Shortcuts:');
            console.log('   • Strg + Klick: Mehrfachauswahl');
            console.log('   • Doppelklick: 90° Rotation');
            console.log('   • Delete/Backspace: Löschen');
            console.log('   • Escape: Auswahl aufheben');
            console.log('   • Strg + 1/2/3: Test-Funktionen (geplant)');
            
            console.log('\n📊 Verfügbare Bauteile:');
            console.log('   • LED-Module (12V 1,2W, 24V 5W)');
            console.log('   • Transformatoren (12V 40W, 24V 60W)');
            console.log('   • Schutzschalter (FI, LS)');
            console.log('   • Steuerungen (Timer, Dämmerung)');
            
            console.log('\n⚡ System bereit für Schaltungsaufbau!');
            console.log('===================================\n');
        }

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('🚨 JavaScript Fehler:', event.error);
            console.error('📍 Datei:', event.filename);
            console.error('📍 Zeile:', event.lineno);
            console.error('📍 Spalte:', event.colno);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('🚨 Unbehandelte Promise Rejection:', event.reason);
            event.preventDefault();
        });

        // ===== DOM READY EVENT =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM Content Loaded - Starte Initialisierung...');
            
            // Kleine Verzögerung für alle Module
            setTimeout(() => {
                initializeApplication();
            }, 100);
        });

        console.log('🎯 App.js geladen - Warte auf DOM Ready...');
    </script>
</body>
</html>