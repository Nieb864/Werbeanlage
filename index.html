<!DOCTYPE html>
<!-- üö® NOTFALL-CACHE-BUST: v0.01.40-FUNKTIONIERT-ES-JETZT-1753131847 -->
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üîß SAUBERES BEZIER-SYSTEM üîß v0.01.41</title>
    <style>
        :root {
            /* Standard-Elektrofarben */
            --wire-brown: #683c11;           /* Phase L1 */
            --wire-blue: #1d71b8;            /* Neutral N */
            --wire-yellow-green: #ffed00;    /* Schutzleiter PE */
            --wire-black: #1d1d1b;           /* Allgemein/Minus */
            --wire-red: #e30613;             /* Plus/Phase */
            
            /* Standard-Materialien */
            --metal-dark: #3c3c3b;           /* Dunkles Metall */
            --metal-light: #878787;          /* Helles Metall */
            --plastic-light: #e8e8e8;        /* Heller Kunststoff */
            --plastic-dark: #9e9e9e;         /* Dunkler Kunststoff */
            --housing-white: #ffffff;        /* Wei√ües Geh√§use */
            --orange: #f39200;               /* Orange Anschl√ºsse */
            
            /* Interface-Farben */
            --font-family: Arial, sans-serif;
            --font-size-h1: 18px;
            --font-size-h2: 14px;
            --font-size-text: 16px;
            --font-size-small: 12px;
            --font-weight-h1: bold;
            --font-weight-h2: bold;
            --font-weight-text: normal;
            --font-weight-small: normal;
            --color-primary: #333;
            --color-secondary: #666;
            --color-light: #f8f9fa;
            --color-border: #dee2e6;
            --color-hover: #e8f5e8;
            --color-hover-border: #4CAF50;
            --color-background: #f0f0f0;
            --color-white: white;
            --color-success: #008800;
            --color-error: #cc0000;
            --color-warning: #856404;
            --color-success-bg: #e6ffe6;
            --color-error-bg: #ffe6e6;
            --color-warning-bg: #fff3cd;
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 10px;
            --spacing-lg: 15px;
            --spacing-xl: 20px;
            --border-radius: 8px;
            --border-width: 2px;
            --border-color: #333;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --box-shadow-hover: 0 4px 12px rgba(76, 175, 80, 0.2);
            --svg-stroke-width: 2px;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--color-background);
            display: flex;
            height: 100vh;
        }

        /* Typography */
        .text-h1 {
            font-size: var(--font-size-h1);
            font-weight: var(--font-weight-h1);
            color: var(--color-primary);
            margin: 0;
            padding-bottom: var(--spacing-md);
            border-bottom: var(--border-width) solid #eee;
        }

        .text-h2 {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin: 0;
        }

        .text-body {
            font-size: var(--font-size-text);
            font-weight: var(--font-weight-text);
            color: var(--color-secondary);
            line-height: 1.5;
            margin: 0;
        }

        .text-small {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-small);
            color: var(--color-secondary);
            line-height: 1.4;
        }

        /* Layout */
        .layout-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        .sidebar-left {
            width: 260px;
            background: var(--color-white);
            border-right: var(--border-width) solid var(--border-color);
            padding: var(--spacing-lg);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-xl);
            min-width: 0;
        }

        /* Task Area */
        .task-area {
            background: var(--color-white);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .task-menu-btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }

        .task-menu-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }

        /* Workspace */
        .workspace {
            flex: 1;
            background: var(--color-white);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            min-height: 400px;
        }

        .workspace-info-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            width: 30px;
            height: 30px;
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: bold;
            color: var(--color-primary);
            z-index: 100;
        }

        .workspace-info-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: scale(1.1);
        }

        .version-display {
            position: absolute;
            top: var(--spacing-md);
            right: 50px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-family: monospace;
            z-index: 95;
            pointer-events: none;
        }

        .info-tooltip {
            position: absolute;
            top: 45px;
            right: -10px;
            width: 320px;
            max-height: 500px;
            background: var(--color-white);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1001;
            color: var(--color-primary);
            font-size: var(--font-size-small);
            overflow-y: auto;
        }

        .workspace-info-btn:hover + .info-tooltip,
        .info-tooltip:hover {
            opacity: 1;
            visibility: visible;
        }

        .info-category {
            margin-bottom: var(--spacing-lg);
        }

        .info-category:last-child {
            margin-bottom: 0;
        }

        .info-category-title {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            border-bottom: 1px solid #eee;
            padding-bottom: var(--spacing-xs);
        }

        .info-rule {
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }

        .info-rule:last-child {
            margin-bottom: 0;
        }

        /* Components Section */
        .components-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .components-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-sm);
        }

        .components-list {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-xs);
        }

        /* Datasheet Section */
        .datasheet-section {
            flex-shrink: 0;
            height: 300px;
            display: flex;
            flex-direction: column;
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .datasheet-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .datasheet-toggle {
            background: var(--color-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            min-width: 60px;
            text-align: center;
        }

        .datasheet-toggle:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
        }

        .datasheet-section.collapsed {
            height: auto;
        }

        .datasheet-section.collapsed .datasheet-content {
            display: none;
        }

        .technical-datasheet {
            flex-shrink: 0;
        }

        .datasheet-content {
            height: 200px;
            overflow-y: auto;
            padding: var(--spacing-md) 0;
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            background: var(--color-light);
        }

        /* Component Items */
        .component-item {
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }

        .component-item:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }

        .component-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }

        .component-name {
            margin-bottom: var(--spacing-xs);
        }

        .component-category {
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        
        .category-toggle {
            background: var(--color-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            min-width: 40px;
            text-align: center;
        }
        
        .category-toggle:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
        }
        
        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .category-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0;
        }
        
        .category-content.collapsed {
            max-height: 0;
            padding: 0;
        }

        .category-title {
            margin-bottom: var(--spacing-md);
        }

        /* Buttons */
        .btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            margin: var(--spacing-xs);
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }

        .btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            border-color: #ccc;
            transform: none;
        }

        /* Function Controls */
        .function-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: var(--border-width) solid #eee;
            justify-content: flex-start;
            align-items: center;
        }

        .function-controls .btn {
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
            justify-content: center;
            min-width: 0;
        }

        .power-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .power-icon svg {
            width: 100%;
            height: 100%;
        }

        .btn-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        /* Component States */
        .component {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: border 0.3s ease;
            border: 0px solid transparent; /* KEIN Border im Normalzustand */
            display: inline-block; /* Container passt sich an SVG-Gr√∂√üe an */
            box-sizing: border-box; /* Border ist in der Gr√∂√üe enthalten */
            line-height: 0; /* Verhindert line-height Einfluss auf inline-block */
            vertical-align: top; /* Verhindert baseline Alignment */
        }

        .component:hover {
            outline: var(--border-width) solid var(--color-hover-border);
            outline-offset: 2px;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        .component.dragging {
            z-index: 1000;
            outline: var(--border-width) solid #FF9800;
            outline-offset: 2px;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.5);
        }

        .component.selected {
            outline: 2px solid #4CAF50 !important;
            outline-offset: 2px !important;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5) !important;
        }

        .component.dragging {
            z-index: 1000 !important;
            opacity: 0.8 !important;
            cursor: grabbing !important;
            outline: 2px solid #FF9800 !important;
            outline-offset: 2px !important;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.5) !important;
        }

        .component {
            transition: transform 0.3s ease !important;
            transform-origin: center center !important;
        }

        /* Power Source */
        .power-source {
            position: absolute;
            top: var(--spacing-xl);
            left: var(--spacing-xl);
            background: transparent;
            border: none;
            border-radius: var(--border-radius);
            padding: 0;
            color: var(--color-warning);
            box-shadow: none;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }

        .power-source svg {
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        /* Connection System */
        .connection-point {
            cursor: crosshair;
            transition: all 0.3s ease;
        }

        .connection-point:hover {
            transform: scale(1.5);
            opacity: 1 !important;
        }

        .connection-point.dragging-connection {
            opacity: 1 !important;
            transform: scale(1.8);
        }

        .connection-socket { 
            fill: #888; 
            stroke: #666; 
            stroke-width: 1; 
            cursor: crosshair; 
            transition: all 0.3s; 
            opacity: 0.7; 
        }

        .connection-socket:hover { 
            opacity: 1; 
            transform: scale(1.3); 
            fill: #4CAF50;
        }

        .connection-line {
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.8;
        }

        .connection-line:hover {
            opacity: 1;
            stroke-width: 4;
            filter: drop-shadow(0 0 3px currentColor);
        }

        .connection-area {
            cursor: crosshair;
            transition: all 0.3s;
            opacity: 0;
        }

        .connection-area:hover {
            opacity: 0.2;
            fill: #4CAF50;
        }

        .connection-area:hover + .connection-visual {
            opacity: 1;
            transform: scale(1.3);
            filter: drop-shadow(0 0 5px #4CAF50);
        }

        .connection-visual {
            transition: all 0.3s;
            opacity: 0.8;
        }

        /* Bezier Connections */
        .bezier-connection {
            fill: none;
            stroke-width: 3;
            opacity: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.9;
            pointer-events: all;
            stroke-width: 4;
        }

        .bezier-connection:hover {
            opacity: 1;
            stroke-width: 6;
            filter: drop-shadow(0 0 5px currentColor);
        }

        .bezier-connection.red-wire {
            stroke: #ff0000;
        }

        .bezier-connection.black-wire {
            stroke: #000000;
        }

        /* LED Cables */
        .led-cable {
            fill: none;
            stroke-width: 3;
            pointer-events: none;
        }

        .led-cable.plus {
            stroke: #ff0000;
        }

        .led-cable.minus {
            stroke: #000000;
        }

        .temp-line {
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            opacity: 0.7;
        }

        /* Dragging Component */
        .dragging-component {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
        }

        /* LED Module */
        .led-module-svg {
            width: auto;
            height: 30px;
        }

        /* Transformer Module */
        .transformer-svg {
            width: auto;
            height: 45px; /* Trafos sind h√∂her als LEDs */
        }

        /* Mobile Terminal */
        .mobile-terminal-svg {
            width: auto;
            height: 50px; /* Gro√ü genug f√ºr Klemme + Anschlusspunkte */
        }

        /* Transformer Styles */
        .trafo-housing { 
            fill: #e8e8e8; 
            stroke: #1d1d1b; 
            stroke-width: 2; 
        }
        
        .trafo-text { 
            fill: #1d1d1b; 
            font-family: Arial, sans-serif; 
            font-size: 8px; 
        }
        
        .trafo-label { 
            fill: #1d1d1b; 
            font-family: Arial, sans-serif; 
            font-size: 6px; 
        }



        /* Info Box */
        .info-box {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--color-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
        }

        .info-box h4 {
            margin-top: 0;
            color: var(--color-primary);
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }

        .info-box p {
            margin-bottom: var(--spacing-sm);
        }

        .info-box p:last-child {
            margin-bottom: 0;
        }

        /* LED States - JavaScript + CSS Hybrid */
        .state-off .cls-5, 
        .state-off .led24-center {
            fill: #ddd !important;
        }

        .state-on .cls-5, 
        .state-on .led24-center {
            fill: #ffff00 !important;
        }

        .state-blinking .cls-5, 
        .state-blinking .led24-center {
            fill: #ffff00 !important;
        }

        .state-broken .cls-5, 
        .state-broken .led24-center {
            fill: #1a1a1a !important;
        }

        .state-overloaded .cls-5, 
        .state-overloaded .led24-center {
            fill: #e91e63 !important;
        }



        /* Live Power Tooltip */
        .power-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            border: 2px solid #ffa500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translate(-50%, -120%);
        }
        
        .power-tooltip.overloaded {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.9);
            animation: pulse-warning 1s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1.0; }
        }

        /* Connection States */
        .connection-socket.connected,
        .connection-line.connected {
            opacity: 0 !important;
            pointer-events: none;
        }

        /* === LED FOUNDATION SVG STANDARDS v1.0 === */

        /* Standard Elektro-Farben */
        .std-wire-plus { stroke: var(--wire-red); fill: none; stroke-width: 3; }
        .std-wire-minus { stroke: var(--wire-black); fill: none; stroke-width: 3; }
        .std-wire-phase { stroke: var(--wire-brown); fill: none; stroke-width: 3; }
        .std-wire-neutral { stroke: var(--wire-blue); fill: none; stroke-width: 3; }
        .std-wire-earth { stroke: var(--wire-yellow-green); fill: none; stroke-width: 3; }

        /* Standard Material-Farben */
        .std-housing-light { fill: var(--plastic-light); stroke: var(--color-primary); stroke-width: 1; }
        .std-housing-dark { fill: var(--plastic-dark); stroke: var(--color-primary); stroke-width: 1; }
        .std-metal-light { fill: var(--metal-light); stroke: var(--color-primary); stroke-width: 1; }
        .std-metal-dark { fill: var(--metal-dark); stroke: var(--color-primary); stroke-width: 1; }
        .std-led-off { fill: #ccc; stroke: var(--color-primary); stroke-width: 1; }

        /* Standard Strichst√§rken */
        .std-hairline { stroke-width: 0.5; }
        .std-thin { stroke-width: 1; }
        .std-cable { stroke-width: 3; }
        .std-connection { stroke-width: 3; }
        .std-thick { stroke-width: 5; }

        /* Standard Text */
        .std-text { fill: var(--color-primary); font-family: Arial, sans-serif; stroke: none; }
        .std-text-small { font-size: 6px; }
        .std-text-medium { font-size: 8px; }
        .std-text-large { font-size: 10px; }
        
        /* Visual Cable Hiding */
        .visual-cable {
            transition: opacity 0.3s ease;
        }
        
        /* Schaltskizze Standards */
        .schematic-line { 
            fill: none; 
            stroke: #1d1d1b; 
            stroke-width: 2; 
            stroke-miterlimit: 10; 
        }
        .schematic-fill-black { 
            fill: #1d1d1b; 
        }
        .schematic-fill-white { 
            fill: #fff; 
            stroke: #1d1d1b; 
            stroke-width: 2; 
            stroke-miterlimit: 10; 
        }
        .schematic-container {
            margin: 10px 0;
            text-align: center;
        }
        .schematic-text {
            fill: #1d1d1b;
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: normal;
        }
        .schematic-text-small {
            fill: #1d1d1b;
            font-family: Arial, sans-serif;
            font-size: 9px;
            font-weight: normal;
        }
        .schematic-dashed {
            stroke-dasharray: 2 2;
        }
        .schematic-fill-black { 
            fill: #1d1d1b; 
        }
        .schematic-fill-white { 
            fill: #fff; 
            stroke: #1d1d1b; 
            stroke-width: 1; 
            stroke-miterlimit: 10; 
        }
        .schematic-fill-none { 
            fill: none; 
            stroke: #1d1d1b; 
            stroke-width: 1; 
            stroke-miterlimit: 10; 
        }

        /* Connection Line Hover Effects */
        .connection-line {
            stroke-width: 4;
            cursor: pointer;
            transition: all 0.3s;
            opacity: 0.8;
            fill: none;
        }

        .connection-line:hover {
            opacity: 1;
            stroke-width: 6;
            filter: drop-shadow(0 0 3px currentColor);
        }

        /* ===== SICHERHEITS-FUNKEN EFFEKT ===== */
        .electrical-danger-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255, 0, 0, 0.1);
            z-index: 10000;
            pointer-events: none;
            animation: danger-flash 0.5s ease-out;
        }

        @keyframes danger-flash {
            0% { 
                background: rgba(255, 255, 0, 0.8);
                box-shadow: inset 0 0 50px rgba(255, 255, 0, 0.8);
            }
            25% { 
                background: rgba(255, 0, 0, 0.6);
                box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.6);
            }
            50% { 
                background: rgba(255, 255, 255, 0.9);
                box-shadow: inset 0 0 150px rgba(255, 255, 255, 0.9);
            }
            75% { 
                background: rgba(255, 0, 0, 0.4);
                box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.4);
            }
            100% { 
                background: rgba(255, 0, 0, 0);
                box-shadow: inset 0 0 0px rgba(255, 0, 0, 0);
            }
        }

        .spark-effect {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffff00 0%, #ff6600 50%, transparent 100%);
            border-radius: 50%;
            animation: spark-burst 0.3s ease-out;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes spark-burst {
            0% {
                transform: scale(0);
                opacity: 1;
                box-shadow: 0 0 10px #ffff00;
            }
            50% {
                transform: scale(3);
                opacity: 0.8;
                box-shadow: 0 0 30px #ff6600;
            }
            100% {
                transform: scale(6);
                opacity: 0;
                box-shadow: 0 0 50px #ff0000;
            }
        }

        .electrical-warning-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            z-index: 10001;
            border: 3px solid #ffff00;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            animation: warning-shake 0.5s ease-out;
        }

        @keyframes warning-shake {
            0%, 100% { transform: translate(-50%, -50%); }
            10% { transform: translate(-48%, -50%); }
            20% { transform: translate(-52%, -50%); }
            30% { transform: translate(-48%, -50%); }
            40% { transform: translate(-52%, -50%); }
            50% { transform: translate(-50%, -52%); }
            60% { transform: translate(-50%, -48%); }
            70% { transform: translate(-50%, -52%); }
            80% { transform: translate(-50%, -48%); }
            90% { transform: translate(-50%, -50%); }
        }



        .connection-socket {
            fill: #4CAF50;
            stroke: #333;
            stroke-width: 1;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .connection-socket:hover { 
            opacity: 1; 
            transform: scale(1.3); 
            fill: #4CAF50;
        }



        /* Wire Type Colors for Power Source */
        .connection-line.std-wire-plus { stroke: var(--wire-red); }
        .connection-line.std-wire-minus { stroke: var(--wire-black); }
        .connection-line.std-wire-phase { stroke: var(--wire-brown); }
        .connection-line.std-wire-neutral { stroke: var(--wire-blue); }
        .connection-line.std-wire-earth { stroke: var(--wire-yellow-green); }
        
        /* Component States */
        .component-broken {
            filter: brightness(0.3) !important;
            opacity: 0.7 !important;
        }
        
        .component-broken .trafo-housing {
            fill: #333 !important;
            stroke: #666 !important;
        }

        .wire-hover-area.std-wire-plus { color: var(--wire-red); }
        .wire-hover-area.std-wire-minus { color: var(--wire-black); }
        .wire-hover-area.std-wire-phase { color: var(--wire-brown); }
        .wire-hover-area.std-wire-neutral { color: var(--wire-blue); }
        .wire-hover-area.std-wire-earth { color: var(--wire-yellow-green); }

        /* Standard Gradients f√ºr Schalter */
        .std-gradient-off {
            stop-color: var(--color-border);
        }

        .std-gradient-on {
            stop-color: var(--color-success);
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <div class="sidebar-left">
            <div class="datasheet-section" id="datasheet-section">
                <div class="datasheet-header">
                    <h3 class="text-h1">Technisches Datenblatt</h3>
                    <button class="datasheet-toggle" onclick="toggleDatasheet()" id="datasheet-toggle">
                        ‚ñ≤
                    </button>
                </div>
                
                <div class="technical-datasheet">
                    <div class="datasheet-content" id="datasheet-content-wrapper">
                        <div id="datasheet-content" class="text-small">
                            <p><em>Bewege den Cursor √ºber ein Bauteil, um technische Informationen und Schaltskizzen anzuzeigen.</em></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="components-section">
                <div class="components-header">
                    <h2 class="text-h1">Bauteile</h2>
                </div>
                
                <div class="components-list">
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Schutzschalter</span>
                            <button class="category-toggle" onclick="toggleCategory('schutzschalter')" id="toggle-schutzschalter">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-schutzschalter">
                        <div class="component-item" data-component-type="fi-schalter">
                            <div class="component-name text-h2">FI-Schutzschalter</div>
                            <div class="component-specs text-small">
                                30mA, 16A<br>
                                Fehlerstromschutz
                            </div>
                        </div>
                        <div class="component-item" data-component-type="ls-schalter">
                            <div class="component-name text-h2">LS-Schalter</div>
                            <div class="component-specs text-small">
                                16A, √úberlastschutz<br>
                                Charakteristik B
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Steuerungen</span>
                            <button class="category-toggle" onclick="toggleCategory('steuerungen')" id="toggle-steuerungen">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-steuerungen">
                        <div class="component-item" data-component-type="zeitschaltuhr">
                            <div class="component-name text-h2">Zeitschaltuhr</div>
                            <div class="component-specs text-small">
                                Digital, 16A<br>
                                Tages-/Wochenprogramm
                            </div>
                        </div>
                        <div class="component-item" data-component-type="daemmerungsschalter">
                            <div class="component-name text-h2">D√§mmerungsschalter</div>
                            <div class="component-specs text-small">
                                10A, einstellbar<br>
                                2-200 Lux
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Transformatoren</span>
                            <button class="category-toggle" onclick="toggleCategory('transformatoren')" id="toggle-transformatoren">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-transformatoren">
                        <div class="component-item" data-component-type="trafo-12v-40w">
                            <div class="component-name text-h2">Trafo 12V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 12V DC, 40W
                            </div>
                        </div>
                        <div class="component-item" data-component-type="trafo-24v-60w">
                            <div class="component-name text-h2">Trafo 24V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 24V DC, 60W
                            </div>
                        </div>
                        <div class="component-item" data-component-type="trafo-12v-3w">
                            <div class="component-name text-h2" style="color: #ff6b6b;">Trafo 12V Mini</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 12V DC, <strong style="color: #ff6b6b;">3W</strong>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Kabel</span>
                            <button class="category-toggle" onclick="toggleCategory('kabel')" id="toggle-kabel">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-kabel">
                        <div class="component-item" data-component-type="kabel-flexibel-sw">
                            <div class="component-name text-h2">Flexibles Kabel sw</div>
                            <div class="component-specs text-small">
                                1 mm¬≤, schwarz<br>
                                bis 24V, 100W
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Kabelverbindungen</span>
                            <button class="category-toggle" onclick="toggleCategory('kabelverbindungen')" id="toggle-kabelverbindungen">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-kabelverbindungen">
                        <div class="component-item" data-component-type="klemme-mobil-3l">
                            <div class="component-name text-h2">Mobile Klemme 3L</div>
                            <div class="component-specs text-small">
                                0,08-2,5 mm¬≤<br>
                                400V, 32A
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">Entwickler</span>
                            <button class="category-toggle" onclick="toggleCategory('entwickler')" id="toggle-entwickler">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-entwickler">
                        <div class="component-item" data-component-type="dev-placeholder">
                            <div class="component-name text-h2" style="color: #888;">Platzhalter</div>
                            <div class="component-specs text-small">
                                F√ºr zuk√ºnftige<br>
                                Entwicklungen
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <div class="component-category">
                        <div class="category-header">
                            <span class="category-title text-h2">LED-Module</span>
                            <button class="category-toggle" onclick="toggleCategory('led-module')" id="toggle-led-module">‚ñº</button>
                        </div>
                        <div class="category-content" id="category-led-module">
                        <div class="component-item" data-component-type="led-12v-1.2w">
                            <div class="component-name text-h2">LED-Modul 12V-1,2W-WW</div>
                            <div class="component-specs text-small">
                                1,2W, Warmwei√ü<br>
                                12V DC, 3x LED
                            </div>
                        </div>
                        <div class="component-item" data-component-type="led-24v-5w">
                            <div class="component-name text-h2">LED-Modul 24V</div>
                            <div class="component-specs text-small">
                                5W, Warmwei√ü<br>
                                24V DC
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-area">
            <div class="task-area">
                <div class="task-header">
                    <h3 class="text-h1">Aufgabenstellung</h3>
                    <button class="task-menu-btn" onclick="openTaskMenu()">
                        Zum Aufgaben-Men√º
                    </button>
                </div>
                
                <p class="text-body">
                    Baue eine Schaltung mit einem 12V Transformator und verbinde die LED-Module korrekt. 
                    Achte auf die richtige Polarit√§t und die maximale Leistung des Transformators.
                </p>
                
                <div class="function-controls">
                    <button id="powerBtn" class="btn" onclick="togglePower()">
                        <span class="power-icon">
                            <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                        <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                        <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                        <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                        <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                                <g>
                                    <g>
                                        <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                                 points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                              x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                              x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                    </g>
                                    <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x="5.36" y="7.68" width="11.18" height="4.98"/>
                                    <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                          transform="translate(6.36 11.7)">
                                        <tspan x="0" y="0">O</tspan>
                                        <tspan x="2.92" y="0">-</tspan>
                                        <tspan x="4.27" y="0">off</tspan>
                                    </text>
                                </g>
                            </svg>
                        </span>
                        <span class="btn-text">
                            <span>Haupt-</span>
                            <span>schalter</span>
                        </span>
                    </button>
                    
                    <button class="btn" onclick="clearWorkspace()">
                        Arbeitsfl√§che leeren
                    </button>
                    
                    <button class="btn" onclick="resetConnections()">
                        Verbindungen zur√ºcksetzen
                    </button>
                </div>
            </div>
            
            <div class="workspace" id="workspace">
                <div class="version-display">v0.01.46</div>
                <div class="workspace-info-btn" id="info-btn">
                    i
                </div>
                <div class="info-tooltip" id="info-tooltip">
                    <div class="info-category">
                        <div class="info-category-title">Bauteile</div>
                        <div class="info-rule">‚Ä¢ Aus Sidebar ziehen zum Platzieren</div>
                        <div class="info-rule">‚Ä¢ Klick: Einzelnes Bauteil ausw√§hlen</div>
                        <div class="info-rule">‚Ä¢ Strg + Klick: Mehrere Bauteile ausw√§hlen</div>
                        <div class="info-rule">‚Ä¢ Rechteck aufziehen: Gruppenauswahl</div>
                        <div class="info-rule">‚Ä¢ Doppelklick: 90¬∞ Drehung</div>
                        <div class="info-rule">‚Ä¢ Ziehen: Ausgew√§hlte Bauteile verschieben</div>
                        <div class="info-rule">‚Ä¢ Entf-Taste: Ausgew√§hlte Bauteile l√∂schen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Verbindungen</div>
                        <div class="info-rule">‚Ä¢ Anschlusspunkte verbinden durch Klicken und Ziehen</div>
                        <div class="info-rule">‚Ä¢ Klick auf Verbindung: Ausw√§hlen</div>
                        <div class="info-rule">‚Ä¢ Entf-Taste: Ausgew√§hlte Verbindung l√∂schen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Allgemein</div>
                        <div class="info-rule">‚Ä¢ Klick ins Leere: Auswahl aufheben</div>
                        <div class="info-rule">‚Ä¢ Esc-Taste: Alle Auswahlen aufheben</div>
                        <div class="info-rule">‚Ä¢ Strg + Z: R√ºckg√§ngig (geplant)</div>
                    </div>
                </div>
                
                <div class="power-source" id="power-source-svg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50.29 115.10" width="50.29" height="115.10">
                        <defs>
                            <style>
                                .power-cls-4 {
                                    fill: #3c3c3b;
                                    stroke: #1d1d1b;
                                    stroke-width: 1.6px;
                                }
                                .power-cls-5 {
                                    fill: #878787;
                                }
                            </style>
                        </defs>
                        <g data-name="Ebene_1">
                            <!-- Geh√§use (√ó1.6 skaliert) -->
                            <circle class="std-metal-dark" cx="25.14" cy="25.14" r="24.34"/>
                            <path class="std-metal-light" d="M14.19,26.98c0-7.09,4.94-12.93,10.94-12.93s10.94,5.84,10.94,12.93v59.71l-21.87-.27c0-19.81,0-39.62-.01-59.43Z"/>
                        </g>
                        
                        <!-- Connection Points -->
                        <g data-name="connections">

                            
                            <!-- Connection Lines (Workspace-Koordinaten) -->
                            <line class="connection-line" 
                                  x1="18.83" y1="86.4" x2="18.83" y2="102.4" 
                                  stroke="#683c11"
                                  data-connection-type="output-line"
                                  data-connection-id="out-phase"
                                  data-wire-type="phase"
                                  data-voltage="230"
                                  data-bezier-start-x="38.83" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                                  
                            <line class="connection-line" 
                                  x1="31.44" y1="86.4" x2="31.44" y2="102.4" 
                                  stroke="#1d71b8"
                                  data-connection-type="output-line"
                                  data-connection-id="out-neutral"
                                  data-wire-type="neutral"
                                  data-voltage="230"
                                  data-bezier-start-x="51.44" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                                  
                            <line class="connection-line" 
                                  x1="25.09" y1="86.4" x2="25.09" y2="102.4" 
                                  stroke="#ffed00"
                                  data-connection-type="output-line"
                                  data-connection-id="out-earth"
                                  data-wire-type="earth"
                                  data-voltage="230"
                                  data-bezier-start-x="45.09" data-bezier-start-y="105.4"
                                  data-bezier-direction="0,16,0,0"/>
                        </g>
                    </svg>
                </div>
                
                <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500;">
                </svg>
            </div>
        </div>
    </div>

    <script>
        // ===== CIRCUIT SIMULATION ENGINE =====

        // Globale Variablen
        let systemPower = false;
        let connections = [];
        let components = [];

        // Komponenten-Typen
        const ComponentTypes = {
            POWER_SOURCE: 'power-source',
            TRANSFORMER_12V: 'trafo-12v-40w',
            TRANSFORMER_24V: 'trafo-24v-60w',
            TRANSFORMER_12V_3W: 'trafo-12v-3w',
            LED_12V_1_2W: 'led-12v-1.2w',
            LED_12V: 'led-12v-3.5w',
            LED_24V: 'led-24v-5w',
            FI_SWITCH: 'fi-schalter',
            LS_SWITCH: 'ls-schalter',
            MOBILE_TERMINAL_3L: 'klemme-mobil-3l'
        };

        // Technische Spezifikationen
        const ComponentSpecs = {
            [ComponentTypes.POWER_SOURCE]: {
                voltage: 230,
                maxCurrent: 16,
                type: 'source'
            },
            [ComponentTypes.TRANSFORMER_12V]: {
                inputVoltage: 230,
                outputVoltage: 12,
                maxPower: 40,
                type: 'transformer'
            },
            [ComponentTypes.TRANSFORMER_24V]: {
                inputVoltage: 230,
                outputVoltage: 24,
                maxPower: 60,
                type: 'transformer'
            },
            [ComponentTypes.TRANSFORMER_12V_3W]: {
                inputVoltage: 230,
                outputVoltage: 12,
                maxPower: 3,
                type: 'transformer'
            },
            [ComponentTypes.LED_12V_1_2W]: {
                ratedVoltage: 12,
                power: 1.2,
                tolerance: 1.1,
                type: 'load'
            },
            [ComponentTypes.LED_12V]: {
                ratedVoltage: 12,
                power: 3.5,
                tolerance: 1.1,
                type: 'load'
            },
            [ComponentTypes.LED_24V]: {
                ratedVoltage: 24,
                power: 5,
                tolerance: 1.1,
                type: 'load'
            },
            [ComponentTypes.MOBILE_TERMINAL_3L]: {
                ratedVoltage: 400,
                power: 0,
                maxCurrent: 32,
                type: 'connector',
                terminals: 3
            }
        };

        // Zust√§nde der Komponenten
        const ComponentStates = {
            OFF: 'off',
            ON: 'on',
            BLINKING: 'blinking',
            BROKEN: 'broken',
            OVERLOADED: 'overloaded'
        };

        // ===== COMPONENT STATE MACHINE =====
        class ComponentStateMachine {
            constructor(componentType, elementId) {
                this.type = componentType;
                this.elementId = elementId;
                this.state = ComponentStates.OFF;
                this.specs = ComponentSpecs[componentType];
                this.currentVoltage = 0;
                this.currentPower = 0;
                
                // Blink-Animation State
                this.blinkInterval = null;
                this.blinkState = true;
                

                
                // Initial state CSS setzen
                this.applyStateCSS();
                
                // Warte kurz bis SVG im DOM ist, dann f√§rbe
                setTimeout(() => {
                    this.applyDynamicColors();
                }, 100);
            }
            
            updateState(voltage, current) {
                this.currentVoltage = voltage;
                this.currentPower = voltage * current;
                
                const previousState = this.state;
                
                // üîß BROKEN STATE: √úberpr√ºfe ob diese Komponente dauerhaft kaputt ist
                const componentState = window.circuit?.graph?.getComponentState?.(this.elementId);
                const isSystemPowered = window.systemPower || false;
                
                if (componentState === 'broken') {
                    // Kaputte LEDs bleiben kaputt - zeigen aber unterschiedlich je nach Hauptschalter
                    if (isSystemPowered) {
                        this.state = ComponentStates.BROKEN;
                        console.log(`üíÄ LED ${this.elementId}: Ist PERMANENT kaputt und Hauptschalter EIN ‚Üí BROKEN`);
                    } else {
                        this.state = ComponentStates.OFF;
                        console.log(`üîß LED ${this.elementId}: Ist PERMANENT kaputt, aber Hauptschalter AUS ‚Üí OFF`);
                    }
                } else if (this.specs.type === 'load') {
                    // Nur nicht-kaputte LEDs k√∂nnen normal funktionieren
                    this.state = this.calculateLEDState(voltage);
                } else if (this.specs.type === 'transformer') {
                    this.state = this.calculateTransformerState();
                } else if (this.specs.type === 'connector') {
                    // Mobile Klemme: Durchschalten aller Anschl√ºsse
                    this.state = this.calculateConnectorState();
                }
                
                if (previousState !== this.state) {
                    this.animateStateChange();
                    this.updateBlinkAnimation();
                }
            }
            
            setState(newState) {
                const previousState = this.state;
                this.state = newState;
                
                if (previousState !== this.state) {
                    console.log(`üîÑ ${this.elementId}: ${previousState} ‚Üí ${newState}`);
                    this.animateStateChange();
                    this.updateBlinkAnimation();
                }
            }
            
            calculateLEDState(voltage) {
                if (voltage === 0) return ComponentStates.OFF;
                
                const ratedVoltage = this.specs.ratedVoltage;
                const tolerance = this.specs.tolerance;
                
                // Toleranz 1.1 = 110% zus√§tzlich, also Faktoren:
                const maxNormal = ratedVoltage * tolerance;        // 12V * 1.1 = 13.2V
                const maxBlink = ratedVoltage * (tolerance * 2);   // 12V * 2.2 = 26.4V  
                const minVoltage = ratedVoltage * 0.8;             // 12V * 0.8 = 9.6V (20% unter Nennspannung)
                
                debugLog(`üîç LED State Calc: ${voltage}V f√ºr ${ratedVoltage}V LED`);
                console.log(`üìä Grenzen: ON>${minVoltage}V, BLINK>${maxNormal}V, BROKEN>${maxBlink}V`);
                
                if (voltage > maxBlink) {
                    console.log(`üî¥ BROKEN: ${voltage}V > ${maxBlink}V`);
                    return ComponentStates.BROKEN;
                }
                
                if (voltage > maxNormal) {
                    console.log(`üü† BLINKING: ${voltage}V > ${maxNormal}V`);
                    return ComponentStates.BLINKING;
                }
                
                if (voltage >= minVoltage) {
                    console.log(`üü° ON: ${voltage}V >= ${minVoltage}V`);
                    return ComponentStates.ON;
                }
                
                console.log(`‚ö´ OFF: ${voltage}V < ${minVoltage}V`);
                return ComponentStates.OFF;
            }
            
            calculateTransformerState() {
                if (this.currentPower > this.specs.maxPower * 1.2) {
                    return ComponentStates.BROKEN;
                }
                if (this.currentPower > this.specs.maxPower) {
                    return ComponentStates.OVERLOADED;
                }
                return this.currentVoltage > 0 ? ComponentStates.ON : ComponentStates.OFF;
            }
            
            calculateConnectorState() {
                // Mobile Klemme: Durchschalt-Logic
                // Pr√ºfe alle Anschl√ºsse - wenn einer Spannung hat, leite an alle anderen weiter
                
                // Zugriff auf globale workspaceManager Variable
                if (!workspaceManager) {
                    console.log(`‚ö†Ô∏è Klemme ${this.elementId}: WorkspaceManager nicht verf√ºgbar`);
                    return ComponentStates.OFF;
                }
                
                const connections = workspaceManager.connections;
                const myTerminals = [];
                
                // Finde alle meine Terminal-Anschl√ºsse
                for (const [connectionId, connectionData] of connections) {
                    if (connectionData.fromComponent === this.elementId) {
                        myTerminals.push({
                            type: 'output',
                            socket: connectionData.from,
                            connectionId: connectionId,
                            targetComponent: connectionData.toComponent
                        });
                    }
                    if (connectionData.toComponent === this.elementId) {
                        myTerminals.push({
                            type: 'input', 
                            socket: connectionData.to,
                            connectionId: connectionId,
                            sourceComponent: connectionData.fromComponent
                        });
                    }
                }
                
                console.log(`üîó Klemme ${this.elementId}: ${myTerminals.length} Anschl√ºsse gefunden`);
                
                // Wenn mindestens eine Verbindung Spannung f√ºhrt, sind alle ON
                let hasVoltage = false;
                for (const terminal of myTerminals) {
                    if (terminal.type === 'input') {
                        // Direkte Spannungspr√ºfung aus den ComponentSpecs
                        const sourceElement = document.getElementById(terminal.sourceComponent);
                        if (sourceElement) {
                            const sourceType = sourceElement.dataset.componentType;
                            console.log(`üîç Klemme ${this.elementId}: Pr√ºfe Source ${terminal.sourceComponent} (Type: ${sourceType})`);
                            
                            // Trafo-Ausgang hat immer seine spezifizierte Spannung, wenn er l√§uft
                            if (sourceType && sourceType.includes('trafo')) {
                                // Finde ComponentType Key f√ºr sourceType
                                const componentTypeKey = Object.keys(ComponentTypes).find(key => 
                                    ComponentTypes[key] === sourceType
                                );
                                
                                console.log(`üîç Klemme ${this.elementId}: ComponentType Key gefunden: ${componentTypeKey}`);
                                
                                if (componentTypeKey) {
                                    const sourceComponentSpecs = ComponentSpecs[ComponentTypes[componentTypeKey]];
                                    console.log(`üîç Klemme ${this.elementId}: ComponentSpecs gefunden:`, sourceComponentSpecs);
                                    
                                    if (sourceComponentSpecs && sourceComponentSpecs.outputVoltage) {
                                        hasVoltage = true;
                                        maxVoltage = Math.max(maxVoltage, sourceComponentSpecs.outputVoltage);
                                        console.log(`‚ö° Klemme ${this.elementId}: Spannung von Trafo ${terminal.sourceComponent} (${sourceComponentSpecs.outputVoltage}V)`);
                                        break;
                                    }
                                } else {
                                    console.log(`‚ö†Ô∏è Klemme ${this.elementId}: ComponentType Key f√ºr ${sourceType} nicht gefunden`);
                                }
                            }
                        } else {
                            console.log(`‚ö†Ô∏è Klemme ${this.elementId}: Source-Element ${terminal.sourceComponent} nicht gefunden`);
                        }
                    }
                }
                
                // Durchschalten: Spannung weiterleiten
                let maxVoltage = 0;
                for (const terminal of myTerminals) {
                    if (terminal.type === 'input') {
                        if (typeof window !== 'undefined' && window.circuit && window.circuit.components) {
                            const sourceComponent = window.circuit.components.get(terminal.sourceComponent);
                            if (sourceComponent && sourceComponent.currentVoltage > 0) {
                                maxVoltage = Math.max(maxVoltage, sourceComponent.currentVoltage);
                            }
                        }
                    }
                }
                
                if (hasVoltage) {
                    this.currentVoltage = maxVoltage; // WICHTIG: Spannung setzen f√ºr Weitergabe!
                    console.log(`üîÑ Klemme ${this.elementId}: Durchschaltung aktiv (${maxVoltage}V)`);
                    return ComponentStates.ON;
                } else {
                    this.currentVoltage = 0;
                    console.log(`‚ö´ Klemme ${this.elementId}: Keine Eingangsspannung`);
                    return ComponentStates.OFF;
                }
            }
            
            animateStateChange() {
                this.applyStateCSS();
                console.log(`${this.type} (${this.elementId}): ${this.state} (${this.currentVoltage}V, ${this.currentPower.toFixed(2)}W)`);
            }
            
            applyStateCSS() {
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                element.classList.remove('state-off', 'state-on', 'state-blinking', 'state-broken', 'state-overloaded');
                element.classList.add(`state-${this.state}`);
            }
            
            updateBlinkAnimation() {
                // Stoppe vorherige Blink-Animation
                if (this.blinkInterval) {
                    clearInterval(this.blinkInterval);
                    this.blinkInterval = null;
                }
                
                // Starte Blink-Animation nur bei BLINKING state
                if (this.state === ComponentStates.BLINKING) {
                    console.log(`üü† Starte Blink-Animation f√ºr ${this.elementId}`);
                    this.blinkInterval = setInterval(() => {
                        this.blinkState = !this.blinkState;
                        console.log(`üîÑ Blink ${this.elementId}: ${this.blinkState}`);
                        this.applyBlinkColors();
                    }, 500); // Blinkt alle 500ms wie im React-Code
                } else {
                    this.blinkState = true;
                    this.applyDynamicColors();
                }
            }
            
            applyBlinkColors() {
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                // Nur LEDs f√§rben, nicht Trafos oder andere Komponenten
                if (this.specs.type !== 'load') return;
                
                const ledCenters = element.querySelectorAll('.cls-5, .led24-center');
                
                ledCenters.forEach((led, index) => {
                    const color = this.blinkState ? '#ffff00' : '#ddd';
                    const filter = this.blinkState ? this.getGlowEffect(this.state, true) : null;
                    
                    console.log(`üîÑ Blink LED ${index}: ${color}, Filter: ${filter}`);
                    
                    led.style.setProperty('fill', color, 'important');
                    
                    if (filter) {
                        led.style.filter = filter;
                        led.setAttribute('filter', filter);
                    } else {
                        led.style.filter = '';
                        led.removeAttribute('filter');
                    }
                });
            }
            
            applyDynamicColors() {
                const element = document.getElementById(this.elementId);
                if (!element) {
                    console.log(`‚ùå Element nicht gefunden: ${this.elementId}`);
                    return;
                }
                
                // Nur LEDs f√§rben, nicht Trafos oder andere Komponenten
                if (this.specs.type !== 'load') {
                    return;
                }
                
                console.log(`üé® Setze LED State f√ºr ${this.elementId}: ${this.state}`);
                
                // F√ºr statische States (nicht BLINKING) nur CSS-Klassen verwenden
                if (this.state !== ComponentStates.BLINKING) {
                    const ledCenters = element.querySelectorAll('.cls-5, .led24-center');
                    ledCenters.forEach((led, index) => {
                        const filter = this.getGlowEffect(this.state, true);
                        
                        if (filter) {
                            led.style.filter = filter;
                            led.setAttribute('filter', filter);
                        } else {
                            led.style.filter = '';
                            led.removeAttribute('filter');
                        }
                    });
                }
            }
            
            getLedColor(state, isBlinking) {
                switch (state) {
                    case ComponentStates.OFF:
                        return '#ddd'; // Grau (aus)
                    case ComponentStates.ON:
                        return '#ffff00'; // Gelb (an)
                    case ComponentStates.BLINKING:
                        return isBlinking ? '#ffff00' : '#ddd'; // Gelb blinkend
                    case ComponentStates.BROKEN:
                        return '#1a1a1a'; // Schwarz (kaputt)
                    case ComponentStates.OVERLOADED:
                        return '#e91e63'; // Pink (√ºberlastet)
                    default:
                        return '#ddd';
                }
            }
            
            getGlowEffect(state, isBlinking) {
                if (state === ComponentStates.OFF) return null;
                if (state === ComponentStates.BROKEN) return null;
                if (state === ComponentStates.BLINKING && !isBlinking) return null;
                
                // Verwende die passenden Filter IDs basierend auf LED-Typ
                const filterId = this.type.includes('24v') ? 'ledGlow24' : 'ledGlow';
                const strongFilterId = this.type.includes('24v') ? 'ledGlowStrong24' : 'ledGlowStrong';
                
                return state === ComponentStates.BLINKING ? `url(#${strongFilterId})` : `url(#${filterId})`;
            }
            

            
            createSmokeOverlay() {
                const element = document.getElementById(this.elementId);
                debugLog(`üîç createSmokeOverlay: Element=${!!element}, Type=${this.specs.type}`);
                if (!element || this.specs.type !== 'load' || this.smokeOverlay) {
                    console.log(`‚ùå Rauch-Overlay abgebrochen: Element=${!!element}, Type=${this.specs.type}, Exists=${!!this.smokeOverlay}`);
                    return;
                }
                
                // Rauch-Overlay erstellen
                this.smokeOverlay = document.createElement('div');
                this.smokeOverlay.className = 'smoke-overlay';
                this.smokeOverlay.innerHTML = `
                    <svg width="80" height="100" style="overflow: visible;">
                        <!-- Rauch-Pfade: Steigen vertikal nach oben -->
                        <path class="smoke-group smoke-1" fill="#333" opacity="0.8" 
                              d="M40,90 Q35,70 45,50 Q50,30 40,10 Q35,5 40,0"/>
                        <path class="smoke-group smoke-2" fill="#444" opacity="0.6" 
                              d="M35,85 Q40,65 30,45 Q25,25 35,5 Q40,0 35,-5"/>
                        <path class="smoke-group smoke-3" fill="#555" opacity="0.4" 
                              d="M45,88 Q30,68 50,48 Q55,28 45,8 Q40,3 45,-2"/>
                              
                        <!-- Gespiegelte Serie -->
                        <path class="smoke-group-alt smoke-alt-1" fill="#222" opacity="0.7" 
                              d="M38,92 Q43,72 33,52 Q28,32 38,12 Q43,7 38,2"/>
                        <path class="smoke-group-alt smoke-alt-2" fill="#333" opacity="0.5" 
                              d="M42,87 Q37,67 47,47 Q52,27 42,7 Q37,2 42,-3"/>
                        <path class="smoke-group-alt smoke-alt-3" fill="#444" opacity="0.3" 
                              d="M36,89 Q41,69 31,49 Q26,29 36,9 Q41,4 36,-1"/>
                    </svg>
                `;
                
                // Zum Workspace hinzuf√ºgen
                document.getElementById('workspace').appendChild(this.smokeOverlay);
                
                // Positionierung und Gegen-Rotation (nach DOM-Einf√ºgung!)
                setTimeout(() => {
                    this.updateSmokePosition();
                }, 10); // Kurze Verz√∂gerung f√ºr DOM-Update
                
                console.log(`üí® Rauch-Overlay erstellt und wird positioniert`);
            }
            
            updateSmokePosition() {
                if (!this.smokeOverlay) return;
                
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                // MODUL-ZENTRUM berechnen (nicht LED-Zentrum!)
                const moduleRect = element.getBoundingClientRect();
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                
                // Mitte des gesamten LED-Moduls
                const centerX = moduleRect.left - workspaceRect.left + moduleRect.width / 2;
                const centerY = moduleRect.top - workspaceRect.top + moduleRect.height / 2;
                
                // LED-Rotation abrufen
                const rotation = window.workspaceManager?.componentRotations?.get(element) || 0;
                
                // Rauch-Overlay positionieren (mittig √ºber MODUL)
                this.smokeOverlay.style.position = 'absolute';
                this.smokeOverlay.style.left = (centerX - 40) + 'px'; // 40 = halbe Rauch-Breite
                this.smokeOverlay.style.top = (centerY - 50) + 'px';  // 50 = Rauch-H√∂he Offset
                this.smokeOverlay.style.transform = `rotate(${-rotation}deg)`; // GEGEN-Rotation!
                this.smokeOverlay.style.pointerEvents = 'none';
                this.smokeOverlay.style.zIndex = '100';
                this.smokeOverlay.style.transformOrigin = '40px 50px'; // Rotation um Modul-Zentrum
                
                console.log(`üîÑ Rauch MODUL-Zentrum: (${centerX}, ${centerY}), Rotation: ${rotation}¬∞ ‚Üí Rauch: ${-rotation}¬∞`);
            }
            
            removeSmokeOverlay() {
                if (this.smokeOverlay) {
                    if (this.smokeOverlay.parentNode) {
                        this.smokeOverlay.parentNode.removeChild(this.smokeOverlay);
                    }
                    this.smokeOverlay = null;
                    console.log(`üßπ Rauch-Overlay entfernt`);
                }
            }
        }

        // ===== CIRCUIT GRAPH =====
        class CircuitGraph {
            constructor() {
                this.nodes = new Map();
                this.edges = new Map();
                this.stateMachines = new Map();
                this.componentStates = new Map(); // Component states: 'on', 'off', 'broken', etc.
            }
            
            addComponent(id, type, position) {
                this.nodes.set(id, {
                    id: id,
                    type: type,
                    position: position,
                    connections: new Set()
                });
                
                this.stateMachines.set(id, new ComponentStateMachine(type, id));
                
                console.log(`Bauteil hinzugef√ºgt: ${type} (${id})`);
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.edges.set(id, {
                    from: fromComponent,
                    to: toComponent
                });
                
                if (this.nodes.has(fromComponent)) {
                    this.nodes.get(fromComponent).connections.add(toComponent);
                }
                if (this.nodes.has(toComponent)) {
                    this.nodes.get(toComponent).connections.add(fromComponent);
                }
                
                console.log(`Verbindung erstellt: ${fromComponent} ‚Üí ${toComponent}`);
            }
            
            findPath(startNode, endNode, visited = new Set()) {
                if (startNode === endNode) return [startNode];
                if (visited.has(startNode)) return null;
                
                visited.add(startNode);
                
                const component = this.nodes.get(startNode);
                if (!component) return null;
                
                for (const neighbor of component.connections) {
                    const path = this.findPath(neighbor, endNode, new Set(visited));
                    if (path) {
                        return [startNode, ...path];
                    }
                }
                
                return null;
            }
            
            getConnectedComponents(startNode) {
                const visited = new Set();
                const connected = [];
                
                const dfs = (nodeId) => {
                    if (visited.has(nodeId)) return;
                    visited.add(nodeId);
                    connected.push(nodeId);
                    
                    const component = this.nodes.get(nodeId);
                    if (component) {
                        for (const neighbor of component.connections) {
                            dfs(neighbor);
                        }
                    }
                };
                
                dfs(startNode);
                return connected;
            }
            
            // ===== COMPONENT STATE MANAGEMENT =====
            setComponentState(componentId, state) {
                // PERSISTENZ: Broken Components bleiben broken
                const currentState = this.componentStates.get(componentId);
                if (currentState === 'broken' && state !== 'broken') {
                    console.log(`üö´ Component ${componentId} bleibt broken - State change ${state} ignoriert`);
                    return; // Broken Components k√∂nnen nicht repariert werden
                }
                
                this.componentStates.set(componentId, state);
                console.log(`üîß Component ${componentId} State ‚Üí ${state}`);
                
                // Visual update
                const element = document.getElementById(componentId);
                if (element) {
                    element.classList.remove('component-on', 'component-off', 'component-broken');
                    element.classList.add(`component-${state}`);
                }
            }
            
            getComponentState(componentId) {
                return this.componentStates.get(componentId) || 'off';
            }
            
            // RESET: Kaputte Bauteile reparieren (f√ºr Lerneffekt)
            resetComponentState(componentId) {
                this.componentStates.delete(componentId);
                console.log(`üîÑ Component ${componentId} zur√ºckgesetzt (repariert)`);
                
                // Visual update
                const element = document.getElementById(componentId);
                if (element) {
                    element.classList.remove('component-on', 'component-off', 'component-broken');
                    element.classList.add('component-off');
                }
            }
        }

        // ===== PHYSICS ENGINE =====
        class PhysicsEngine {
            constructor(graph) {
                this.graph = graph;
            }
            
            calculateCircuit() {
                if (!systemPower) {
                    this.powerOffAllComponents();
                    return;
                }
                
                const powerSource = this.findPowerSource();
                if (!powerSource) {
                    console.log('‚ùå Keine Stromquelle gefunden');
                    return;
                }
                
                const connectedComponents = this.graph.getConnectedComponents(powerSource);
                
                this.calculateVoltagesAndCurrents(connectedComponents);
            }
            
            findPowerSource() {
                for (const [id, component] of this.graph.nodes) {
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        return id;
                    }
                }
                return null;
            }
            
            calculateVoltagesAndCurrents(components) {
                for (const componentId of components) {
                    const component = this.graph.nodes.get(componentId);
                    const stateMachine = this.graph.stateMachines.get(componentId);
                    
                    if (!component || !stateMachine) continue;
                    
                    // üîç ERST: Unvollst√§ndige Schaltung pr√ºfen (falsche Polarit√§t = unvollst√§ndig)
                    if (!this.isComponentProperlyConnected(componentId)) {
                        console.log(`‚ö†Ô∏è ${componentId} nicht vollst√§ndig angeschlossen - bleibt AUS`);
                        stateMachine.updateState(0, 0);
                        continue;
                    }
                    
                    // üîç DANN: Gef√§hrliche Verbindungen pr√ºfen (nur bei vollst√§ndigen Schaltungen)
                    const dangerousCondition = this.checkForDangerousConditions(componentId);
                    if (dangerousCondition) {
                        console.log(`üí• ${componentId} BESCH√ÑDIGT durch: ${dangerousCondition}`);
                        stateMachine.setState(ComponentStates.BROKEN);
                        continue;
                    }
                    
                    let voltage = 0;
                    let current = 0;
                    
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        voltage = ComponentSpecs[component.type].voltage;
                        current = this.calculateSourceCurrent(componentId);
                    } else if (ComponentSpecs[component.type].type === 'transformer') {
                        // üîç TRAFO: Nur funktionsf√§hig wenn Input UND Output korrekt angeschlossen
                        if (this.hasValidTransformerConnections(componentId)) {
                            voltage = ComponentSpecs[component.type].inputVoltage;
                            current = this.calculateTransformerCurrent(componentId);
                        } else {
                            console.log(`‚ö†Ô∏è Trafo ${componentId} hat ung√ºltige Verbindungen`);
                            voltage = 0;
                            current = 0;
                        }
                    } else {
                        const result = this.calculateComponentPower(componentId);
                        voltage = result.voltage;
                        current = result.current;
                    }
                    
                    stateMachine.updateState(voltage, current);
                }
            }
            
            isComponentProperlyConnected(componentId) {
                // Benutze WorkspaceManager-Validierung wenn verf√ºgbar
                if (window.workspaceManager && window.workspaceManager.isCircuitComplete) {
                    const result = window.workspaceManager.isCircuitComplete(componentId);
                    debugLog(`üîç WorkspaceManager.isCircuitComplete(${componentId}): ${result}`);
                    return result;
                }
                
                // Fallback: Grundlegende Verbindungspr√ºfung
                const component = this.graph.nodes.get(componentId);
                if (!component) return false;
                
                debugLog(`üîç Fallback-Pr√ºfung f√ºr ${componentId}: ${component.connections.size} Verbindungen`);
                
                // Transformer braucht mindestens 2 Verbindungen (Input)
                if (ComponentSpecs[component.type].type === 'transformer') {
                    return component.connections.size >= 2;
                }
                
                // LEDs brauchen mindestens 2 Verbindungen (Plus + Minus)
                if (ComponentSpecs[component.type].type === 'load') {
                    return component.connections.size >= 2;
                }
                
                return true;
            }
            
            hasValidTransformerConnections(transformerId) {
                // Pr√ºfe ob sowohl Input als auch Output korrekt angeschlossen sind
                if (window.workspaceManager && window.workspaceManager.hasRequiredTransformerConnections) {
                    const hasInput = window.workspaceManager.hasRequiredTransformerConnections(transformerId);
                    
                    // Zus√§tzlich: Mindestens 1 Output muss angeschlossen sein
                    const transformer = document.getElementById(transformerId);
                    if (!transformer) return false;
                    
                    const plusOutput = transformer.querySelector('[data-connection-id="out-plus"]');
                    const minusOutput = transformer.querySelector('[data-connection-id="out-minus"]');
                    
                    const hasOutput = window.workspaceManager.hasActiveConnection(plusOutput) || 
                                     window.workspaceManager.hasActiveConnection(minusOutput);
                    
                    debugLog(`üîç Trafo ${transformerId}: Input=${hasInput}, Output=${hasOutput}`);
                    return hasInput && hasOutput;
                }
                
                return true; // Fallback wenn WorkspaceManager nicht verf√ºgbar
            }
            
            checkForDangerousConditions(componentId) {
                const component = this.graph.nodes.get(componentId);
                if (!component) return null;
                
                // Nur LEDs k√∂nnen durch gef√§hrliche Verbindungen besch√§digt werden
                if (ComponentSpecs[component.type].type !== 'load') return null;
                
                debugLog(`üîç checkForDangerousConditions: Pr√ºfe LED ${componentId} auf √úberspannung...`);
                
                // üö® NUR DIREKTE VERBINDUNGEN ZU DIESER LED PR√úFEN
                // Nicht die gesamte Schaltung, sondern nur was direkt an dieser LED anliegt
                const directConnections = this.getDirectConnectionsToLED(componentId);
                
                for (const connectionInfo of directConnections) {
                    const danger = this.analyzeDirectConnectionDanger(connectionInfo, componentId);
                    if (danger) {
                        console.log(`üí• LED ${componentId}: Direkte Gefahr erkannt - ${danger}`);
                        return danger;
                    }
                }
                
                console.log(`‚úÖ LED ${componentId}: Keine direkte Gefahr erkannt`);
                return null;
            }
            
            getDirectConnectionsToLED(ledId) {
                const connections = [];
                
                if (!window.workspaceManager || !window.workspaceManager.connections) return connections;
                
                // Finde alle direkten Verbindungen zu dieser LED
                for (const [connId, connectionData] of window.workspaceManager.connections) {
                    if (connectionData.toComponent === ledId || connectionData.fromComponent === ledId) {
                        const fromData = window.workspaceManager.getConnectionData(connectionData.from);
                        const toData = window.workspaceManager.getConnectionData(connectionData.to);
                        
                        connections.push({
                            fromData,
                            toData,
                            connectionId: connId,
                            isToThisLED: connectionData.toComponent === ledId
                        });
                    }
                }
                
                debugLog(`üîç LED ${ledId}: ${connections.length} direkte Verbindungen gefunden`);
                return connections;
            }
            
            analyzeDirectConnectionDanger(connectionInfo, targetComponentId) {
                const { fromData, toData, isToThisLED } = connectionInfo;
                
                // Nur pr√ºfen wenn diese LED das ZIEL der Verbindung ist
                if (!isToThisLED) return null;
                
                debugLog(`üîç LED ${targetComponentId}: Pr√ºfe Verbindung ${fromData.wireType}(${fromData.voltage}V) ‚Üí ${toData.wireType}(${toData.voltage}V)`);
                
                // 1. √úBERSPANNUNG: 230V an 12V/24V LED
                if (this.isOvervoltage(fromData, toData, targetComponentId)) {
                    return '√úberspannung: 230V an DC-LED';
                }
                
                // 2. FALSCHE POLARIT√ÑT: Macht LED NICHT kaputt, nur funktionslos
                // (Diese Pr√ºfung wurde entfernt - falsche Polarit√§t = kein Schaden)
                
                return null; // Keine anderen Gefahren f√ºr LEDs
            }
            
            analyzeConnectionDanger(edge, targetComponentId) {
                // Hole die tats√§chlichen DOM-Verbindungen f√ºr detaillierte Analyse
                if (!window.workspaceManager || !window.workspaceManager.connections) return null;
                
                for (const [connId, connectionData] of window.workspaceManager.connections) {
                    if ((connectionData.fromComponent === edge.from && connectionData.toComponent === edge.to) ||
                        (connectionData.fromComponent === edge.to && connectionData.toComponent === edge.from)) {
                        
                        const fromData = window.workspaceManager.getConnectionData(connectionData.from);
                        const toData = window.workspaceManager.getConnectionData(connectionData.to);
                        
                        // 1. √úBERSPANNUNG: 230V an 12V/24V LED
                        if (this.isOvervoltage(fromData, toData, targetComponentId)) {
                            return '√úberspannung: 230V an DC-LED';
                        }
                        
                        // 2. FALSCHE POLARIT√ÑT: Macht LED NICHT kaputt, nur funktionslos
                        // (Diese Pr√ºfung wurde entfernt - falsche Polarit√§t = kein Schaden)
                        
                        // 3. KURZSCHLUSS: Direkte Plus-Minus Verbindung
                        if (this.isShortCircuit(fromData, toData)) {
                            return 'Kurzschluss: Plus direkt mit Minus verbunden';
                        }
                    }
                }
                
                return null;
            }
            
            isOvervoltage(fromData, toData, targetComponentId) {
                const targetElement = document.getElementById(targetComponentId);
                if (!targetElement) return false;
                
                const targetType = targetElement.dataset.componentType;
                
                // 230V AC an 12V/24V DC LED = √úberspannung
                if ((targetType === 'led_12v' || targetType === 'led_24v') &&
                    (fromData.voltage === 230 || toData.voltage === 230)) {
                    return true;
                }
                
                // Spannung deutlich √ºber Nennspannung
                const expectedVoltage = targetType === 'led_12v' ? 12 : (targetType === 'led_24v' ? 24 : 0);
                if (expectedVoltage > 0) {
                    const maxVoltage = Math.max(fromData.voltage || 0, toData.voltage || 0);
                    if (maxVoltage > expectedVoltage * 1.5) { // 50% √úberspannung = Schaden
                        return true;
                    }
                }
                
                return false;
            }
            
            isWrongPolarity(fromData, toData, targetComponentId) {
                // FALSCHE POLARIT√ÑT MACHT LED NICHT KAPUTT - nur funktionslos
                // Diese Funktion wird nur f√ºr Referenz behalten, aber nicht f√ºr Sch√§den verwendet
                if ((fromData.wireType === 'plus' && toData.wireType === 'minus') ||
                    (fromData.wireType === 'minus' && toData.wireType === 'plus')) {
                    return true;
                }
                
                return false;
            }
            
            isShortCircuit(fromData, toData) {
                // Direkte Plus-Minus Verbindung ohne Verbraucher
                if ((fromData.wireType === 'plus' && toData.wireType === 'minus') ||
                    (fromData.wireType === 'minus' && toData.wireType === 'plus')) {
                    return true;
                }
                
                return false;
            }
            
            calculateComponentPower(componentId) {
                const component = this.graph.nodes.get(componentId);
                const componentSpecs = ComponentSpecs[component.type];
                
                // KLEMMEN: Spezialbehandlung - sie geben nur weiter, verbrauchen nicht
                if (componentSpecs.type === 'connector') {
                    console.log(`üîÑ Klemme ${componentId}: Durchschaltung - verbraucht 0W`);
                    return { voltage: 0, current: 0 }; // Klemmen verbrauchen nichts
                }
                
                // üö® KAPUTTE KOMPONENTEN bekommen keinen Strom - sind permanent defekt
                const componentState = this.graph.getComponentState(componentId);
                if (componentState === 'broken') {
                    console.log(`üíÄ Komponente ${componentId}: Ist permanent kaputt ‚Üí 0V/0A`);
                    return { voltage: 0, current: 0 };
                }
                
                // NUR F√úR LEDs: Pr√ºfe LED-zu-LED Verbindungen
                if (componentSpecs.type === 'led') {
                    const powerSource = this.findPowerSourceForLED(componentId);
                    if (powerSource) {
                        console.log(`‚úÖ LED ${componentId}: Bekommt ${powerSource.voltage}V √ºber Parallelschaltung von ${powerSource.sourceType} ${powerSource.sourceId}`);
                        return {
                            voltage: powerSource.voltage,
                            current: ComponentSpecs[component.type].power / powerSource.voltage
                        };
                    }
                }
                
                console.log(`‚ö†Ô∏è LED ${componentId}: Keine g√ºltige Spannungsquelle gefunden`);
                return { voltage: 0, current: 0 };
            }
            
            findPowerSourceForLED(ledId, visited = new Set()) {
                // Verhindere Endlosschleifen
                if (visited.has(ledId)) return null;
                visited.add(ledId);
                
                const component = this.graph.nodes.get(ledId);
                if (!component) return null;
                
                debugLog(`üîç findPowerSourceForLED: Analysiere ${ledId}, Verbindungen: ${component.connections.size}`);
                
                // Pr√ºfe alle direkten Verbindungen
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (!connectedComponent) continue;
                    
                    // DIREKTE TRAFO-VERBINDUNG
                    if (ComponentSpecs[connectedComponent.type].type === 'transformer') {
                        const trafoState = this.graph.getComponentState(connectedId);
                        if (this.hasValidTransformerConnections(connectedId) && trafoState !== 'broken') {
                            const specs = ComponentSpecs[connectedComponent.type];
                            console.log(`üîÑ LED ${ledId}: Direkt mit Trafo ${connectedId} verbunden`);
                            return {
                                voltage: specs.outputVoltage,
                                sourceType: 'trafo',
                                sourceId: connectedId
                            };
                        } else {
                            console.log(`‚ö†Ô∏è LED ${ledId}: Verbundener Trafo ${connectedId} ist nicht funktionsf√§hig (State: ${trafoState})`);
                            continue;
                        }
                    }
                    
                    // DIREKTE STROMQUELLEN-VERBINDUNG (GEF√ÑHRLICH!)
                    if (connectedComponent.type === ComponentTypes.POWER_SOURCE) {
                        console.log(`‚ö†Ô∏è LED ${ledId}: Direkt mit 230V Stromquelle verbunden - GEF√ÑHRLICH!`);
                        return {
                            voltage: ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage,
                            sourceType: 'stromquelle',
                            sourceId: connectedId
                        };
                    }
                    
                    // LED-ZU-LED PARALLELSCHALTUNG
                    if (ComponentSpecs[connectedComponent.type].type === 'load') {
                        console.log(`üîó LED ${ledId}: Verbunden mit anderer LED ${connectedId} - pr√ºfe Parallelschaltung`);
                        
                        // BUGFIX: Pr√ºfe erst ob die andere LED vollst√§ndig angeschlossen ist
                        if (!window.workspaceManager.isCircuitComplete(connectedId)) {
                            console.log(`‚ùå LED ${connectedId} ist nicht vollst√§ndig angeschlossen - keine Parallelschaltung m√∂glich`);
                            continue;
                        }
                        
                        // üîß WICHTIG: Pr√ºfe ob die andere LED kaputt ist
                        const otherLEDState = this.graph.getComponentState(connectedId);
                        if (otherLEDState === 'broken') {
                            console.log(`üíÄ LED ${connectedId} ist kaputt - aber Kontakte sind noch verbunden, suche durch sie hindurch`);
                            // üîß SOFORT durch kaputte LED hindurch nach sicheren Quellen suchen!
                            const powerThroughBroken = this.findPowerSourceThroughBrokenLEDs(connectedId, visited);
                            if (powerThroughBroken && powerThroughBroken.sourceType === 'trafo') {
                                console.log(`‚ö° LED ${ledId}: DURCHBRUCH! Sichere ${powerThroughBroken.voltage}V durch kaputte LED ${connectedId}`);
                                return powerThroughBroken;
                            }
                        }
                        
                        // Pr√ºfe ob die andere LED eine g√ºltige UND SICHERE Spannungsquelle hat
                        const otherLEDPower = this.findPowerSourceForLED(connectedId, visited);
                        if (otherLEDPower) {
                            // üö® SICHERHEITSCHECK: Keine gef√§hrlichen Spannungen weiterleiten!
                            if (otherLEDPower.sourceType === 'stromquelle') {
                                console.log(`üö´ LED ${ledId}: Andere LED ${connectedId} hat gef√§hrliche 230V-Quelle - NICHT weiterleiten!`);
                                
                                // üîß ABER: Wenn die andere LED kaputt ist, suche weiter nach sicheren Quellen
                                if (otherLEDState === 'broken') {
                                    console.log(`üîç LED ${ledId}: Kaputte LED ${connectedId} k√∂nnte sichere Quellen dahinter haben - suche weiter`);
                                    continue; // Suche nach weiteren Verbindungen
                                } else {
                                    continue; // Gesunde LED mit gef√§hrlicher Quelle - nicht nutzen
                                }
                            }
                            
                            // Nur sichere Trafo-Quellen weiterleiten
                            if (otherLEDPower.sourceType === 'trafo') {
                                if (otherLEDState === 'broken') {
                                    console.log(`‚ö° LED ${ledId}: Bekommt SICHERE ${otherLEDPower.voltage}V √ºber KAPUTTE LED ${connectedId} (Kontakte leiten weiter)`);
                                } else {
                                    console.log(`‚úÖ LED ${ledId}: Bekommt SICHERE ${otherLEDPower.voltage}V √ºber Parallelschaltung von LED ${connectedId}`);
                                }
                                return otherLEDPower;
                            }
                        } else if (otherLEDState === 'broken') {
                            // üîß WICHTIG: Auch wenn kaputte LED keine eigene Quelle hat, kann sie andere Quellen weiterleiten
                            console.log(`üîç LED ${ledId}: Kaputte LED ${connectedId} hat keine eigene Quelle, aber Kontakte leiten m√∂glicherweise weiter`);
                            // Die Suche wird automatisch bei anderen Verbindungen fortgesetzt
                        }
                    }
                }
                
                // üîß ERWEITERTE SUCHE: Wenn keine direkte Quelle gefunden, suche durch kaputte LEDs hindurch
                console.log(`üîç LED ${ledId}: Keine direkte Quelle gefunden - suche durch kaputte LEDs hindurch`);
                return this.findPowerSourceThroughBrokenLEDs(ledId, visited);
            }
            
            findPowerSourceThroughBrokenLEDs(ledId, visited = new Set()) {
                if (visited.has(ledId)) return null;
                visited.add(ledId);
                
                const component = this.graph.nodes.get(ledId);
                if (!component) return null;
                
                console.log(`üîç findPowerSourceThroughBrokenLEDs: Suche f√ºr ${ledId} durch kaputte LEDs`);
                
                // Gehe durch alle Verbindungen
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (!connectedComponent) continue;
                    
                    // √úberspringe nicht-LEDs
                    if (ComponentSpecs[connectedComponent.type].type !== 'load') continue;
                    
                    const connectedState = this.graph.getComponentState(connectedId);
                    
                    // Nur durch kaputte LEDs suchen (die funktionieren als Leiter)
                    if (connectedState === 'broken') {
                        console.log(`üîç LED ${ledId}: Suche durch kaputte LED ${connectedId} hindurch`);
                        
                        // Rekursiv durch die kaputte LED hindurch suchen
                        const powerThroughBroken = this.findPowerSourceThroughBrokenLEDs(connectedId, visited);
                        if (powerThroughBroken && powerThroughBroken.sourceType === 'trafo') {
                            console.log(`‚ö° LED ${ledId}: Gefunden! Sichere ${powerThroughBroken.voltage}V durch kaputte LED ${connectedId}`);
                            return powerThroughBroken;
                        }
                        
                        // Auch direkte Trafo-Verbindungen der kaputten LED pr√ºfen
                        const directPower = this.findDirectTrafoConnection(connectedId);
                        if (directPower) {
                            console.log(`‚ö° LED ${ledId}: Direkter Trafo durch kaputte LED ${connectedId} gefunden`);
                            return directPower;
                        }
                    }
                }
                
                return null;
            }
            
            findDirectTrafoConnection(ledId) {
                const component = this.graph.nodes.get(ledId);
                if (!component) return null;
                
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (!connectedComponent) continue;
                    
                    // Direkte Trafo-Verbindung
                    if (ComponentSpecs[connectedComponent.type].type === 'transformer') {
                        const trafoState = this.graph.getComponentState(connectedId);
                        if (this.hasValidTransformerConnections(connectedId) && trafoState !== 'broken') {
                            const specs = ComponentSpecs[connectedComponent.type];
                            return {
                                voltage: specs.outputVoltage,
                                sourceType: 'trafo',
                                sourceId: connectedId
                            };
                        }
                    }
                }
                
                return null;
            }
            
            calculateSourceCurrent(sourceId) {
                let totalCurrent = 0;
                const connectedComponents = this.graph.getConnectedComponents(sourceId);
                
                for (const componentId of connectedComponents) {
                    const component = this.graph.nodes.get(componentId);
                    if (component && ComponentSpecs[component.type].type === 'load') {
                        const specs = ComponentSpecs[component.type];
                        totalCurrent += specs.power / ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage;
                    }
                }
                
                return totalCurrent;
            }
            
            calculateTransformerCurrent(transformerId) {
                const transformer = this.graph.nodes.get(transformerId);
                const specs = ComponentSpecs[transformer.type];
                
                // üîç NEUE LEISTUNGSBERECHNUNG: Alle LEDs im Parallelschaltungs-Netzwerk
                const totalPower = this.calculateTotalLoadOnTransformer(transformerId);
                
                console.log(`‚ö° Trafo ${transformerId}: Gesamtlast = ${totalPower.toFixed(2)}W / ${specs.maxPower}W (${(totalPower/specs.maxPower*100).toFixed(1)}%)`);
                
                // üö® √úBERLASTUNGSCHECK
                if (totalPower > specs.maxPower) {
                    console.log(`üí• √úBERLASTUNG! Trafo ${transformerId}: ${totalPower.toFixed(2)}W > ${specs.maxPower}W`);
                    this.graph.setComponentState(transformerId, 'broken');
                    return 0; // Trafo schaltet ab
                }
                
                // Eingangsstrom = Ausgangsstrom / Effizienz
                const efficiency = 0.87; // 87% Effizienz f√ºr Trafos
                const inputCurrent = (totalPower / efficiency) / specs.inputVoltage;
                
                return inputCurrent;
            }
            
            calculateTotalLoadOnTransformer(transformerId) {
                const allLEDs = this.getAllLEDsConnectedToTransformer(transformerId);
                let totalPower = 0;
                
                debugLog(`üîç Trafo ${transformerId}: Analysiere ${allLEDs.length} angeschlossene LEDs`);
                
                for (const ledId of allLEDs) {
                    const ledComponent = this.graph.nodes.get(ledId);
                    if (ledComponent && this.isComponentProperlyConnected(ledId)) {
                        const ledPower = ComponentSpecs[ledComponent.type].power;
                        totalPower += ledPower;
                        console.log(`üí° LED ${ledId}: +${ledPower}W (Gesamt: ${totalPower.toFixed(2)}W)`);
                    }
                }
                
                return totalPower;
            }
            
            getAllLEDsConnectedToTransformer(transformerId, visited = new Set()) {
                const connectedLEDs = [];
                
                // Verhindere Endlosschleifen
                if (visited.has(transformerId)) return connectedLEDs;
                visited.add(transformerId);
                
                // Finde alle LEDs die direkt oder indirekt mit diesem Trafo verbunden sind
                this.findLEDsRecursive(transformerId, connectedLEDs, new Set());
                
                return connectedLEDs;
            }
            
            findLEDsRecursive(componentId, foundLEDs, visited) {
                if (visited.has(componentId)) return;
                visited.add(componentId);
                
                const component = this.graph.nodes.get(componentId);
                if (!component) return;
                
                // Wenn es eine LED ist, f√ºge sie zur Liste hinzu
                if (ComponentSpecs[component.type].type === 'load') {
                    if (!foundLEDs.includes(componentId)) {
                        foundLEDs.push(componentId);
                    }
                }
                
                // Durchsuche alle Verbindungen rekursiv
                for (const connectedId of component.connections) {
                    this.findLEDsRecursive(connectedId, foundLEDs, visited);
                }
            }
            
            setTransformerOverloaded(transformerId) {
                const stateMachine = this.graph.stateMachines.get(transformerId);
                if (stateMachine) {
                    stateMachine.setState(ComponentStates.BROKEN);
                    console.log(`üí• Trafo ${transformerId}: Auf BROKEN gesetzt wegen √úberlastung`);
                }
            }
            
            powerOffAllComponents() {
                for (const [id, stateMachine] of this.graph.stateMachines) {
                    stateMachine.updateState(0, 0);
                }
            }
        }

        // ===== REALTIME SIMULATION =====
        class RealtimeSimulation {
            constructor() {
                this.graph = new CircuitGraph();
                this.physics = new PhysicsEngine(this.graph);
                this.isRunning = false;
            }
            
            start() {
                this.isRunning = true;
                console.log('üîÑ Echtzeit-Simulation gestartet');
            }
            
            stop() {
                this.isRunning = false;
                console.log('‚è∏Ô∏è Echtzeit-Simulation gestoppt');
            }
            
            update() {
                if (!this.isRunning) return;
                this.physics.calculateCircuit();
            }
            
            addComponent(id, type, position) {
                this.graph.addComponent(id, type, position);
                this.update();
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.graph.addConnection(id, fromComponent, toComponent);
                this.update();
            }
            
            powerStateChanged() {
                console.log(`‚ö° Hauptschalter: ${systemPower ? 'EIN' : 'AUS'}`);
                this.update();
            }
        }

        // Export f√ºr globalen Zugriff
        let circuit = null;

        console.log('üî¨ Circuit Simulation Engine geladen');

        // ===== COMPONENT LIBRARY =====

        // Datenblatt-Informationen f√ºr Bauteile
        const DatasheetInfo = {
            'fi-schalter': {
                name: 'FI-Schutzschalter',
                specs: 'Nennstrom: 16A<br>Ausl√∂sestrom: 30mA<br>Schutzart: IP20<br>Einbauart: Hutschiene',
                description: 'Schutz vor Fehlerstrom durch defekte Ger√§te oder Ber√ºhrung spannungsf√ºhrender Teile.'
            },
            'ls-schalter': {
                name: 'LS-Schalter',
                specs: 'Nennstrom: 16A<br>Charakteristik: B<br>Ausl√∂sezeit: < 0,1s<br>Schutzart: IP20',
                description: 'Schutz vor √úberlast und Kurzschluss in elektrischen Anlagen.'
            },
            'trafo-12v-40w': {
                name: 'Trafo 12V',
                specs: 'Eingang: 230V AC<br>Ausgang: 12V DC<br>Leistung: 40W<br>Wirkungsgrad: >85%',
                description: 'Elektronischer Transformator f√ºr LED-Beleuchtung mit 12V Ausgangsspannung.'
            },
            'trafo-24v-60w': {
                name: 'Trafo 24V',
                specs: 'Eingang: 230V AC<br>Ausgang: 24V DC<br>Leistung: 60W<br>Wirkungsgrad: >85%',
                description: 'Elektronischer Transformator f√ºr LED-Beleuchtung mit 24V Ausgangsspannung.'
            },
            'led-12v-1.2w': {
                name: 'LED-Modul 12V-1,2W-WW',
                specs: 'Spannung: 12V DC<br>Leistung: 1,2W<br>Lichtstrom: 120lm<br>Farbtemperatur: 3000K',
                description: 'Kompaktes LED-Modul mit drei LEDs f√ºr Niedervolt-Beleuchtungsanlagen.'
            },
            'led-12v-3.5w': {
                name: 'LED-Modul 12V',
                specs: 'Spannung: 12V DC<br>Leistung: 3,5W<br>Lichtstrom: 350lm<br>Farbtemperatur: 3000K',
                description: 'Warmwei√ües LED-Modul f√ºr Niedervolt-Beleuchtungsanlagen.'
            },
            'led-24v-5w': {
                name: 'LED-Modul 24V',
                specs: 'Spannung: 24V DC<br>Leistung: 5W<br>Lichtstrom: 500lm<br>Farbtemperatur: 3000K',
                description: 'Warmwei√ües LED-Modul f√ºr Niedervolt-Beleuchtungsanlagen.'
            },
            'zeitschaltuhr': {
                name: 'Zeitschaltuhr',
                specs: 'Spannung: 230V AC<br>Schaltleistung: 16A<br>Programme: 20<br>Gangreserve: 100h',
                description: 'Digitale Zeitschaltuhr f√ºr automatische Schaltung von Beleuchtung.'
            },
            'daemmerungsschalter': {
                name: 'D√§mmerungsschalter',
                specs: 'Spannung: 230V AC<br>Schaltleistung: 10A<br>Einstellbereich: 2-200 Lux<br>Verz√∂gerung: 30s',
                description: 'Automatischer Schalter basierend auf Umgebungshelligkeit.'
            },
            'kabel-flexibel-sw': {
                name: 'Flexibles Kabel sw',
                specs: 'Kabelquerschnitt: 1 mm¬≤<br>Maximalleistung: 100 W<br>Spannung: bis 24V<br>Farbe: Schwarz',
                description: 'Flexibles schwarzes Kabel f√ºr LED Installationen bis 24V.'
            },
            'klemme-mobil-3l': {
                name: 'Mobile Klemme 3L',
                specs: 'Leiterquerschnitt: 0,08-2,5 mm¬≤<br>Bemessungsspannung: 400 V<br>Bemessungsstrom: 32 A<br>Leiterarten: alle',
                description: '3-Leiterverbindungsklemme mit Bet√§tigungshebeln.'
            },
            'dev-placeholder': {
                name: 'Entwickler-Platzhalter',
                specs: 'Status: In Entwicklung<br>Typ: Noch nicht definiert<br>Funktion: Platzhalter<br>Verf√ºgbarkeit: Zuk√ºnftig',
                description: 'Platzhalter f√ºr zuk√ºnftige Bauteile und Entwicklungen.'
            }
        };

        console.log('üì¶ Component Library geladen');

        // ===== WORKSPACE MANAGER =====

        class WorkspaceManager {
            constructor() {
                this.setupEventDelegation();
                this.selectedComponents = new Set();
                this.isDraggingComponents = false;
                this.dragStartPos = null;
                this.componentStartPositions = new Map();
                this.componentRotations = new Map();
                this.isDrawingSelection = false;
                this.selectionStart = null;
                this.selectionRectangle = null;
                this.justFinishedRectangleSelection = false;
                
                // Connection System
                this.activeConnection = null;
                this.tempConnectionLine = null;
                this.connections = new Map();
                
                console.log('üéØ WorkspaceManager initialisiert');
            }
            
            setupEventDelegation() {
                const workspace = document.getElementById('workspace');
                
                workspace.addEventListener('mousedown', this.handleMouseDown.bind(this));
                workspace.addEventListener('mousemove', this.handleMouseMove.bind(this));
                workspace.addEventListener('mouseup', this.handleMouseUp.bind(this));
                workspace.addEventListener('click', this.handleClick.bind(this));
                workspace.addEventListener('dblclick', this.handleDblClick.bind(this));
                
                this.setupKeyboardEvents();
                
                console.log('‚úÖ Event-Delegierung eingerichtet');
            }
            
            setupKeyboardEvents() {
                document.removeEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                
                const workspace = document.getElementById('workspace');
                workspace.setAttribute('tabindex', '0');
                workspace.style.outline = 'none';
                
                workspace.addEventListener('mousedown', () => {
                    workspace.focus();
                });
                
                console.log('‚å®Ô∏è Keyboard Events eingerichtet');
            }
            
            isComponent(element) {
                const component = element.classList.contains('component') || 
                                element.closest('.component');
                
                if (component && component.id === 'power-source-svg') {
                    return false;
                }
                
                return !!component;
            }
            
            getComponent(element) {
                const component = element.classList.contains('component') ? 
                                element : element.closest('.component');
                
                if (component && component.id === 'power-source-svg') {
                    return null;
                }
                
                return component;
            }
            
            // ===== MOUSE EVENT HANDLERS =====
            handleMouseDown(e) {
                if (this.isConnectionPoint(e.target)) {
                    this.handleConnectionMouseDown(e);
                    return;
                }
                
                const component = this.getComponent(e.target);
                
                if (component) {
                    console.log('üñ±Ô∏è MouseDown auf Bauteil:', component.dataset.componentType);
                    
                    if (!this.selectedComponents.has(component)) {
                        if (!e.ctrlKey) {
                            this.selectSingle(component);
                        } else {
                            this.toggleSelection(component);
                        }
                    }
                    
                    this.startDragging(e);
                    e.preventDefault();
                } else {
                    console.log('üñ±Ô∏è MouseDown auf leere Fl√§che');
                    this.startRectangleSelection(e);
                }
            }
            
            handleMouseMove(e) {
                if (this.activeConnection) {
                    this.updateConnectionLine(e);
                    return;
                }
                
                if (this.isDraggingComponents) {
                    this.updateDragging(e);
                } else if (this.isDrawingSelection) {
                    this.updateRectangleSelection(e);
                }
            }
            
            handleMouseUp(e) {
                if (this.activeConnection) {
                    this.handleConnectionMouseUp(e);
                    return;
                }
                
                if (this.isDraggingComponents) {
                    this.endDragging(e);
                } else if (this.isDrawingSelection) {
                    this.endRectangleSelection(e);
                }
            }
            
            handleClick(e) {
                if (this.justFinishedRectangleSelection) {
                    this.justFinishedRectangleSelection = false;
                    console.log('üö´ Click nach Rectangle Selection ignoriert');
                    return;
                }
                
                if (this.isDraggingComponents) return;
                
                const component = this.getComponent(e.target);
                
                if (component) {
                    if (e.ctrlKey) {
                        console.log('üéØ Strg+Klick - Multi-Select auf:', component.dataset.componentType);
                        this.toggleSelection(component);
                    } else {
                        console.log('üéØ Klick - Single-Select auf:', component.dataset.componentType);
                        this.selectSingle(component);
                    }
                } else {
                    console.log('üéØ Klick auf leere Fl√§che - Auswahl l√∂schen');
                    this.clearSelection();
                }
            }
            
            handleDblClick(e) {
                const component = this.getComponent(e.target);
                if (component) {
                    console.log('üîÑ Doppelklick - Drehe Bauteil:', component.dataset.componentType);
                    this.rotateComponent(component);
                    e.preventDefault();
                }
            }
            
            handleKeyDown(e) {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    console.log('üóëÔ∏è Delete/Backspace-Taste - L√∂sche ausgew√§hlte Bauteile');
                    this.deleteSelectedComponents();
                    e.preventDefault();
                } else if (e.key === 'Escape') {
                    console.log('üö´ Escape - Alle Auswahlen aufheben');
                    this.clearSelection();
                }
            }
            
            // ===== DRAG & DROP SYSTEM =====
            startDragging(e) {
                // üö® SICHERHEITSPR√úFUNG: Kein Bewegen bei eingeschaltetem Strom
                if (!checkElectricalSafety(e, "Bauteile bewegen")) {
                    return;
                }
                
                this.isDraggingComponents = true;
                this.dragStartPos = { x: e.clientX, y: e.clientY };
                
                this.componentStartPositions.clear();
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                
                this.selectedComponents.forEach(component => {
                    const currentLeft = parseFloat(component.style.left) || 0;
                    const currentTop = parseFloat(component.style.top) || 0;
                    
                    const mouseX = e.clientX - workspaceRect.left;
                    const mouseY = e.clientY - workspaceRect.top;
                    const mouseOffsetX = mouseX - currentLeft;
                    const mouseOffsetY = mouseY - currentTop;
                    
                    this.componentStartPositions.set(component, {
                        x: currentLeft,
                        y: currentTop,
                        mouseOffsetX: mouseOffsetX,
                        mouseOffsetY: mouseOffsetY
                    });
                    
                    component.classList.add('dragging');
                });
                
                console.log('üöÄ Drag gestartet f√ºr', this.selectedComponents.size, 'Bauteile');
            }
            
            updateDragging(e) {
                if (!this.isDraggingComponents) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = e.clientX - workspaceRect.left;
                const mouseY = e.clientY - workspaceRect.top;
                
                this.selectedComponents.forEach((component) => {
                    const startData = this.componentStartPositions.get(component);
                    if (startData) {
                        const newLeft = mouseX - startData.mouseOffsetX;
                        const newTop = mouseY - startData.mouseOffsetY;
                        
                        component.style.left = newLeft + 'px';
                        component.style.top = newTop + 'px';
                        
                        try {
                            this.updateConnectionsForComponent(component);
                        } catch (error) {
                            console.log('‚ö†Ô∏è Fehler beim Connection-Update:', error.message);
                        }
                    }
                });
            }
            
            endDragging(e) {
                this.isDraggingComponents = false;
                this.dragStartPos = null;
                this.componentStartPositions.clear();
                
                this.selectedComponents.forEach(component => {
                    component.classList.remove('dragging');
                });
                
                console.log('üéØ Drag beendet');
            }
            
            // ===== SELECTION SYSTEM =====
            selectSingle(component) {
                this.clearSelection();
                this.selectedComponents.add(component);
                component.classList.add('selected');
                console.log('‚úÖ Ausgew√§hlt:', component.id);
            }
            
            toggleSelection(component) {
                if (this.selectedComponents.has(component)) {
                    this.selectedComponents.delete(component);
                    component.classList.remove('selected');
                    console.log('‚ûñ Abgew√§hlt:', component.id);
                } else {
                    this.selectedComponents.add(component);
                    component.classList.add('selected');
                    console.log('‚ûï Hinzugef√ºgt:', component.id);
                }
            }
            
            clearSelection() {
                this.selectedComponents.forEach(component => {
                    component.classList.remove('selected');
                });
                this.selectedComponents.clear();
                console.log('üßπ Auswahl geleert');
            }
            
            // ===== ROTATION SYSTEM =====
            rotateComponent(component) {
                let currentRotation = this.componentRotations.get(component) || 0;
                currentRotation = (currentRotation + 90) % 360;
                this.componentRotations.set(component, currentRotation);
                component.style.transform = `rotate(${currentRotation}deg)`;
                
                // Verbindungen sofort nach Rotation aktualisieren
                this.updateConnectionsForComponent(component);
                

                
                console.log(`üîÑ Bauteil ${component.id} gedreht auf ${currentRotation}¬∞`);
            }
            
            updateSmokeForComponent(component) {
                debugLog(`üîç updateSmokeForComponent aufgerufen f√ºr ${component.id}`);
                const stateMachine = window.circuitGraph?.stateMachines?.get(component.id);
                debugLog(`üîç StateMachine gefunden: ${!!stateMachine}, SmokeOverlay: ${!!stateMachine?.smokeOverlay}`);
                if (stateMachine && stateMachine.smokeOverlay) {
                    stateMachine.updateSmokePosition();
                    console.log(`üí® Rauch-Position synchronisiert f√ºr ${component.id}`);
                } else {
                    console.log(`‚ö†Ô∏è Kein Rauch-Update m√∂glich f√ºr ${component.id}`);
                }
            }
            
            // ===== DELETION SYSTEM =====
            deleteSelectedComponents() {
                // üö® SICHERHEITSPR√úFUNG: Kein L√∂schen bei eingeschaltetem Strom
                if (systemPower) {
                    triggerElectricalDanger(null, "Niemals Bauteile bei eingeschaltetem Strom entfernen!");
                    return;
                }
                
                if (this.selectedComponents.size === 0) {
                    console.log('‚ö†Ô∏è Keine Bauteile zum L√∂schen ausgew√§hlt');
                    return;
                }
                
                const deletedComponents = [];
                
                this.selectedComponents.forEach(component => {
                    const componentId = component.id;
                    const componentType = component.dataset.componentType;
                    
                    component.remove();
                    this.componentRotations.delete(component);
                    
                    if (circuit && circuit.graph && circuit.graph.nodes.has(componentId)) {
                        circuit.graph.nodes.delete(componentId);
                        circuit.graph.stateMachines.delete(componentId);
                        // CLEANUP: Component State l√∂schen
                        circuit.graph.componentStates.delete(componentId);
                        console.log(`üßπ Component State f√ºr ${componentId} gel√∂scht`);
                    }
                    
                    deletedComponents.push(`${componentType} (${componentId})`);
                });
                
                this.selectedComponents.clear();
                console.log(`üóëÔ∏è ${deletedComponents.length} Bauteile gel√∂scht:`, deletedComponents);
            }
            
            // ===== RECTANGLE SELECTION SYSTEM =====
            startRectangleSelection(e) {
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                
                this.isDrawingSelection = true;
                this.selectionStart = {
                    x: e.clientX - workspaceRect.left,
                    y: e.clientY - workspaceRect.top
                };
                
                if (!e.ctrlKey) {
                    this.clearSelection();
                }
                
                this.createSelectionRectangle();
                console.log('üìê Rectangle Selection gestartet');
                e.preventDefault();
            }
            
            createSelectionRectangle() {
                this.selectionRectangle = document.createElement('div');
                this.selectionRectangle.className = 'selection-rectangle';
                this.selectionRectangle.style.position = 'absolute';
                this.selectionRectangle.style.border = '2px dashed #4CAF50';
                this.selectionRectangle.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                this.selectionRectangle.style.pointerEvents = 'none';
                this.selectionRectangle.style.zIndex = '999';
                
                document.getElementById('workspace').appendChild(this.selectionRectangle);
            }
            
            updateRectangleSelection(e) {
                if (!this.isDrawingSelection || !this.selectionRectangle) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const currentX = e.clientX - workspaceRect.left;
                const currentY = e.clientY - workspaceRect.top;
                
                const left = Math.min(this.selectionStart.x, currentX);
                const top = Math.min(this.selectionStart.y, currentY);
                const width = Math.abs(currentX - this.selectionStart.x);
                const height = Math.abs(currentY - this.selectionStart.y);
                
                this.selectionRectangle.style.left = left + 'px';
                this.selectionRectangle.style.top = top + 'px';
                this.selectionRectangle.style.width = width + 'px';
                this.selectionRectangle.style.height = height + 'px';
            }
            
            endRectangleSelection(e) {
                if (!this.isDrawingSelection) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const currentX = e.clientX - workspaceRect.left;
                const currentY = e.clientY - workspaceRect.top;
                
                const selectionRect = {
                    left: Math.min(this.selectionStart.x, currentX),
                    top: Math.min(this.selectionStart.y, currentY),
                    right: Math.max(this.selectionStart.x, currentX),
                    bottom: Math.max(this.selectionStart.y, currentY)
                };
                
                const components = document.querySelectorAll('.component:not(#power-source-svg)');
                let selectedCount = 0;
                
                components.forEach(component => {
                    const left = parseInt(component.style.left) || 0;
                    const top = parseInt(component.style.top) || 0;
                    const width = component.offsetWidth;
                    const height = component.offsetHeight;
                    
                    const componentRect = {
                        left: left,
                        top: top,
                        right: left + width,
                        bottom: top + height
                    };
                    
                    if (selectionRect.left < componentRect.right &&
                        selectionRect.right > componentRect.left &&
                        selectionRect.top < componentRect.bottom &&
                        selectionRect.bottom > componentRect.top) {
                        
                        this.selectedComponents.add(component);
                        component.classList.add('selected');
                        selectedCount++;
                    }
                });
                
                this.isDrawingSelection = false;
                this.selectionStart = null;
                this.justFinishedRectangleSelection = true;
                
                if (this.selectionRectangle) {
                    this.selectionRectangle.remove();
                    this.selectionRectangle = null;
                }
                
                console.log(`üìê Rectangle Selection beendet: ${selectedCount} Bauteile ausgew√§hlt`);
            }
            
            // ===== CONNECTION SYSTEM =====
            isConnectionPoint(element) {
                return element.classList.contains('connection-line') || 
                       element.classList.contains('connection-socket') ||
                       element.classList.contains('connection-area');
            }
            
            handleConnectionMouseDown(e) {
                if (e.target.classList.contains('connection-line') && 
                    e.target.dataset.connectionType === 'output-line') {
                    
                    // üö® SICHERHEITSPR√úFUNG: Keine Verkabelung bei eingeschaltetem Strom
                    if (!checkElectricalSafety(e, "Kabel anschlie√üen")) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.startConnection(e.target, e);
                }
            }
            
            startConnection(outputLine, event) {
                const componentElement = outputLine.closest('.component');
                const componentId = componentElement ? componentElement.id : 'power-source-svg';
                
                this.activeConnection = {
                    outputLine: outputLine,
                    componentId: componentId,
                    outputData: this.getConnectionData(outputLine),
                    startPos: this.getConnectionPosition(outputLine, componentElement)
                };
                
                this.createTempConnectionLine(event);
                
                console.log('üöÄ Verbindung gestartet:', this.activeConnection.outputData);
            }
            
            createTempConnectionLine(event) {
                const svg = document.getElementById('connectionSvg');
                this.tempConnectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                
                this.tempConnectionLine.setAttribute('class', 'temp-connection');
                this.tempConnectionLine.setAttribute('stroke', this.getWireColor(this.activeConnection.outputData.wireType));
                this.tempConnectionLine.setAttribute('stroke-width', '3');
                this.tempConnectionLine.setAttribute('stroke-dasharray', '5,5');
                this.tempConnectionLine.setAttribute('opacity', '0.8');
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = event.clientX - workspaceRect.left;
                const mouseY = event.clientY - workspaceRect.top;
                
                this.tempConnectionLine.setAttribute('x1', this.activeConnection.startPos.x);
                this.tempConnectionLine.setAttribute('y1', this.activeConnection.startPos.y);
                this.tempConnectionLine.setAttribute('x2', mouseX);
                this.tempConnectionLine.setAttribute('y2', mouseY);
                
                svg.appendChild(this.tempConnectionLine);
            }
            
            updateConnectionLine(e) {
                if (!this.tempConnectionLine) return;
                
                const workspaceRect = document.getElementById('workspace').getBoundingClientRect();
                const mouseX = e.clientX - workspaceRect.left;
                const mouseY = e.clientY - workspaceRect.top;
                
                this.tempConnectionLine.setAttribute('x2', mouseX);
                this.tempConnectionLine.setAttribute('y2', mouseY);
            }
            
            handleConnectionMouseUp(e) {
                if (e.target.classList.contains('connection-socket') && 
                    (e.target.dataset.connectionType === 'input-socket' || 
                     e.target.dataset.connectionType === 'terminal-socket' ||
                     e.target.dataset.connectionType === 'bidirectional-socket')) {
                    
                    this.completeConnection(e.target);
                } else {
                    this.cancelConnection();
                }
            }
            
            completeConnection(inputSocket) {
                const targetComponent = inputSocket.closest('.component');
                const targetComponentId = targetComponent ? targetComponent.id : 'unknown';
                const inputData = this.getConnectionData(inputSocket);
                
                // GEF√ÑHRLICHE VERBINDUNGEN ERLAUBEN ABER WARNEN
                const validation = this.validateConnection(this.activeConnection.outputLine, inputSocket);
                if (!validation.valid) {
                    console.log('‚ö†Ô∏è Gef√§hrliche Verbindung wird erstellt:', validation.reason);
                    // KEINE Blockierung - Verbindung wird trotzdem erstellt!
                }
                
                console.log('‚úÖ Verbindung erfolgreich:', 
                    `${this.activeConnection.componentId}.${this.activeConnection.outputData.id}`, 
                    '‚Üí', 
                    `${targetComponentId}.${inputData.id}`);
                
                this.createBezierConnection(this.activeConnection.outputLine, inputSocket, targetComponent);
                this.cancelConnection();
                
                // Nach der Verbindung: Physik neu berechnen
                if (circuit) {
                    setTimeout(() => {
                        circuit.physics.calculateCircuit();
                    }, 100);
                }
            }
            
            createBezierConnection(outputLine, inputSocket, targetComponent) {
                const svg = document.getElementById('connectionSvg');
                const connectionId = `conn-${Date.now()}`;
                
                const startPos = this.getConnectionPosition(outputLine, outputLine.closest('.component'));
                const endPos = this.getConnectionPosition(inputSocket, targetComponent);
                
                // Dynamische Bezier-Berechnung mit Rotation
                const { cp1X, cp1Y, cp2X, cp2Y } = this.calculateRotatedBezierPoints(
                    startPos, endPos, outputLine, inputSocket, 
                    outputLine.closest('.component') || document.getElementById('power-source-svg'), 
                    targetComponent
                );
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M ${startPos.x},${startPos.y} C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${endPos.x},${endPos.y}`;
                
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'bezier-connection');
                path.setAttribute('stroke', this.getWireColor(this.activeConnection.outputData.wireType));
                path.setAttribute('stroke-width', '4');
                path.setAttribute('fill', 'none');
                path.setAttribute('id', connectionId);
                path.setAttribute('data-from-component', this.activeConnection.componentId);
                path.setAttribute('data-to-component', targetComponent ? targetComponent.id : 'unknown');
                path.setAttribute('data-from-connection', this.activeConnection.outputData.id);
                path.setAttribute('data-to-connection', this.getConnectionData(inputSocket).id);
                
                path.addEventListener('click', (e) => {
                    console.log('üîó Click auf Verbindung:', connectionId);
                    e.preventDefault();
                    e.stopPropagation();
                    this.deleteConnection(path);
                });
                
                svg.appendChild(path);
                
                // Verbindung in der Physik-Engine registrieren
                if (circuit) {
                    circuit.addConnection(connectionId, 
                        this.activeConnection.componentId, 
                        targetComponent ? targetComponent.id : 'unknown'
                    );
                }
                
                this.connections.set(connectionId, {
                    path: path,
                    from: outputLine,
                    to: inputSocket,
                    fromComponent: this.activeConnection.componentId,
                    toComponent: targetComponent ? targetComponent.id : 'unknown'
                });
                
                // Connection Points als "connected" markieren
                outputLine.classList.add('connected');
                inputSocket.classList.add('connected');
                
                // Visual Cable f√ºr spezifische Connection Points verstecken
                this.updateVisualCables(outputLine);
                this.updateVisualCables(inputSocket);
                
                console.log('üîó Bezier-Verbindung erstellt:', connectionId);
            }
            
            updateVisualCables(connectionPoint) {
                // Visual Cables nur bei INPUT-Sockets verstecken, nicht bei OUTPUT-Lines
                const connectionType = connectionPoint.getAttribute('data-connection-type');
                if (connectionType !== 'input-socket') return;  // Nur Input-Sockets brauchen Visual Cable Hiding
                
                const component = connectionPoint.closest('.component');
                if (!component) return;
                
                const wireType = connectionPoint.getAttribute('data-wire-type');
                const isConnected = connectionPoint.classList.contains('connected');
                
                // Spezifisches Visual Cable finden und steuern
                const visualCable = component.querySelector(`.visual-cable-${wireType}`);
                if (visualCable) {
                    if (isConnected) {
                        visualCable.style.opacity = '0';
                    } else {
                        visualCable.style.opacity = '1';
                    }
                }
            }
            
            deleteConnection(path) {
                // üö® SICHERHEITSPR√úFUNG: Keine Verbindung bei eingeschaltetem Strom l√∂schen
                if (systemPower) {
                    triggerElectricalDanger(null, "Niemals Kabel bei eingeschaltetem Strom entfernen!");
                    return;
                }
                
                const connectionId = path.id;
                const connection = this.connections.get(connectionId);
                
                // Connection Points wieder als "available" markieren
                if (connection) {
                    connection.from.classList.remove('connected');
                    connection.to.classList.remove('connected');
                    
                    // Visual Cable f√ºr spezifische Connection Points wieder anzeigen
                    this.updateVisualCables(connection.from);
                    this.updateVisualCables(connection.to);
                }
                
                path.remove();
                this.connections.delete(connectionId);
                console.log('üóëÔ∏è Verbindung gel√∂scht:', connectionId);
            }
            
            cancelConnection() {
                if (this.tempConnectionLine) {
                    this.tempConnectionLine.remove();
                    this.tempConnectionLine = null;
                }
                
                if (this.activeConnection) {
                    console.log('‚ùå Verbindung abgebrochen');
                    this.activeConnection = null;
                }
            }
            
            // ===== VERBINDUNGS-VALIDIERUNG =====
            validateConnection(outputElement, inputElement) {
                const outputData = this.getConnectionData(outputElement);
                const inputData = this.getConnectionData(inputElement);
                
                console.log('üîç Validiere Verbindung:', outputData, '‚Üí', inputData);
                
                // 1. KABEL-TYP KOMPATIBILIT√ÑT
                if (!this.areWireTypesCompatible(outputData.wireType, inputData.wireType)) {
                    console.log('‚ùå Inkompatible Kabeltypen:', outputData.wireType, '‚â†', inputData.wireType);
                    return { valid: false, reason: `Kabeltypen inkompatibel: ${outputData.wireType} ‚â† ${inputData.wireType}` };
                }
                
                // 2. SPANNUNGS-KOMPATIBILIT√ÑT  
                if (!this.areVoltagesCompatible(outputData.voltage, inputData.voltage)) {
                    console.log('‚ùå Inkompatible Spannungen:', outputData.voltage, '‚â†', inputData.voltage);
                    return { valid: false, reason: `Spannungen inkompatibel: ${outputData.voltage}V ‚â† ${inputData.voltage}V` };
                }
                
                // 3. KURZSCHLUSS-PR√úFUNG
                if (this.wouldCreateShortCircuit(outputData, inputData)) {
                    console.log('‚ùå Kurzschluss erkannt!');
                    return { valid: false, reason: 'Kurzschluss: Plus und Minus direkt verbunden!' };
                }
                
                console.log('‚úÖ Verbindung ist g√ºltig');
                return { valid: true };
            }
            
            areWireTypesCompatible(outputType, inputType) {
                // Gleiche Typen sind immer kompatibel
                if (outputType === inputType) return true;
                
                // UNIVERSAL-TYP: Klemmen k√∂nnen alle Kabeltypen aufnehmen
                if (inputType === 'universal' || outputType === 'universal') return true;
                
                // AC-Kompatibilit√§t: phase/neutral/earth k√∂nnen teilweise kombiniert werden
                const acTypes = ['phase', 'neutral', 'earth'];
                const dcTypes = ['plus', 'minus'];
                
                // AC zu DC oder DC zu AC ist NICHT kompatibel
                if (acTypes.includes(outputType) && dcTypes.includes(inputType)) return false;
                if (dcTypes.includes(outputType) && acTypes.includes(inputType)) return false;
                
                return true;
            }
            
            areVoltagesCompatible(outputVoltage, inputVoltage) {
                // UNIVERSELLE KLEMMEN: K√∂nnen jede Spannung bis zu ihrer Maximalspannung aufnehmen
                if (inputVoltage >= 400) {
                    // 400V+ Klemmen k√∂nnen alle niedrigeren Spannungen aufnehmen
                    return outputVoltage <= inputVoltage;
                }
                
                // NORMALE BAUTEILE: Spannungen m√ºssen exakt √ºbereinstimmen (¬±5% Toleranz)
                const tolerance = 0.05;
                const minVoltage = inputVoltage * (1 - tolerance);
                const maxVoltage = inputVoltage * (1 + tolerance);
                
                return outputVoltage >= minVoltage && outputVoltage <= maxVoltage;
            }
            
            wouldCreateShortCircuit(outputData, inputData) {
                // DIREKTE Plus-Minus Verbindung ohne Verbraucher dazwischen  
                // Aber: Plus-Output zu Minus-Input einer LED ist NORMAL, kein Kurzschluss!
                // Nur direkte Kabel-zu-Kabel Verbindungen sind Kurzschl√ºsse
                
                // AUSNAHME: Transformator-Eing√§nge sind KEINE Kurzschl√ºsse!
                const inputElement = document.querySelector(`[data-connection-id="${inputData.id}"]`);
                const inputComponent = inputElement ? inputElement.closest('[data-component-type]') : null;
                const inputComponentType = inputComponent ? inputComponent.dataset.componentType : '';
                
                // Transformatoren, Klemmen und LEDs d√ºrfen Phase/Neutral empfangen
                if (inputComponentType.includes('trafo') || 
                    inputComponentType.includes('klemme') || 
                    inputComponentType.includes('led')) {
                    return false; // Kein Kurzschluss f√ºr Verbraucher/Transformatoren
                }
                
                // Phase zu Neutral ohne Verbraucher = Kurzschluss  
                if ((outputData.wireType === 'phase' && inputData.wireType === 'neutral') ||
                    (outputData.wireType === 'neutral' && inputData.wireType === 'phase')) {
                    return true;
                }
                
                return false;
            }
            
            isCircuitComplete(componentId) {
                const component = document.getElementById(componentId);
                if (!component) return false;
                
                const componentType = component.dataset.componentType;
                debugLog(`ÔøΩÔøΩ DEBUG isCircuitComplete: ${componentId}, componentType="${componentType}"`);
                
                // TRAFO: Braucht mindestens phase+neutral Eingang UND mindestens 1 Ausgang
                if (componentType === 'trafo-12v-40w' || componentType === 'trafo-24v-60w' || componentType === 'trafo-12v-3w') {
                    debugLog(`üîç isCircuitComplete: Pr√ºfe TRAFO ${componentId}...`);
                    return this.hasRequiredTransformerConnections(componentId);
                }
                
                // LED: Braucht plus UND minus Anschluss
                if (componentType === 'led-12v-1.2w' || componentType === 'led-24v-5w') {
                    debugLog(`üîç isCircuitComplete: Pr√ºfe LED ${componentId}...`);
                    const result = this.hasRequiredLEDConnections(componentId);
                    debugLog(`üîç isCircuitComplete: LED ${componentId} ‚Üí ${result}`);
                    return result;
                }
                
                debugLog(`üîç isCircuitComplete: ${componentId} ist ANDERER TYP ‚Üí true`);
                return true; // Andere Komponenten haben keine speziellen Anforderungen
            }
            
            hasRequiredTransformerConnections(transformerId) {
                const transformer = document.getElementById(transformerId);
                if (!transformer) return false;
                
                // Pr√ºfe Eing√§nge: phase UND neutral m√ºssen verbunden sein
                const phaseInput = transformer.querySelector('[data-connection-id="in-phase"]');
                const neutralInput = transformer.querySelector('[data-connection-id="in-neutral"]');
                
                const hasPhaseConnection = this.hasActiveConnection(phaseInput);
                const hasNeutralConnection = this.hasActiveConnection(neutralInput);
                
                debugLog(`üîç Trafo ${transformerId}: Phase=${hasPhaseConnection}, Neutral=${hasNeutralConnection}`);
                
                return hasPhaseConnection && hasNeutralConnection;
            }
            
            hasRequiredLEDConnections(ledId) {
                debugLog(`ÔøΩÔøΩ DEBUGGING hasRequiredLEDConnections f√ºr ${ledId}`);
                
                const led = document.getElementById(ledId);
                if (!led) {
                    console.log(`‚ùå LED ${ledId}: Element nicht gefunden`);
                    return false;
                }
                
                // Pr√ºfe: plus UND minus m√ºssen verbunden sein (BIDIREKTIONAL!)
                // Alte IDs: in-plus, in-minus
                // Neue IDs: plus-terminal, minus-terminal
                const plusInput = led.querySelector('[data-connection-id="in-plus"]') || 
                                 led.querySelector('[data-connection-id="plus-terminal"]');
                const minusInput = led.querySelector('[data-connection-id="in-minus"]') || 
                                  led.querySelector('[data-connection-id="minus-terminal"]');
                
                debugLog(`üîç LED ${ledId}: plusInput=${!!plusInput}, minusInput=${!!minusInput}`);
                
                const hasPlusConnection = this.hasActiveConnection(plusInput);
                const hasMinusConnection = this.hasActiveConnection(minusInput);
                
                debugLog(`üîç LED ${ledId}: hasPlusConnection=${hasPlusConnection}, hasMinusConnection=${hasMinusConnection}`);
                
                // ZUS√ÑTZLICH: Pr√ºfe ob Polarit√§t korrekt ist
                const hasCorrectPolarity = this.hasCorrectLEDPolarity(ledId);
                
                debugLog(`üîç LED ${ledId}: hasCorrectPolarity=${hasCorrectPolarity}`);
                
                const isComplete = hasPlusConnection && hasMinusConnection && hasCorrectPolarity;
                
                console.log(`üéØ LED ${ledId}: FINALE BEWERTUNG ‚Üí Plus=${hasPlusConnection} && Minus=${hasMinusConnection} && Polarit√§t=${hasCorrectPolarity} = ${isComplete}`);
                
                return isComplete;
            }
            
            hasCorrectLEDPolarity(ledId) {
                const led = document.getElementById(ledId);
                if (!led) {
                    console.log(`‚ùå LED ${ledId}: Element nicht gefunden`);
                    return false;
                }
                
                // Pr√ºfe alle Verbindungen zu diesem LED via window.workspaceManager
                if (!window.workspaceManager || !window.workspaceManager.connections) {
                    console.log(`‚ùå LED ${ledId}: WorkspaceManager.connections nicht verf√ºgbar`);
                    return false;
                }
                
                debugLog(`üîç LED ${ledId}: Pr√ºfe ${window.workspaceManager.connections.size} Verbindungen auf Polarit√§t`);
                
                // Pr√ºfe alle Verbindungen zu diesem LED
                for (const [connId, connectionData] of window.workspaceManager.connections) {
                    if (connectionData.toComponent === ledId) {
                        const fromData = window.workspaceManager.getConnectionData(connectionData.from);
                        const toData = window.workspaceManager.getConnectionData(connectionData.to);
                        
                        debugLog(`üîç LED ${ledId}: Verbindung ${fromData.wireType} ‚Üí ${toData.wireType}`);
                        
                        // Plus-Ausgang sollte zu Plus-Eingang
                        if (fromData.wireType === 'plus' && toData.wireType === 'minus') {
                            console.log(`‚ùå LED ${ledId}: Plus-Ausgang an Minus-Eingang - falsche Polarit√§t`);
                            return false;
                        }
                        
                        // Minus-Ausgang sollte zu Minus-Eingang  
                        if (fromData.wireType === 'minus' && toData.wireType === 'plus') {
                            console.log(`‚ùå LED ${ledId}: Minus-Ausgang an Plus-Eingang - falsche Polarit√§t`);
                            return false;
                        }
                    }
                }
                
                console.log(`‚úÖ LED ${ledId}: Polarit√§t ist korrekt`);
                return true;
            }
            
            hasActiveConnection(connectionElement) {
                if (!connectionElement) return false;
                
                const connectionId = connectionElement.dataset.connectionId;
                const componentId = connectionElement.closest('.component')?.id;
                
                // Durchsuche alle aktiven Verbindungen
                for (const [connId, connectionData] of this.connections) {
                    // Pr√ºfe ob diese Verbindung zu unserem Anschlusspunkt f√ºhrt
                    if (connectionData.toComponent === componentId && 
                        connectionData.to.dataset.connectionId === connectionId) {
                        return true;
                    }
                    if (connectionData.fromComponent === componentId && 
                        connectionData.from.dataset.connectionId === connectionId) {
                        return true;
                    }
                }
                
                return false;
            }
            
            getConnectionData(element) {
                return {
                    id: element.dataset.connectionId,
                    type: element.dataset.connectionType,
                    wireType: element.dataset.wireType,
                    voltage: parseFloat(element.dataset.voltage)
                };
            }
            
            getConnectionPosition(element, component) {
                // Basis-Position aus data-Attributen lesen (ViewBox-Koordinaten)
                let x = parseFloat(element.dataset.bezierStartX) || parseFloat(element.dataset.bezierEndX) || 0;
                let y = parseFloat(element.dataset.bezierStartY) || parseFloat(element.dataset.bezierEndY) || 0;
                
                // ViewBox-Koordinaten zu DOM-Koordinaten skalieren (auch f√ºr nicht-rotierte Bauteile)
                if (component && component.id !== 'power-source-svg') {
                    const svg = component.querySelector('svg');
                    if (svg) {
                        const svgStyle = window.getComputedStyle(svg);
                        const viewBox = svg.getAttribute('viewBox');
                        if (viewBox) {
                            const viewBoxValues = viewBox.split(' ');
                            const viewBoxWidth = parseFloat(viewBoxValues[2]);
                            const viewBoxHeight = parseFloat(viewBoxValues[3]);
                            
                            // Skalierungsfaktoren mit CSS-Dimensionen (unabh√§ngig von Position)
                            const scaleX = parseFloat(svgStyle.width) / viewBoxWidth;
                            const scaleY = parseFloat(svgStyle.height) / viewBoxHeight;
                            
                            // ViewBox ‚Üí DOM skalieren
                            x = x * scaleX;
                            y = y * scaleY;
                        }
                    }
                }
                
                // Rotation anwenden falls Bauteil rotiert ist
                if (component && component.id !== 'power-source-svg') {
                    const rotation = this.componentRotations.get(component) || 0;
                    if (rotation !== 0) {
                        // DOM-Element-Dimensionen verwenden (wie CSS Transform-Origin)
                        const svg = component.querySelector('svg');
                        if (svg) {
                            // CSS-Dimensionen verwenden (unabh√§ngig von Position)
                            const svgStyle = window.getComputedStyle(svg);
                            
                            // DOM-Zentrum berechnen (entspricht CSS transform-origin: center center)
                            const centerX = parseFloat(svgStyle.width) / 2;
                            const centerY = parseFloat(svgStyle.height) / 2;
                            
                            // Koordinaten relativ zum DOM-Zentrum machen (x,y sind bereits DOM-Koordinaten)
                            const relativeX = x - centerX;
                            const relativeY = y - centerY;
                            
                            // Rotieren um das DOM-Zentrum
                            const rad = (rotation * Math.PI) / 180;
                            const rotatedX = relativeX * Math.cos(rad) - relativeY * Math.sin(rad);
                            const rotatedY = relativeX * Math.sin(rad) + relativeY * Math.cos(rad);
                            
                            // Zur√ºck zu absoluten DOM-Koordinaten
                            x = rotatedX + centerX;
                            y = rotatedY + centerY;
                        }
                    }
                }
                
                // Position relativ zur Component berechnen
                if (component) {
                    const left = parseFloat(component.style.left) || 0;
                    const top = parseFloat(component.style.top) || 0;
                    
                    return {
                        x: left + x,
                        y: top + y
                    };
                }
                
                return { x: x, y: y };
            }
            
            getWireColor(wireType) {
                const colors = {
                    'plus': '#e30613',
                    'minus': '#1d1d1b', 
                    'phase': '#683c11',
                    'neutral': '#1d71b8',
                    'earth': '#ffed00'
                };
                return colors[wireType] || '#666';
            }
            
            updateConnectionsForComponent(component) {
                const componentId = component.id;
                
                // THROTTLING: Nur alle 50ms ausf√ºhren
                const now = Date.now();
                if (!this.lastUpdateTime) this.lastUpdateTime = {};
                if (this.lastUpdateTime[componentId] && (now - this.lastUpdateTime[componentId]) < 50) {
                    return; // Skip if called too frequently
                }
                this.lastUpdateTime[componentId] = now;
                
                debugLog('üîÑ updateConnectionsForComponent aufgerufen f√ºr:', componentId);
                
                let foundConnections = 0;
                
                this.connections.forEach((connectionData, connectionId) => {
                    if (connectionData.fromComponent === componentId || 
                        connectionData.toComponent === componentId) {
                        
                        foundConnections++;
                        this.redrawConnection(connectionId, connectionData);
                    }
                });
                
                debugLog(`üìä ${foundConnections} Verbindungen f√ºr ${componentId} aktualisiert`);
            }
            
            redrawConnection(connectionId, connectionData) {
                const path = connectionData.path;
                if (!path) return;
                
                const fromComponent = document.getElementById(connectionData.fromComponent);
                const toComponent = document.getElementById(connectionData.toComponent);
                
                if (!fromComponent || !toComponent) return;
                
                const startPos = this.getConnectionPosition(connectionData.from, fromComponent);
                const endPos = this.getConnectionPosition(connectionData.to, toComponent);
                
                // Dynamische Bezier-Berechnung mit Rotation
                const { cp1X, cp1Y, cp2X, cp2Y } = this.calculateRotatedBezierPoints(
                    startPos, endPos, connectionData.from, connectionData.to, fromComponent, toComponent
                );
                
                const pathData = `M ${startPos.x},${startPos.y} C ${cp1X},${cp1Y} ${cp2X},${cp2Y} ${endPos.x},${endPos.y}`;
                path.setAttribute('d', pathData);
                
                console.log('üîÑ Verbindung aktualisiert:', connectionId);
            }
            
            calculateRotatedBezierPoints(startPos, endPos, fromElement, toElement, fromComponent, toComponent) {
                // Basis-Offset f√ºr Kontrollpunkte
                const baseOffset = 60;
                
                // SAUBERES SYSTEM: Original-Richtung + Rotation = Finale Richtung
                
                // Start-Kontrollpunkt
                let cp1X, cp1Y;
                const fromRotation = this.componentRotations.get(fromComponent) || 0;
                
                if (fromComponent.id === 'power-source-svg') {
                    // Stromquelle: statische Richtung nach unten (keine Rotation)
                    cp1X = startPos.x;
                    cp1Y = startPos.y + baseOffset;
                } else {
                    // Original-Richtung aus data-bezier-direction
                    const originalFromDir = this.parseDirection(fromElement.dataset.bezierDirection);
                    // + Rotation des Start-Bauteils = finale Richtung
                    const finalFromDir = this.rotateDirection(originalFromDir, fromRotation);
                    // Bezier-Kontrollpunkt berechnen
                    const fromOffset = this.directionToOffset(finalFromDir, baseOffset);
                    cp1X = startPos.x + fromOffset.x;
                    cp1Y = startPos.y + fromOffset.y;
                }
                
                // End-Kontrollpunkt
                let cp2X, cp2Y;
                const toRotation = this.componentRotations.get(toComponent) || 0;
                
                if (toComponent.id === 'power-source-svg') {
                    // Stromquelle: statische Richtung nach oben (keine Rotation)
                    cp2X = endPos.x;
                    cp2Y = endPos.y - baseOffset;
                } else {
                    // Original-Richtung aus data-bezier-direction
                    const originalToDir = this.parseDirection(toElement.dataset.bezierDirection);
                    // + Rotation des End-Bauteils = finale Richtung
                    const finalToDir = this.rotateDirection(originalToDir, toRotation);
                    // Bezier-Kontrollpunkt berechnen (voller Offset f√ºr symmetrische Kurven)
                    const toOffset = this.directionToOffset(finalToDir, baseOffset);
                    cp2X = endPos.x + toOffset.x;
                    cp2Y = endPos.y + toOffset.y;
                }
                
                return { cp1X, cp1Y, cp2X, cp2Y };
            }
            
            // SAUBERE RICHTUNGS-SYSTEM: 3 Hilfsfunktionen
            
            // 1. data-bezier-direction zu Richtung parsen
            parseDirection(bezierDirectionString) {
                if (!bezierDirectionString) {
                    // Fallback: Standard nach rechts
                    return { x: 1, y: 0, name: 'right' };
                }
                
                const [x1, y1] = bezierDirectionString.split(',').map(Number);
                
                // Normalisieren: st√§rkste Richtung gewinnt
                if (Math.abs(x1) > Math.abs(y1)) {
                    return x1 > 0 ? 
                        { x: 1, y: 0, name: 'right' } : 
                        { x: -1, y: 0, name: 'left' };
                } else {
                    return y1 > 0 ? 
                        { x: 0, y: 1, name: 'down' } : 
                        { x: 0, y: -1, name: 'up' };
                }
            }
            
            // 2. Richtung um Winkel rotieren
            rotateDirection(direction, angleDegrees) {
                const rad = (angleDegrees * Math.PI) / 180;
                const cos = Math.cos(rad);
                const sin = Math.sin(rad);
                
                // 2D-Rotation-Matrix anwenden
                const newX = direction.x * cos - direction.y * sin;
                const newY = direction.x * sin + direction.y * cos;
                
                // Zur√ºck zu diskreten Richtungen normalisieren
                if (Math.abs(newX) > Math.abs(newY)) {
                    return newX > 0 ? 
                        { x: 1, y: 0, name: 'right' } : 
                        { x: -1, y: 0, name: 'left' };
                } else {
                    return newY > 0 ? 
                        { x: 0, y: 1, name: 'down' } : 
                        { x: 0, y: -1, name: 'up' };
                }
            }
            
            // 3. Richtung zu Pixel-Offset konvertieren
            directionToOffset(direction, distance) {
                return {
                    x: direction.x * distance,
                    y: direction.y * distance
                };
            }
        }

        // ===== DRAG & DROP SYSTEM =====
        let isDragging = false;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };

        function initializeDragAndDrop() {
            const componentItems = document.querySelectorAll('.component-item');
            
            componentItems.forEach(item => {
                item.addEventListener('mousedown', startDrag);
            });
            
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
            
            // BACKUP: Globaler mouseup-Event als Notfall-Reset
            document.addEventListener('mouseup', function(e) {
                if (isDragging && dragElement) {
                    console.log('üö® BACKUP: Globaler mouseup-Reset ausgel√∂st');
                    endDrag(e);
                }
            });
        }

        function startDrag(e) {
            e.preventDefault();
            
            // üö® SICHERHEITSPR√úFUNG: Kein Drag & Drop bei eingeschaltetem Strom
            if (!checkElectricalSafety(e, "Bauteile hinzuf√ºgen")) {
                return;
            }
            
            const componentType = e.currentTarget.getAttribute('data-component-type');
            console.log('üéØ Drag gestartet f√ºr Typ:', componentType);
            
            const svg = createComponentSVG(componentType);
            
            if (!svg) {
                console.log('‚ùå Kein SVG f√ºr Typ erstellt:', componentType);
                // FORCE-RESET: Bei Fehler Drag-Zustand saubern
                isDragging = false;
                dragElement = null;
                return;
            }
            
            isDragging = true;
            
            dragElement = document.createElement('div');
            dragElement.className = 'dragging-component';
            dragElement.appendChild(svg);
            
            const rect = e.currentTarget.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            updateDragPosition(e);
            document.body.appendChild(dragElement);
            
            console.log('‚úÖ Drag-Element erstellt und hinzugef√ºgt');
        }

        function handleDrag(e) {
            if (!isDragging || !dragElement) return;
            
            updateDragPosition(e);
        }

        function updateDragPosition(e) {
            if (!dragElement) return;
            
            dragElement.style.left = (e.clientX - dragOffset.x) + 'px';
            dragElement.style.top = (e.clientY - dragOffset.y) + 'px';
            

        }

        function endDrag(e) {
            console.log('üéØ endDrag aufgerufen - isDragging:', isDragging, 'dragElement:', !!dragElement);
            
            if (!isDragging || !dragElement) {
                // NOTFALL-RESET: Falls der Zustand inkonsistent ist
                isDragging = false;
                dragElement = null;
                console.log('‚ö†Ô∏è Drag-Zustand zur√ºckgesetzt (inkonsistent)');
                return;
            }
            
            const workspace = document.getElementById('workspace');
            const workspaceRect = workspace.getBoundingClientRect();
            
            if (e.clientX >= workspaceRect.left && 
                e.clientX <= workspaceRect.right && 
                e.clientY >= workspaceRect.top && 
                e.clientY <= workspaceRect.bottom) {
                
                const relativeX = e.clientX - workspaceRect.left;
                const relativeY = e.clientY - workspaceRect.top;
                
                placeComponent(relativeX, relativeY, dragElement.firstChild.getAttribute('data-component-type'));
                
                console.log('‚úÖ Bauteil platziert bei:', relativeX, relativeY);
            }
            
            // CLEANUP: Drag-Element entfernen
            if (dragElement && dragElement.parentNode) {
                dragElement.parentNode.removeChild(dragElement);
                console.log('‚úÖ Drag-Element aus DOM entfernt');
            }
            
            // FORCE-RESET: Zustand zur√ºcksetzen
            isDragging = false;
            dragElement = null;
            console.log('‚úÖ Drag-Zustand vollst√§ndig zur√ºckgesetzt');
        }

        function placeComponent(x, y, componentType) {
            const workspace = document.getElementById('workspace');
            const svg = createComponentSVG(componentType);
            
            if (!svg) return;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'component placed-component';
            wrapper.style.position = 'absolute';
            wrapper.style.left = x + 'px';
            wrapper.style.top = y + 'px';
            wrapper.setAttribute('data-component-type', componentType);
            wrapper.setAttribute('id', 'component-' + Date.now());
            
            wrapper.appendChild(svg);
            workspace.appendChild(wrapper);
            
            if (circuit) {
                circuit.addComponent(wrapper.id, componentType, {x: x, y: y});
            }
        }

        // Connection Point Hover Effects
        function setupConnectionHoverEffects() {
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('connection-line') || 
                    e.target.classList.contains('connection-socket')) {
                    
                    const connectionData = {
                        type: e.target.dataset.connectionType,
                        id: e.target.dataset.connectionId,
                        wireType: e.target.dataset.wireType,
                        voltage: e.target.dataset.voltage
                    };
                    
                    console.log('üîå Hover √ºber Anschlusspunkt:', connectionData);
                }
            });
        }

        // Datasheet Hover
        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.component-item')) {
                const componentItem = e.target.closest('.component-item');
                const type = componentItem.getAttribute('data-component-type');
                showDatasheet(type);
            }
        });

        // Globale Instanz
        let workspaceManager = null;
        window.workspaceManager = null; // Global verf√ºgbar machen

        console.log('üéÆ Workspace Manager geladen');

        // ===== HAUPTANWENDUNG =====

        // ===== GLOBALE FUNKTIONEN =====

        function openTaskMenu() {
            alert('Hier wird sp√§ter das Aufgaben-Men√º ge√∂ffnet.\n\nFunktionen:\n‚Ä¢ Aufgaben-√úbersicht\n‚Ä¢ Schwierigkeitsgrade\n‚Ä¢ Fortschritt anzeigen\n‚Ä¢ Neue Aufgaben laden');
        }

        function toggleDatasheet() {
            const section = document.getElementById('datasheet-section');
            const toggle = document.getElementById('datasheet-toggle');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                toggle.textContent = '‚ñº';
                toggle.title = 'Datenblatt ausklappen';
            } else {
                toggle.textContent = '‚ñ≤';
                toggle.title = 'Datenblatt einklappen';
            }
        }

        function togglePower() {
            systemPower = !systemPower;
            const powerBtn = document.getElementById('powerBtn');
            
            if (systemPower) {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOn" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOn)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                  x="2.13" y=".91" width="17.49" height="20.74" transform="translate(22.15 .41) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                             points="5.22 8.66 5.22 17.05 16.38 17.05 16.38 8.66 18.52 8.66 18.52 .5 3.22 .5 3.22 8.66 5.22 8.66"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="16.63" y1="2.78" x2="5.5" y2="2.78"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="16.63" y1="4.46" x2="5.5" y2="4.46"/>
                                </g>
                                <rect fill="var(--color-error)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="5.21" y="9.83" width="11.18" height="4.98" transform="translate(21.59 24.63) rotate(180)"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(7.47 13.58)">
                                    <tspan x="0" y="0">I</tspan>
                                    <tspan x=".99" y="0">-</tspan>
                                    <tspan x="2.34" y="0">on</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            } else {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                  x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                             points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                          x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                </g>
                                <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="1.1" stroke-miterlimit="10"
                                      x="5.36" y="7.68" width="11.18" height="4.98"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(6.36 11.7)">
                                    <tspan x="0" y="0">O</tspan>
                                    <tspan x="2.92" y="0">-</tspan>
                                    <tspan x="4.27" y="0">off</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            }
            
            if (circuit) {
                circuit.powerStateChanged();
                
                // üîÑ BEI AUSSCHALTEN: Alle Komponenten sofort auf OFF setzen
                if (!systemPower) {
                    console.log('üîÑ HAUPTSCHALTER AUS ‚Üí Alle Komponenten ausschalten...');
                    for (const [componentId, stateMachine] of circuit.graph.stateMachines) {
                        const componentState = circuit.graph.getComponentState(componentId);
                        if (componentState !== 'broken') {
                            stateMachine.updateState(0, 0); // Sofort ausschalten
                            console.log(`üí° Component ${componentId} ausgeschaltet`);
                        }
                    }
                }
                
                // üîÑ NEUBERECHNUNG: Bei EINSCHALTEN alle Verbindungen neu analysieren
                if (systemPower) {
                    console.log('üîÑ HAUPTSCHALTER EIN ‚Üí Vollst√§ndige Neuberechnung startet...');
                    
                    // 1. Alle nicht-kaputten Komponenten zur√ºcksetzen
                    for (const [componentId, state] of circuit.graph.componentStates) {
                        if (state !== 'broken') {
                            circuit.graph.componentStates.set(componentId, 'off');
                            console.log(`üîÑ Component ${componentId} zur√ºckgesetzt auf OFF`);
                        } else {
                            console.log(`üö´ Component ${componentId} bleibt BROKEN`);
                        }
                    }
                    
                    // 2. Alle WorkspaceManager Verbindungen neu validieren
                    if (window.workspaceManager && window.workspaceManager.connections) {
                        console.log(`üîç Validiere ${window.workspaceManager.connections.size} Verbindungen...`);
                        for (const [connId, connectionData] of window.workspaceManager.connections) {
                            const validation = window.workspaceManager.validateConnection(
                                connectionData.from, 
                                connectionData.to
                            );
                            if (!validation.valid) {
                                console.log(`‚ùå Verbindung ${connId} ung√ºltig: ${validation.reason}`);
                            }
                        }
                    }
                    
                    // 3. Alle Komponenten neu analysieren
                    const powerSource = circuit.physics.findPowerSource();
                    if (powerSource) {
                        const connectedComponents = circuit.graph.getConnectedComponents(powerSource);
                        console.log(`üîç Analysiere ${connectedComponents.length} verbundene Komponenten...`);
                        
                        for (const componentId of connectedComponents) {
                            const component = circuit.graph.nodes.get(componentId);
                            if (!component) continue;
                            
                            // Nur nicht-kaputte Komponenten neu berechnen
                            const componentState = circuit.graph.getComponentState(componentId);
                            if (componentState === 'broken') {
                                console.log(`üö´ ${componentId} bleibt broken - wird √ºbersprungen`);
                                continue;
                            }
                            
                            console.log(`üîÑ Analysiere ${componentId}...`);
                            
                            // Verbindungsqualit√§t pr√ºfen
                            const isConnected = circuit.physics.isComponentProperlyConnected(componentId);
                            console.log(`üîç ${componentId} - Verbindung vollst√§ndig: ${isConnected}`);
                            
                            if (isConnected) {
                                // Gef√§hrliche Bedingungen pr√ºfen
                                const danger = circuit.physics.checkForDangerousConditions(componentId);
                                if (danger) {
                                    console.log(`üí• ${componentId} BESCH√ÑDIGT: ${danger}`);
                                    circuit.graph.setComponentState(componentId, 'broken');
                                }
                            }
                        }
                    }
                    
                    // 4. Alle StateMachines zur√ºcksetzen (f√ºr visuelle LEDs)
                    for (const [componentId, stateMachine] of circuit.graph.stateMachines) {
                        const componentState = circuit.graph.getComponentState(componentId);
                        if (componentState !== 'broken') {
                            console.log(`üîÑ StateMachine ${componentId} zur√ºckgesetzt`);
                            stateMachine.updateState(0, 0); // Spannung und Strom auf 0
                        } else {
                            console.log(`üö´ StateMachine ${componentId} bleibt broken`);
                        }
                    }
                    
                    // 5. Physik-Update erzwingen
                    setTimeout(() => {
                        console.log('üîÑ Starte Physik-Berechnung...');
                        circuit.physics.calculateCircuit();
                        
                        // 6. Zus√§tzlich: Alle LED-Kreise wiederherstellen
                        for (const [componentId, stateMachine] of circuit.graph.stateMachines) {
                            const element = document.getElementById(componentId);
                            if (element && ComponentSpecs[stateMachine.type]?.type === 'load') {
                                // LED-Kreis sichtbar machen falls verschwunden
                                const ledCircle = element.querySelector('.cls-5, .led24-center');
                                if (ledCircle) {
                                    ledCircle.style.display = 'block';
                                    ledCircle.style.opacity = '1';
                                    console.log(`üí° LED-Kreis f√ºr ${componentId} wiederhergestellt`);
                                }
                            }
                        }
                        
                        // 7. Status-Report
                        console.log('üìä NEUBERECHNUNG - STATUS REPORT:');
                        for (const [componentId, state] of circuit.graph.componentStates) {
                            const component = circuit.graph.nodes.get(componentId);
                            const type = component ? component.type : 'unknown';
                            console.log(`   ${componentId} (${type}): ${state}`);
                        }
                        console.log('‚úÖ Neuberechnung abgeschlossen!');
                    }, 100);
                }
            }
        }

        function clearWorkspace() {
            const workspace = document.getElementById('workspace');
            const powerSource = workspace.querySelector('.power-source');
            const svg = workspace.querySelector('#connectionSvg');
            const infoBtn = workspace.querySelector('.workspace-info-btn');
            const infoTooltip = workspace.querySelector('.info-tooltip');
            
            Array.from(workspace.children).forEach(child => {
                if (child !== powerSource && child !== svg && child !== infoBtn && child !== infoTooltip) {
                    child.remove();
                }
            });
            
            // Verbindungen in WorkspaceManager l√∂schen
            if (workspaceManager) {
                workspaceManager.connections.clear();
            }
            
            // Globale Arrays leeren
            connections = [];
            components = [];
            
            // Circuit-Graph zur√ºcksetzen
            if (circuit) {
                circuit.graph.nodes.clear();
                circuit.graph.edges.clear();
                circuit.graph.stateMachines.clear();
                
                // Stromquelle wieder hinzuf√ºgen
                circuit.addComponent('power-source-svg', ComponentTypes.POWER_SOURCE, {x: 20, y: 20});
            }
            
            console.log('üßπ Arbeitsfl√§che geleert');
        }

        function resetConnections() {
            const svg = document.getElementById('connectionSvg');
            svg.innerHTML = '';
            
            // Verbindungen in WorkspaceManager l√∂schen
            if (workspaceManager) {
                workspaceManager.connections.clear();
            }
            
            connections = [];
            
            // Circuit-Graph Verbindungen zur√ºcksetzen
            if (circuit) {
                circuit.graph.edges.clear();
                
                // Alle Komponenten-Verbindungen l√∂schen
                circuit.graph.nodes.forEach(node => {
                    node.connections.clear();
                });
            }
            
            console.log('üîó Alle Verbindungen zur√ºckgesetzt');
        }

        // ===== SVG FACTORY =====
        function createComponentSVG(componentType) {
            switch(componentType) {
                case 'led-12v-1.2w':
                    return createLEDModuleSVG();
                case 'trafo-12v-40w':
                    return createTransformer12VSVG();
                case 'trafo-24v-60w':
                    return createTransformer24VSVG();
                case 'trafo-12v-3w':
                    return createTransformer12V3WSVG();
                case 'fi-schalter':
                    return createFISwitchSVG();
                case 'ls-schalter':
                    return createLSSwitchSVG();
                case 'zeitschaltuhr':
                    return createTimerSwitchSVG();
                case 'daemmerungsschalter':
                    return createDuskSwitchSVG();
                case 'kabel-flexibel-sw':
                    return createKabelFlexibelSVG();
                case 'klemme-mobil-3l':
                    return createKlemmeMobilSVG();
                case 'dev-placeholder':
                    return createDevPlaceholderSVG();
                case 'led-24v-5w':
                    return createLED24VSVG();
                default:
                    console.log('‚ö†Ô∏è Unbekannter Komponententyp:', componentType);
                    return null;
            }
        }

        // ===== LED-MODUL 12V 1,2W =====
        function createLEDModuleSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '-10 0 157.29 30');
            svg.setAttribute('class', 'led-module-svg');
            svg.setAttribute('data-component-type', 'led-12v-1.2w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-plus", "to":"out-plus", "resistance":0.1},
                {"from":"in-minus", "to":"out-minus", "resistance":0.1}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-plus", "in-minus"],
                "power": 1.2,
                "voltage": 12,
                "type": "led"
            }));
            
            svg.innerHTML = `
                <defs>
                    <style>
                        .cls-1 { fill: #9e9e9e; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-2 { fill: #e8e8e8; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-5 { fill: #fff; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-7 { fill: #1d1d1b; font-family: Arial, sans-serif; font-size: 7.77px; }
                    </style>
                    
                    <!-- Glow-Filter f√ºr LEDs -->
                    <filter id="ledGlow" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="0.8" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <filter id="ledGlowStrong" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="1.0" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                

                
                <g>
                    <g>
                        <rect class="cls-2" x="16.605" y=".75" width="100.14" height="26.04" rx="8.475" ry="8.475"/>
                        <g>
                            <circle class="cls-1" cx="90.18" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="90.18" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="44.73" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="44.73" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="67.455" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="67.455" cy="13.77" r="4.125"/>
                        </g>
                        <text class="cls-7" transform="translate(101.34 5.01) rotate(90)">
                            <tspan x="0" y="0">1,2 W</tspan>
                        </text>
                        <text class="cls-7" transform="translate(24.84 20.61) rotate(-90)">
                            <tspan x="0" y="0">12 V</tspan>
                            <tspan x=".195" y="9.315">WW</tspan>
                        </text>
                        <text class="cls-7" transform="translate(113.82 17.01) rotate(-180)">+</text>
                        <text class="cls-7" transform="translate(112.68 5.685) rotate(-180)">-</text>
                    </g>
                </g>
                
                <!-- Anschlusskabel Links -->
                <line class="visual-cable visual-cable-minus" stroke="#1d1d1b" stroke-width="4" x1="8" y1="9.225" x2="16.53" y2="9.225"/>
                <line class="visual-cable visual-cable-plus" stroke="#e30613" stroke-width="4" x1="8" y1="18.315" x2="16.53" y2="18.315"/>
                
                <!-- Connection Points Links (BIDIREKTIONALE Buchsen) -->
                <circle class="connection-socket" 
                        cx="8" cy="9.225" r="4" 
                        data-connection-type="bidirectional-socket"
                        data-connection-id="minus-terminal"
                        data-wire-type="minus"
                        data-voltage="12"
                        data-bezier-end-x="28" data-bezier-end-y="10.4"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="8" cy="18.315" r="4" 
                        data-connection-type="bidirectional-socket"
                        data-connection-id="plus-terminal"
                        data-wire-type="plus"
                        data-voltage="12"
                        data-bezier-end-x="28" data-bezier-end-y="18.8"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Connection Points Rechts (Ausgehende Linien) -->
                <line class="connection-line" 
                      x1="117" y1="9.225" x2="127.29" y2="9.225" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="12"
                      data-bezier-start-x="127" data-bezier-start-y="9.7"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="117" y1="18.315" x2="127.29" y2="18.315" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="12"
                      data-bezier-start-x="127" data-bezier-start-y="18.8"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== TRANSFORMATOR 12V =====
        function createTransformer12VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 120 80');
            svg.setAttribute('class', 'transformer-svg');
            svg.setAttribute('data-component-type', 'trafo-12v-40w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-phase", "to":"out-plus", "resistance":0.02, "efficiency":0.87},
                {"from":"in-neutral", "to":"out-minus", "resistance":0.02, "efficiency":0.87}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-phase", "in-neutral"],
                "power": 40,
                "voltage": 230,
                "type": "transformer",
                "output_voltage": 12,
                "output_power": 40
            }));
            
            svg.innerHTML = `
                <!-- Geh√§use -->
                <rect class="trafo-housing" x="20" y="10" width="80" height="60" rx="5"/>
                
                <!-- Beschriftung -->
                <text class="trafo-text" x="60" y="30" text-anchor="middle">TRAFO</text>
                <text class="trafo-text" x="60" y="45" text-anchor="middle">12V DC</text>
                <text class="trafo-label" x="60" y="55" text-anchor="middle">40W</text>
                
                <!-- Eingangskabel (230V) -->
                <line stroke="#683c11" stroke-width="4" x1="5" y1="25" x2="20" y2="25"/>
                <line stroke="#1d71b8" stroke-width="4" x1="5" y1="35" x2="20" y2="35"/>
                <line stroke="#ffed00" stroke-width="4" x1="5" y1="45" x2="20" y2="45"/>
                
                <!-- Ausgangskabel (12V) -->
                <line stroke="#e30613" stroke-width="4" x1="100" y1="30" x2="115" y2="30"/>
                <line stroke="#1d1d1b" stroke-width="4" x1="100" y1="50" x2="115" y2="50"/>
                
                <!-- Eingangs-Connection Points -->
                <circle class="connection-socket" 
                        cx="5" cy="25" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-phase"
                        data-wire-type="phase"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="25"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="35" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-neutral"
                        data-wire-type="neutral"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="35"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="45" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-earth"
                        data-wire-type="earth"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="45"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Ausgangs-Connection Points -->
                <line class="connection-line" 
                      x1="115" y1="30" x2="120" y2="30" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="30"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="115" y1="50" x2="120" y2="50" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="50"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== TRANSFORMATOR 12V 3W (MINI) =====
        function createTransformer12V3WSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 120 80');
            svg.setAttribute('class', 'transformer-svg');
            svg.setAttribute('data-component-type', 'trafo-12v-3w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-phase", "to":"out-plus", "resistance":0.02, "efficiency":0.87},
                {"from":"in-neutral", "to":"out-minus", "resistance":0.02, "efficiency":0.87}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-phase", "in-neutral"],
                "power": 3,
                "voltage": 230,
                "type": "transformer",
                "output_voltage": 12,
                "output_power": 3
            }));
            
            svg.innerHTML = `
                <!-- Geh√§use (rot f√ºr Mini-Trafo) -->
                <rect class="trafo-housing" x="20" y="10" width="80" height="60" rx="5" fill="#ff6b6b" stroke="#cc5555"/>
                
                <!-- Beschriftung -->
                <text class="trafo-text" x="60" y="30" text-anchor="middle" fill="white">MINI</text>
                <text class="trafo-text" x="60" y="45" text-anchor="middle" fill="white">12V DC</text>
                <text class="trafo-label" x="60" y="55" text-anchor="middle" fill="white" font-weight="bold">3W</text>
                
                <!-- Eingangskabel (230V) -->
                <line stroke="#683c11" stroke-width="4" x1="5" y1="25" x2="20" y2="25"/>
                <line stroke="#1d71b8" stroke-width="4" x1="5" y1="35" x2="20" y2="35"/>
                <line stroke="#ffed00" stroke-width="4" x1="5" y1="45" x2="20" y2="45"/>
                
                <!-- Ausgangskabel (12V) -->
                <line stroke="#e30613" stroke-width="4" x1="100" y1="30" x2="115" y2="30"/>
                <line stroke="#1d1d1b" stroke-width="4" x1="100" y1="50" x2="115" y2="50"/>
                
                <!-- Eingangs-Connection Points -->
                <circle class="connection-socket" 
                        cx="5" cy="25" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-phase"
                        data-wire-type="phase"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="25"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="35" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-neutral"
                        data-wire-type="neutral"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="35"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="5" cy="45" r="4" 
                        data-connection-type="input-socket"
                        data-connection-id="in-earth"
                        data-wire-type="earth"
                        data-voltage="230"
                        data-bezier-end-x="5" data-bezier-end-y="45"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Ausgangs-Connection Lines -->
                <line class="connection-line" 
                      x1="115" y1="30" x2="120" y2="30" 
                      stroke="#e30613" 
                      stroke-width="4"
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="30"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="115" y1="50" x2="120" y2="50" 
                      stroke="#1d1d1b" 
                      stroke-width="4"
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="12"
                      data-bezier-start-x="117" data-bezier-start-y="50"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== TRANSFORMATOR 24V =====
        function createTransformer24VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 120 80');
            svg.setAttribute('class', 'transformer-svg');
            svg.setAttribute('data-component-type', 'trafo-24v-60w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-phase", "to":"out-plus", "resistance":0.02, "efficiency":0.90},
                {"from":"in-neutral", "to":"out-minus", "resistance":0.02, "efficiency":0.90}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-phase", "in-neutral"],
                "power": 60,
                "voltage": 230,
                "type": "transformer",
                "output_voltage": 24,
                "output_power": 60
            }));
            
            svg.innerHTML = `
                <!-- Geh√§use -->
                <rect class="trafo-housing" x="20" y="10" width="80" height="60" rx="5"/>
                
                <!-- Beschriftung -->
                <text class="trafo-text" x="60" y="30" text-anchor="middle">TRAFO</text>
                <text class="trafo-text" x="60" y="45" text-anchor="middle">24V DC</text>
                <text class="trafo-label" x="60" y="55" text-anchor="middle">60W</text>
                
                <!-- Eingangskabel (230V) -->
                <line stroke="#683c11" stroke-width="4" x1="5" y1="25" x2="20" y2="25"/>
                <line stroke="#1d71b8" stroke-width="4" x1="5" y1="35" x2="20" y2="35"/>
                <line stroke="#ffed00" stroke-width="4" x1="5" y1="45" x2="20" y2="45"/>
                
                <!-- Ausgangskabel (24V) -->
                <line stroke="#e30613" stroke-width="4" x1="100" y1="30" x2="115" y2="30"/>
                <line stroke="#1d1d1b" stroke-width="4" x1="100" y1="50" x2="115" y2="50"/>
                
                <!-- Connection Points analog zu 12V Trafo -->
                <circle class="connection-socket" cx="5" cy="25" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-phase"
                        data-wire-type="phase" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="25"
                        data-bezier-direction="-20,0,0,0"/>
                <circle class="connection-socket" cx="5" cy="35" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-neutral"
                        data-wire-type="neutral" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="35"
                        data-bezier-direction="-20,0,0,0"/>
                <circle class="connection-socket" cx="5" cy="45" r="4" 
                        data-connection-type="input-socket" data-connection-id="in-earth"
                        data-wire-type="earth" data-voltage="230" data-bezier-end-x="5" data-bezier-end-y="45"
                        data-bezier-direction="-20,0,0,0"/>
                
                <line class="connection-line" x1="115" y1="30" x2="120" y2="30" stroke="#e30613" 
                      data-connection-type="output-line" data-connection-id="out-plus"
                      data-wire-type="plus" data-voltage="24" data-bezier-start-x="117" data-bezier-start-y="30"
                      data-bezier-direction="20,0,0,0"/>
                <line class="connection-line" x1="115" y1="50" x2="120" y2="50" stroke="#1d1d1b" 
                      data-connection-type="output-line" data-connection-id="out-minus"
                      data-wire-type="minus" data-voltage="24" data-bezier-start-x="117" data-bezier-start-y="50"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== LED-MODUL 24V =====
        function createLED24VSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '-10 0 157.29 30');
            svg.setAttribute('class', 'led-module-svg');
            svg.setAttribute('data-component-type', 'led-24v-5w');
            
            svg.setAttribute('data-internal-routing', JSON.stringify([
                {"from":"in-plus", "to":"out-plus", "resistance":0.1},
                {"from":"in-minus", "to":"out-minus", "resistance":0.1}
            ]));
            
            svg.setAttribute('data-component-load', JSON.stringify({
                "between": ["in-plus", "in-minus"],
                "power": 5,
                "voltage": 24,
                "type": "led"
            }));
            
            svg.innerHTML = `
                <defs>
                    <style>
                        .cls-1 { fill: #9e9e9e; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-2 { fill: #e8e8e8; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-5 { fill: #fff; stroke: #1d1d1b; stroke-width: 1.5; stroke-miterlimit: 10; }
                        .cls-7 { fill: #1d1d1b; font-family: Arial, sans-serif; font-size: 7.77px; }
                    </style>
                    
                    <!-- Glow-Filter f√ºr LEDs -->
                    <filter id="ledGlow24" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="0.8" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <filter id="ledGlowStrong24" x="-200%" y="-200%" width="500%" height="500%">
                        <feFlood flood-color="#ffff00" flood-opacity="1.0" result="glowColor"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur"/>
                        <feComposite in="glowColor" in2="blur" operator="in" result="coloredBlur"/>
                        <feMerge> 
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                

                
                <g>
                    <g>
                        <rect class="cls-2" x="16.605" y=".75" width="100.14" height="26.04" rx="8.475" ry="8.475"/>
                        <g>
                            <circle class="cls-1" cx="90.18" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="90.18" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="44.73" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="44.73" cy="13.77" r="4.125"/>
                        </g>
                        <g>
                            <circle class="cls-1" cx="67.455" cy="13.77" r="8.25"/>
                            <circle class="cls-5" cx="67.455" cy="13.77" r="4.125"/>
                        </g>
                        <text class="cls-7" transform="translate(101.34 5.01) rotate(90)">
                            <tspan x="0" y="0">5 W</tspan>
                        </text>
                        <text class="cls-7" transform="translate(24.84 20.61) rotate(-90)">
                            <tspan x="0" y="0">24 V</tspan>
                            <tspan x=".195" y="9.315">WW</tspan>
                        </text>
                        <text class="cls-7" transform="translate(113.82 17.01) rotate(-180)">+</text>
                        <text class="cls-7" transform="translate(112.68 5.685) rotate(-180)">-</text>
                    </g>
                </g>
                
                <!-- Anschlusskabel Links -->
                <line class="visual-cable visual-cable-minus" stroke="#1d1d1b" stroke-width="4" x1="8" y1="9.225" x2="16.53" y2="9.225"/>
                <line class="visual-cable visual-cable-plus" stroke="#e30613" stroke-width="4" x1="8" y1="18.315" x2="16.53" y2="18.315"/>
                
                <!-- Connection Points Links (BIDIREKTIONALE Buchsen) -->
                <circle class="connection-socket" 
                        cx="8" cy="9.225" r="4" 
                        data-connection-type="bidirectional-socket"
                        data-connection-id="minus-terminal"
                        data-wire-type="minus"
                        data-voltage="24"
                        data-bezier-end-x="28" data-bezier-end-y="9.7"
                        data-bezier-direction="-20,0,0,0"/>
                        
                <circle class="connection-socket" 
                        cx="8" cy="18.315" r="4" 
                        data-connection-type="bidirectional-socket"
                        data-connection-id="plus-terminal"
                        data-wire-type="plus"
                        data-voltage="24"
                        data-bezier-end-x="28" data-bezier-end-y="18.8"
                        data-bezier-direction="-20,0,0,0"/>
                
                <!-- Connection Points Rechts (Ausgehende Linien) -->
                <line class="connection-line" 
                      x1="117" y1="9.225" x2="127.29" y2="9.225" 
                      stroke="#1d1d1b" 
                      data-connection-type="output-line"
                      data-connection-id="out-minus"
                      data-wire-type="minus"
                      data-voltage="24"
                                              data-bezier-start-x="127" data-bezier-start-y="9.7"
                      data-bezier-direction="20,0,0,0"/>
                      
                <line class="connection-line" 
                      x1="117" y1="18.315" x2="127.29" y2="18.315" 
                      stroke="#e30613" 
                      data-connection-type="output-line"
                      data-connection-id="out-plus"
                      data-wire-type="plus"
                      data-voltage="24"
                                              data-bezier-start-x="127" data-bezier-start-y="18.8"
                      data-bezier-direction="20,0,0,0"/>
            `;
            
            return svg;
        }

        // ===== PLACEHOLDER SVGs f√ºr andere Komponenten =====
        function createFISwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 60 80');
            svg.setAttribute('data-component-type', 'fi-schalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="40" height="60" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="8" x="30" y="30" text-anchor="middle">FI</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="45" text-anchor="middle">30mA</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="55" text-anchor="middle">16A</text>
            `;
            
            return svg;
        }

        function createLSSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 60 80');
            svg.setAttribute('data-component-type', 'ls-schalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="40" height="60" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="8" x="30" y="30" text-anchor="middle">LS</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="45" text-anchor="middle">16A</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="30" y="55" text-anchor="middle">B</text>
            `;
            
            return svg;
        }

        function createTimerSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 80 60');
            svg.setAttribute('data-component-type', 'zeitschaltuhr');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="60" height="40" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="7" x="40" y="25" text-anchor="middle">TIMER</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="5" x="40" y="35" text-anchor="middle">16A</text>
                <rect fill="#1d1d1b" x="20" y="20" width="20" height="8" rx="2"/>
                <text fill="#00ff00" font-family="Arial" font-size="4" x="30" y="25" text-anchor="middle">12:00</text>
            `;
            
            return svg;
        }

        function createDuskSwitchSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 80 60');
            svg.setAttribute('data-component-type', 'daemmerungsschalter');
            
            svg.innerHTML = `
                <rect fill="#e8e8e8" stroke="#1d1d1b" stroke-width="2" x="10" y="10" width="60" height="40" rx="5"/>
                <text fill="#1d1d1b" font-family="Arial" font-size="6" x="40" y="25" text-anchor="middle">D√ÑMMER</text>
                <text fill="#1d1d1b" font-family="Arial" font-size="5" x="40" y="35" text-anchor="middle">10A</text>
                <circle fill="#ffed00" stroke="#1d1d1b" stroke-width="1" cx="25" cy="25" r="5"/>
                <circle fill="#1d1d1b" cx="55" cy="25" r="3"/>
            `;
            
            return svg;
        }



        // ===== DATASHEET FUNCTIONS =====
        function showDatasheet(componentType) {
            const content = document.getElementById('datasheet-content');
            const info = DatasheetInfo[componentType];
            
            if (!info) {
                content.innerHTML = `
                    <h4 class="text-h2">${componentType}</h4>
                    <p class="text-small">Technische Daten werden geladen...</p>
                `;
                return;
            }
            
            content.innerHTML = `
                <h4 class="text-h2">${info.name}</h4>
                <p class="text-small">${info.description}</p>
                <div class="info-box">
                    <h4>Technische Daten</h4>
                    <p class="text-small">${info.specs}</p>
                </div>
                <div class="info-box">
                    <h4>Schaltskizze</h4>
                    <div class="schematic-container" id="schematic-placeholder">
                        <p class="text-small"><em>Schaltskizze wird geladen...</em></p>
                    </div>
                </div>
            `;
            
            // Schaltskizze nachtr√§glich einf√ºgen
            setTimeout(() => {
                const placeholder = document.getElementById('schematic-placeholder');
                if (placeholder) {
                    if (componentType.includes('led')) {
                        placeholder.innerHTML = getLEDSchematic();
                    } else if (componentType.includes('trafo')) {
                        placeholder.innerHTML = getTrafoSchematic(componentType);
                    } else if (componentType.includes('fi')) {
                        placeholder.innerHTML = getFISchematic();
                    } else if (componentType.includes('ls')) {
                        placeholder.innerHTML = getLSSchematic();
                    } else if (componentType.includes('zeitschaltuhr')) {
                        placeholder.innerHTML = getTimerSchematic();
                    } else if (componentType.includes('daemmerungsschalter')) {
                        placeholder.innerHTML = getD√§mmerungsSchematic();
                    } else if (componentType.includes('klemme-mobil')) {
                        placeholder.innerHTML = getKlemmeSchematic();
                    }
                }
            }, 100);
        }
        
        function getLEDSchematic() {
            return `
                <svg viewBox="0 0 213.02 69.83" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- Obere Leitung -->
                        <line class="schematic-line" x1="208.97" y1="4.26" x2="4.05" y2="4.26"/>
                        
                        <!-- Plus-Anschluss oben rechts -->
                        <g>
                            <circle class="schematic-fill-white" cx="208.76" cy="4.26" r="3.76"/>
                            <path class="schematic-fill-black" d="M208.76,0c-2.35,0-4.26,1.91-4.26,4.26s1.91,4.26,4.26,4.26,4.26-1.91,4.26-4.26-1.91-4.26-4.26-4.26,2.35,0,0,0ZM208.76,7.52c-1.8,0-3.26-1.46-3.26-3.26s1.46-3.26,3.26-3.26,3.26,1.46,3.26,3.26-1.46,3.26-3.26,3.26,1.8,0,0,0Z"/>
                        </g>
                        
                        <!-- Plus-Anschluss oben links -->
                        <g>
                            <circle class="schematic-fill-white" cx="4.26" cy="4.26" r="3.76"/>
                            <path class="schematic-fill-black" d="M4.26,0c2.35,0,4.26,1.91,4.26,4.26s-1.91,4.26-4.26,4.26S0,6.61,0,4.26,1.91,0,4.26,0s-2.35,0,0,0ZM4.26,7.52c1.8,0,3.26-1.46,3.26-3.26s-1.46-3.26-3.26-3.26-3.26,1.46-3.26,3.26,1.46,3.26,3.26,3.26-1.8,0,0,0Z"/>
                        </g>
                        
                        <!-- Hauptverteilung -->
                        <polyline class="schematic-line" points="14.4 4.26 14.4 24.1 198.96 24.88 198.96 65.57"/>
                        
                        <!-- LED 1 -->
                        <g>
                            <polyline class="schematic-line" points="68.28 24.88 68.28 49.96 102.27 49.96 102.27 24.91"/>
                            <!-- Dioden-Symbol 1 -->
                            <line class="schematic-line" x1="81.26" y1="43.13" x2="81.26" y2="56.79"/>
                            <polygon class="schematic-fill-white" points="81.55 49.94 92.38 44.04 92.38 55.84 81.55 49.94"/>
                            <!-- LED-Symbol 1 -->
                            <line class="schematic-line" x1="93.29" y1="15.74" x2="93.29" y2="34.09"/>
                            <polygon class="schematic-fill-white" points="92.92 24.88 79.2 16.96 79.2 32.8 92.92 24.88"/>
                            <!-- Lichtstrahlen 1 -->
                            <line class="schematic-line" x1="87.98" y1="10.99" x2="84.27" y2="17.31"/>
                            <polygon class="schematic-fill-black" points="85.86 11.24 87.69 11.48 88.8 12.96 89.37 8.62 85.86 11.24"/>
                            <line class="schematic-line" x1="91.6" y1="13.16" x2="87.89" y2="19.48"/>
                            <polygon class="schematic-fill-black" points="89.48 13.41 91.31 13.65 92.42 15.14 92.99 10.79 89.48 13.41"/>
                        </g>
                        
                        <!-- LED 2 -->
                        <g>
                            <polyline class="schematic-line" points="109.06 24.98 109.06 50.06 143.06 50.06 143.06 25.01"/>
                            <!-- Dioden-Symbol 2 -->
                            <line class="schematic-line" x1="122.05" y1="43.23" x2="122.05" y2="56.89"/>
                            <polygon class="schematic-fill-white" points="122.34 50.04 133.16 44.14 133.16 55.94 122.34 50.04"/>
                            <!-- LED-Symbol 2 -->
                            <line class="schematic-line" x1="134.07" y1="15.84" x2="134.07" y2="34.18"/>
                            <polygon class="schematic-fill-white" points="133.7 24.98 119.98 17.06 119.98 32.9 133.7 24.98"/>
                            <!-- Lichtstrahlen 2 -->
                            <line class="schematic-line" x1="128.77" y1="11.09" x2="125.05" y2="17.41"/>
                            <polygon class="schematic-fill-black" points="126.64 11.34 128.48 11.58 129.58 13.06 130.16 8.72 126.64 11.34"/>
                            <line class="schematic-line" x1="132.39" y1="13.26" x2="128.67" y2="19.58"/>
                            <polygon class="schematic-fill-black" points="130.26 13.51 132.1 13.75 133.2 15.24 133.78 10.89 130.26 13.51"/>
                        </g>
                        
                        <!-- LED 3 -->
                        <g>
                            <polyline class="schematic-line" points="149.67 25.08 149.67 50.16 183.67 50.16 183.67 25.11"/>
                            <!-- Dioden-Symbol 3 -->
                            <line class="schematic-line" x1="162.66" y1="43.33" x2="162.66" y2="56.99"/>
                            <polygon class="schematic-fill-white" points="162.95 50.14 173.77 44.24 173.77 56.04 162.95 50.14"/>
                            <!-- LED-Symbol 3 -->
                            <line class="schematic-line" x1="174.69" y1="15.93" x2="174.69" y2="34.28"/>
                            <polygon class="schematic-fill-white" points="174.32 25.08 160.6 17.16 160.6 33 174.32 25.08"/>
                            <!-- Lichtstrahlen 3 -->
                            <line class="schematic-line" x1="169.38" y1="11.18" x2="165.66" y2="17.51"/>
                            <polygon class="schematic-fill-black" points="167.25 11.43 169.09 11.67 170.19 13.16 170.77 8.82 167.25 11.43"/>
                            <line class="schematic-line" x1="173" y1="13.36" x2="169.28" y2="19.68"/>
                            <polygon class="schematic-fill-black" points="170.87 13.61 172.71 13.85 173.81 15.33 174.39 10.99 170.87 13.61"/>
                        </g>
                        
                        <!-- Anschlussklemme -->
                        <rect class="schematic-fill-white" x="25.03" y="19.83" width="27.98" height="8.75"/>
                        
                        <!-- Untere Leitung -->
                        <line class="schematic-line" x1="208.97" y1="65.57" x2="4.05" y2="65.57"/>
                        
                        <!-- Minus-Anschluss unten rechts -->
                        <g>
                            <circle class="schematic-fill-white" cx="208.76" cy="65.57" r="3.76"/>
                            <path class="schematic-fill-black" d="M208.76,61.31c-2.35,0-4.26,1.91-4.26,4.26s1.91,4.26,4.26,4.26,4.26-1.91,4.26-4.26-1.91-4.26-4.26-4.26,2.35,0,0,0ZM208.76,68.83c-1.8,0-3.26-1.46-3.26-3.26s1.46-3.26,3.26-3.26,3.26,1.46,3.26,3.26-1.46,3.26-3.26,3.26,1.8,0,0,0Z"/>
                        </g>
                        
                        <!-- Minus-Anschluss unten links -->
                        <g>
                            <circle class="schematic-fill-white" cx="4.26" cy="65.57" r="3.76"/>
                            <path class="schematic-fill-black" d="M4.26,61.31c2.35,0,4.26,1.91,4.26,4.26s-1.91,4.26-4.26,4.26-4.26-1.91-4.26-4.26,1.91-4.26,4.26-4.26-2.35,0,0,0ZM4.26,68.83c1.8,0,3.26-1.46,3.26-3.26s-1.46-3.26-3.26-3.26-3.26,1.46-3.26,3.26,1.46,3.26,3.26,3.26-1.8,0,0,0Z"/>
                        </g>
                        
                        <!-- Plus-Anschluss Linien -->
                        <line class="schematic-line" x1="206.02" y1="4.26" x2="211.48" y2="4.26"/>
                        <line class="schematic-line" x1="208.75" y1="1.53" x2="208.75" y2="6.99"/>
                        <line class="schematic-line" x1="1.48" y1="4.26" x2="6.94" y2="4.26"/>
                        <line class="schematic-line" x1="4.21" y1="1.53" x2="4.21" y2="6.99"/>
                        
                        <!-- Minus-Anschluss Linien -->
                        <line class="schematic-line" x1="206.02" y1="65.57" x2="211.47" y2="65.57"/>
                        <line class="schematic-line" x1="1.61" y1="65.57" x2="7.07" y2="65.57"/>
                    </g>
                </svg>
            `;
        }
        
        function getTrafoSchematic(componentType) {
            // Bestimme Ausgangsspannung basierend auf Component-Type
            const isTrafo24V = componentType.includes('24v');
            const outputVoltage = isTrafo24V ? '24' : '12';
            
            return `
                <svg viewBox="0 0 155.08 75.96" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- Prim√§rspule (230V) -->
                        <g>
                            <path class="schematic-line" d="M68.24,23.1c2.63,0,4.79-2.16,4.79-4.79s-2.16-4.79-4.79-4.79v-6.99H11.74"/>
                            <path class="schematic-line" d="M68.24,51.86c2.63,0,4.79,2.16,4.79,4.79s-2.16,4.79-4.79,4.79v6.99H11.74"/>
                            <path class="schematic-line" d="M68.24,23.1c2.63,0,4.79,2.16,4.79,4.79s-2.16,4.79-4.79,4.79"/>
                            <path class="schematic-line" d="M68.24,32.69c2.63,0,4.79,2.16,4.79,4.79s-2.16,4.79-4.79,4.79"/>
                            <path class="schematic-line" d="M68.24,42.27c2.63,0,4.79,2.16,4.79,4.79s-2.16,4.79-4.79,4.79"/>
                        </g>
                        
                        <!-- Sekund√§rspule -->
                        <g>
                            <path class="schematic-line" d="M86.84,23.1c-2.63,0-4.79-2.16-4.79-4.79s2.16-4.79,4.79-4.79v-6.99h56.5"/>
                            <path class="schematic-line" d="M86.84,51.86c-2.63,0-4.79,2.16-4.79,4.79s2.16,4.79,4.79,4.79v6.99s56.5,0,56.5,0"/>
                            <path class="schematic-line" d="M86.84,23.1c-2.63,0-4.79,2.16-4.79,4.79s2.16,4.79,4.79,4.79"/>
                            <path class="schematic-line" d="M86.84,32.69c-2.63,0-4.79,2.16-4.79,4.79s2.16,4.79,4.79,4.79"/>
                            <path class="schematic-line" d="M86.84,42.27c-2.63,0-4.79,2.16-4.79,4.79s2.16,4.79,4.79,4.79"/>
                        </g>
                        
                        <!-- Kern -->
                        <line class="schematic-line" x1="77.1" y1="12.88" x2="77.1" y2="62.08"/>
                        
                        <!-- Anschl√ºsse -->
                        <circle class="schematic-fill-white" cx="6.12" cy="6.52" r="5.62"/>
                        <circle class="schematic-fill-white" cx="6.12" cy="68.43" r="5.62"/>
                        <circle class="schematic-fill-white" cx="148.96" cy="6.52" r="5.62"/>
                        <circle class="schematic-fill-white" cx="148.96" cy="68.43" r="5.62"/>
                        
                        <!-- Beschriftung Eing√§nge -->
                        <text class="schematic-text" x="3.64" y="11.04">P</text>
                        <text class="schematic-text" x="2.4" y="72.96">N</text>
                        <text class="schematic-text" x="23.8" y="42.27">230 V</text>
                        
                        <!-- Beschriftung Ausg√§nge -->
                        <text class="schematic-text" x="145.39" y="10.04">+</text>
                        <text class="schematic-text" x="147.12" y="71.96">-</text>
                        <text class="schematic-text" x="105.8" y="42.27">${outputVoltage} V</text>
                    </g>
                </svg>
            `;
        }
        
        function getFISchematic() {
            return `
                <svg viewBox="0 0 142.16 87.61" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- Hauptschalter L3 -->
                        <g>
                            <line class="schematic-line" x1="74.24" y1="42.86" x2="74.24" y2="74.34"/>
                            <line class="schematic-line" x1="74.24" y1="11.38" x2="74.24" y2="30.54"/>
                            <line class="schematic-line" x1="70.72" y1="30.54" x2="77.73" y2="30.54"/>
                            <line class="schematic-line" x1="74.24" y1="42.86" x2="68.39" y2="32.82"/>
                        </g>
                        
                        <!-- Hauptschalter L1 -->
                        <g>
                            <line class="schematic-line" x1="92.98" y1="42.86" x2="92.98" y2="74.34"/>
                            <line class="schematic-line" x1="92.98" y1="11.38" x2="92.98" y2="30.54"/>
                            <line class="schematic-line" x1="89.46" y1="30.54" x2="96.47" y2="30.54"/>
                            <line class="schematic-line" x1="92.98" y1="42.86" x2="87.13" y2="32.82"/>
                        </g>
                        
                        <!-- Hauptschalter N -->
                        <g>
                            <line class="schematic-line" x1="111.72" y1="42.86" x2="111.72" y2="74.34"/>
                            <line class="schematic-line" x1="111.72" y1="11.38" x2="111.72" y2="30.54"/>
                            <line class="schematic-line" x1="108.21" y1="30.54" x2="115.22" y2="30.54"/>
                            <line class="schematic-line" x1="111.72" y1="42.86" x2="105.87" y2="32.82"/>
                        </g>
                        
                        <!-- Hauptschalter L2 -->
                        <g>
                            <line class="schematic-line" x1="55.5" y1="42.86" x2="55.5" y2="74.34"/>
                            <line class="schematic-line" x1="55.5" y1="11.38" x2="55.5" y2="30.54"/>
                            <line class="schematic-line" x1="51.98" y1="30.54" x2="58.99" y2="30.54"/>
                            <line class="schematic-line" x1="55.5" y1="42.86" x2="49.64" y2="32.82"/>
                        </g>
                        
                        <!-- Mechanische Kopplung (gestrichelt) -->
                        <line class="schematic-line schematic-dashed" x1="127.06" y1="37.84" x2="27.45" y2="37.84"/>
                        
                        <!-- FI-Kern (Ellipse) -->
                        <ellipse class="schematic-line" cx="77.86" cy="60.83" rx="43.16" ry="4.56"/>
                        
                        <!-- Pr√ºftaster -->
                        <rect class="schematic-fill-white" x="127.06" y="30.54" width="7.3" height="7.3"/>
                        <rect class="schematic-fill-white" x="134.36" y="37.84" width="7.3" height="7.3"/>
                        <rect class="schematic-fill-white" x="134.36" y="30.54" width="7.3" height="7.3"/>
                        <rect class="schematic-fill-white" x="127.06" y="37.84" width="7.3" height="7.3"/>
                        
                        <!-- Erdungsleitung -->
                        <line class="schematic-line" x1="111.72" y1="71.36" x2="11.65" y2="71.36"/>
                        <rect class="schematic-fill-white" x="9.44" y="52.04" width="4.42" height="13.35"/>
                        <line class="schematic-line" x1="11.65" y1="65.39" x2="11.65" y2="71.36"/>
                        
                        <!-- FI-Ausl√∂sung -->
                        <line class="schematic-line" x1="111.71" y1="49.17" x2="31.27" y2="49.17"/>
                        <line class="schematic-line" x1="31.27" y1="44.16" x2="31.27" y2="49.17"/>
                        <line class="schematic-line" x1="31.27" y1="44.16" x2="25.42" y2="34.13"/>
                        <polyline class="schematic-line" points="27.45 34.19 27.45 16.01 7.65 16.01 7.65 34.19"/>
                        <line class="schematic-line" x1="11.65" y1="44.16" x2="11.65" y2="52.04"/>
                        <line class="schematic-line" x1="11.37" y1="44.16" x2="5.52" y2="34.13"/>
                        <line class="schematic-line" x1="8.44" y1="39.15" x2=".5" y2="39.15"/>
                        <line class="schematic-line" x1=".5" y1="34.19" x2=".5" y2="42.86"/>
                        
                        <!-- FI-Elektronik -->
                        <rect class="schematic-fill-white" x="127.33" y="57.27" width="12.78" height="7.46"/>
                        <line class="schematic-line schematic-dashed" x1="134.36" y1="45.14" x2="134.36" y2="57.27"/>
                        <polyline class="schematic-line" points="127.06 59.03 124.54 59.03 124.54 56.27 120.17 56.27 117.36 59.08"/>
                        <polyline class="schematic-line" points="127.33 62.37 124.8 62.37 124.8 65.13 120.44 65.13 117.63 62.32"/>
                        
                        <!-- Beschriftung unten -->
                        <text class="schematic-text" x="109.74" y="84.61">N</text>
                        <text class="schematic-text" x="90.34" y="84.61">L1</text>
                        <text class="schematic-text" x="71.49" y="84.61">L2</text>
                        <text class="schematic-text" x="52.8" y="84.61">L3</text>
                        
                        <!-- Beschriftung oben -->
                        <text class="schematic-text" x="109.51" y="10.04">N</text>
                        <text class="schematic-text" x="90.1" y="10.04">L1</text>
                        <text class="schematic-text" x="71.26" y="10.04">L2</text>
                        <text class="schematic-text" x="52.57" y="10.04">L3</text>
                    </g>
                </svg>
            `;
        }
        
        function getLSSchematic() {
            return `
                <svg viewBox="0 0 9.78 86.6" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- LS-Schalter -->
                        <g>
                            <line class="schematic-line" x1="6.29" y1="12.38" x2="6.29" y2="31.54"/>
                            <line class="schematic-line" x1="2.77" y1="31.54" x2="9.78" y2="31.54"/>
                            <polyline class="schematic-line" points="0.43 33.82 6.29 43.86 6.29 75.34"/>
                        </g>
                        
                        <!-- Beschriftung -->
                        <text class="schematic-text" x="2.59" y="83.6">L</text>
                        <text class="schematic-text" x="3.36" y="10.04">L</text>
                    </g>
                </svg>
            `;
        }
        
        function getTimerSchematic() {
            return `
                <svg viewBox="0 0 54.28 78.55" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- Ausgangsklemmleiste -->
                        <rect class="schematic-fill-white" x="0.5" y="0.5" width="52.14" height="21.72"/>
                        <line class="schematic-line" x1="21.33" y1="0.58" x2="21.33" y2="22.03"/>
                        <line class="schematic-line" x1="31.75" y1="0.58" x2="31.75" y2="22.03"/>
                        <line class="schematic-line" x1="10.9" y1="0.58" x2="10.9" y2="22.03"/>
                        <line class="schematic-line" x1="42.18" y1="0.58" x2="42.18" y2="22.03"/>
                        
                        <!-- Eingangsklemmleiste -->
                        <rect class="schematic-fill-white" x="0.5" y="42.24" width="52.14" height="13.68"/>
                        <line class="schematic-line" x1="21.33" y1="42.29" x2="21.33" y2="55.8"/>
                        <line class="schematic-line" x1="31.75" y1="42.29" x2="31.75" y2="55.8"/>
                        <line class="schematic-line" x1="10.9" y1="42.29" x2="10.9" y2="55.8"/>
                        <line class="schematic-line" x1="42.18" y1="42.29" x2="42.18" y2="55.8"/>
                        
                        <!-- Eingangsbeschriftung -->
                        <text class="schematic-text-small" x="23.32" y="51.77">N</text>
                        <text class="schematic-text-small" x="45.16" y="51.77">L</text>
                        
                        <!-- Eingangspunkte -->
                        <circle class="schematic-fill-black" cx="36.88" cy="48.95" r="0.5"/>
                        <circle class="schematic-fill-black" cx="16.1" cy="48.96" r="0.5"/>
                        <circle class="schematic-fill-black" cx="5.25" cy="48.96" r="0.5"/>
                        
                        <!-- Versorgungsleitung -->
                        <line class="schematic-line" x1="26.29" y1="56.02" x2="26.29" y2="63.44"/>
                        <line class="schematic-line" x1="47.35" y1="56.02" x2="47.35" y2="63.17"/>
                        <line class="schematic-line" x1="25.8" y1="63.44" x2="47.89" y2="63.44"/>
                        
                        <!-- Timer-Motor -->
                        <circle class="schematic-fill-white" cx="36.84" cy="63.55" r="4.02"/>
                        <text class="schematic-text" x="33.39" y="67.1">~</text>
                        
                        <!-- Spannungsangabe -->
                        <text class="schematic-text-small" x="21.33" y="76.3">230 V AC</text>
                        
                        <!-- Ausgangsschalter Beschriftung -->
                        <text class="schematic-text-small" transform="translate(29.49 20.12) rotate(-90)">NO</text>
                        <text class="schematic-text-small" transform="translate(50.44 20.21) rotate(-90)">NC</text>
                        <text class="schematic-text-small" transform="translate(40.09 20.53) rotate(-90)">COM</text>
                        
                        <!-- Schalterkontakte -->
                        <line class="schematic-line" x1="36.49" y1="22.28" x2="36.49" y2="30.89"/>
                        <line class="schematic-line" x1="26.19" y1="22.41" x2="26.19" y2="36.14"/>
                        <line class="schematic-line" x1="43.35" y1="35.59" x2="25.68" y2="35.62"/>
                        <line class="schematic-line" x1="47.36" y1="22.26" x2="47.36" y2="26.55"/>
                        <line class="schematic-line" x1="42.45" y1="26.46" x2="47.86" y2="26.46"/>
                        <line class="schematic-line" x1="36.12" y1="30.37" x2="39.46" y2="30.37"/>
                        
                        <!-- Schalter-Kontaktpunkte -->
                        <circle class="schematic-fill-black" cx="43.76" cy="35.6" r="0.97"/>
                        <circle class="schematic-fill-black" cx="39.78" cy="30.39" r="0.97"/>
                        <circle class="schematic-fill-black" cx="42.45" cy="26.46" r="0.97"/>
                        
                        <!-- Schalterbewegung -->
                        <line class="schematic-line" x1="39.78" y1="30.39" x2="43.57" y2="27.35"/>
                        
                        <!-- Ein-/Ausgang-Beschriftung -->
                        <text class="schematic-text-small" x="0.27" y="65.44">IN</text>
                        <text class="schematic-text-small" x="0.27" y="30.89">OUT</text>
                        
                        <!-- Ausgangspunkte -->
                        <circle class="schematic-fill-black" cx="16.04" cy="11.71" r="0.5"/>
                        <circle class="schematic-fill-black" cx="5.19" cy="11.72" r="0.5"/>
                    </g>
                </svg>
            `;
        }
        
        function getD√§mmerungsSchematic() {
            return `
                <svg viewBox="0 0 73.89 99.98" xmlns="http://www.w3.org/2000/svg" style="width: 100%; height: auto; max-height: 120px;">
                    <g>
                        <!-- Hauptgeh√§use -->
                        <rect class="schematic-fill-white" x="2.11" y="60.25" width="70.53" height="39.23"/>
                        
                        <!-- Eingangsleitungen -->
                        <line class="schematic-line" x1="9.03" y1="6.75" x2="73.89" y2="6.75"/>
                        <line class="schematic-line" x1="9.28" y1="20" x2="73.86" y2="20"/>
                        <line class="schematic-line" x1="47.35" y1="33.76" x2="47.35" y2="20.41"/>
                        <line class="schematic-line" x1="57.01" y1="60.33" x2="57.01" y2="7.19"/>
                        <line class="schematic-line" x1="67.01" y1="19.8" x2="67.01" y2="60.28"/>
                        
                        <!-- Lichtsensor -->
                        <g>
                            <circle class="schematic-fill-white" cx="47.7" cy="40.98" r="7.25"/>
                            <line class="schematic-line" x1="42.58" y1="35.85" x2="52.83" y2="46.1"/>
                            <line class="schematic-line" x1="42.57" y1="46.11" x2="52.84" y2="35.83"/>
                        </g>
                        
                        <!-- Photoelement mit Lichtstrahlen -->
                        <g>
                            <line class="schematic-line" x1="35.86" y1="40.39" x2="35.86" y2="59.82"/>
                            <line class="schematic-line" x1="9.82" y1="40.19" x2="9.82" y2="60.26"/>
                            <!-- Photoelement Symbol -->
                            <g>
                                <line class="schematic-line" x1="36.36" y1="40.58" x2="9.31" y2="40.58"/>
                                <line class="schematic-line" x1="30.48" y1="31.43" x2="30.48" y2="49.77"/>
                                <polygon class="schematic-fill-white" points="30.11 40.57 16.39 32.65 16.39 48.49 30.11 40.57"/>
                            </g>
                            <!-- Lichtstrahlen -->
                            <g>
                                <line class="schematic-line" x1="26.56" y1="24.31" x2="22.85" y2="30.63"/>
                                <polygon class="schematic-fill-black" points="22.03 28.65 23.14 30.14 24.97 30.38 21.46 33 22.03 28.65"/>
                            </g>
                            <g>
                                <line class="schematic-line" x1="30.18" y1="26.48" x2="26.47" y2="32.8"/>
                                <polygon class="schematic-fill-black" points="25.65 30.83 26.76 32.31 28.59 32.55 25.08 35.17 25.65 30.83"/>
                            </g>
                        </g>
                        
                        <!-- Anschlusspunkte -->
                        <circle class="schematic-fill-black" cx="47.41" cy="19.65" r="1.13"/>
                        <circle class="schematic-fill-black" cx="57.01" cy="6.45" r="1.13"/>
                        <circle class="schematic-fill-black" cx="67.01" cy="19.8" r="1.13"/>
                        
                        <!-- Eingangsbeschriftung -->
                        <text class="schematic-text" x="0" y="23.29">N</text>
                        <text class="schematic-text" x="0.2" y="10.04">L</text>
                        
                        <!-- Ausgangsbeschriftung -->
                        <text class="schematic-text" x="63.13" y="72.15">N</text>
                        <text class="schematic-text" x="53.78" y="72.15">L</text>
                        <text class="schematic-text" x="43.6" y="72.15">L'</text>
                        
                        <!-- Ausgangsschaltung -->
                        <line class="schematic-line" x1="47.29" y1="73.81" x2="47.29" y2="84.55"/>
                        <line class="schematic-line" x1="57" y1="73.81" x2="57" y2="85.03"/>
                        <line class="schematic-line" x1="46.82" y1="84.59" x2="49.2" y2="84.59"/>
                        <line class="schematic-line" x1="54.77" y1="84.59" x2="57.49" y2="84.59"/>
                        <line class="schematic-line" x1="48.95" y1="84.59" x2="55.13" y2="86.63"/>
                        <line class="schematic-line" x1="47.71" y1="60.33" x2="47.71" y2="48.2"/>
                    </g>
                </svg>
            `;
        }
        
        // ===== KABEL FLEXIBEL =====
        function createKabelFlexibelSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 80 30');
            svg.setAttribute('class', 'component-svg');
            svg.setAttribute('data-component-type', 'kabel-flexibel-sw');
            
            // Platzhalter f√ºr Kabel (wird sp√§ter durch dein SVG ersetzt)
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '5');
            rect.setAttribute('y', '10');
            rect.setAttribute('width', '70');
            rect.setAttribute('height', '10');
            rect.setAttribute('fill', '#333');
            rect.setAttribute('stroke', '#000');
            rect.setAttribute('stroke-width', '2');
            rect.setAttribute('rx', '5');
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '40');
            text.setAttribute('y', '18');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#fff');
            text.setAttribute('font-size', '8');
            text.textContent = 'KABEL';
            
            svg.appendChild(rect);
            svg.appendChild(text);
            return svg;
        }
        
        // ===== MOBILE KLEMME =====
        function createKlemmeMobilSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            // Original: 19.49 x 16.88 * 1.5 + 25px oben = 29.24 x 50.32
            svg.setAttribute('viewBox', '0 0 29.24 50.32');
            svg.setAttribute('class', 'mobile-terminal-svg');
            svg.setAttribute('data-component-type', 'klemme-mobil-3l');
            
            svg.innerHTML = `
                <defs>
                    <style>
                        .klemme-grau { fill: #878787; stroke: #1d1d1b; stroke-miterlimit: 10; }
                        .klemme-orange { fill: #f39200; stroke: #1d1d1b; stroke-miterlimit: 10; }
                        .connection-socket { fill: #666; stroke: #1d1d1b; stroke-width: 1.5; }
                    </style>
                </defs>
                <g transform="translate(0, 25) scale(1.5)">
                    <!-- Grauer Klemmenblock -->
                    <rect class="klemme-grau" x="0.5" y="2.86" width="18.49" height="13.52" rx="3.53" ry="3.53"/>
                    <!-- Orange Anschl√ºsse -->
                    <rect class="klemme-orange" x="2.28" y="0.5" width="3.64" height="12.28" rx="1.82" ry="1.82"/>
                    <rect class="klemme-orange" x="7.93" y="0.5" width="3.64" height="12.28" rx="1.82" ry="1.82"/>
                    <rect class="klemme-orange" x="13.57" y="0.5" width="3.64" height="12.28" rx="1.82" ry="1.82"/>
                </g>
                <!-- Anschlusspunkte als Buchsen (10px √ºber dem Bauteil) -->
                                 <circle class="connection-socket" 
                         cx="5.67" cy="25" r="3" 
                         data-connection-type="terminal-socket"
                         data-connection-id="terminal-1"
                         data-wire-type="universal"
                         data-voltage="400"
                         data-bezier-end-x="5.67" data-bezier-end-y="30"
                         data-bezier-direction="0,-20,0,0"/>
                         
                 <circle class="connection-socket" 
                         cx="14.615" cy="25" r="3" 
                         data-connection-type="terminal-socket"
                         data-connection-id="terminal-2"
                         data-wire-type="universal"
                         data-voltage="400"
                         data-bezier-end-x="14.615" data-bezier-end-y="30"
                         data-bezier-direction="0,-20,0,0"/>
                         
                 <circle class="connection-socket" 
                         cx="23.56" cy="25" r="3" 
                         data-connection-type="terminal-socket"
                         data-connection-id="terminal-3"
                         data-wire-type="universal"
                         data-voltage="400"
                         data-bezier-end-x="23.56" data-bezier-end-y="30"
                         data-bezier-direction="0,-20,0,0"/>
             `;
            
            return svg;
        }
        
        // ===== ENTWICKLER PLATZHALTER =====
        function createDevPlaceholderSVG() {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 60 30');
            svg.setAttribute('class', 'component-svg');
            svg.setAttribute('data-component-type', 'dev-placeholder');
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', '5');
            rect.setAttribute('y', '5');
            rect.setAttribute('width', '50');
            rect.setAttribute('height', '20');
            rect.setAttribute('fill', 'none');
            rect.setAttribute('stroke', '#888');
            rect.setAttribute('stroke-width', '2');
            rect.setAttribute('stroke-dasharray', '5,5');
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '30');
            text.setAttribute('y', '18');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', '#888');
            text.setAttribute('font-size', '8');
            text.textContent = 'DEV';
            
            svg.appendChild(rect);
            svg.appendChild(text);
            return svg;
                }
        
        function getKlemmeSchematic() {
            return `
                <svg viewBox="0 0 26.54 12.86" xmlns="http://www.w3.org/2000/svg" style="width: 33%; height: auto; max-height: 40px;">
                    <defs>
                        <style>
                            .cls-1 { fill: #1d1d1b; }
                            .cls-2 { fill: none; stroke: #1d1d1b; stroke-miterlimit: 10; stroke-width: 1; }
                        </style>
                    </defs>
                    <g>
                        <line class="cls-2" x1="13.27" y1="1.1" x2="13.27" y2="12.36"/>
                        <path class="cls-2" d="M.97.97v11.39h24.6V.97"/>
                        <circle class="cls-1" cx="25.57" cy=".97" r=".97"/>
                        <circle class="cls-1" cx=".97" cy=".97" r=".97"/>
                        <circle class="cls-1" cx="13.27" cy=".97" r=".97"/>
                    </g>
                </svg>
            `;
        }

        // ===== KATEGORIE TOGGLE SYSTEM =====
        function toggleCategory(categoryId) {
            const content = document.getElementById(`category-${categoryId}`);
            const toggle = document.getElementById(`toggle-${categoryId}`);
            
            if (content && toggle) {
                // Toggle collapsed state
                const isCollapsed = content.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // √ñffnen
                    content.classList.remove('collapsed');
                    toggle.classList.remove('collapsed');
                    toggle.textContent = '‚ñº';
                } else {
                    // Schlie√üen
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                    toggle.textContent = '‚ñ∫';
                }
                
                // Status in localStorage speichern
                localStorage.setItem(`category-${categoryId}`, isCollapsed ? 'open' : 'closed');
            }
        }
        
        // Kategorien-Status beim Laden wiederherstellen
        function restoreCategoryStates() {
            const categories = ['schutzschalter', 'steuerungen', 'transformatoren', 'kabel', 'kabelverbindungen', 'entwickler', 'led-module'];
            
            categories.forEach(categoryId => {
                const savedState = localStorage.getItem(`category-${categoryId}`);
                
                // Standard: Alle Kategorien offen, nur Entwickler geschlossen
                const defaultOpen = categoryId !== 'entwickler';
                const shouldBeOpen = savedState ? (savedState === 'open') : defaultOpen;
                
                if (!shouldBeOpen) {
                    const content = document.getElementById(`category-${categoryId}`);
                    const toggle = document.getElementById(`toggle-${categoryId}`);
                    
                    if (content && toggle) {
                        content.classList.add('collapsed');
                        toggle.classList.add('collapsed');
                        toggle.textContent = '‚ñ∫';
                    }
                }
            });
        }

        // ===== POWER TOOLTIP SYSTEM =====
        function setupPowerTooltips() {
            console.log('‚ö° Power Tooltips werden eingerichtet...');
            
            // Finde alle Trafos
            const trafos = document.querySelectorAll('[data-component-type^="trafo-"]');
            
            trafos.forEach(trafo => {
                trafo.addEventListener('mouseenter', showPowerTooltip);
                trafo.addEventListener('mouseleave', hidePowerTooltip);
                trafo.addEventListener('mousemove', updatePowerTooltipPosition);
            });
            
            console.log(`‚ö° Power Tooltips f√ºr ${trafos.length} Trafos eingerichtet`);
        }
        
        function showPowerTooltip(e) {
            const trafoId = e.currentTarget.id;
            console.log(`‚ö° showPowerTooltip: Trafo ${trafoId}`);
            
            const powerInfo = getPowerInfoForTrafo(trafoId);
            console.log(`‚ö° powerInfo:`, powerInfo);
            
            if (!powerInfo) {
                console.log(`‚ùå Keine powerInfo f√ºr Trafo ${trafoId}`);
                return;
            }
            
            // Erstelle Tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'power-tooltip';
            tooltip.id = `tooltip-${trafoId}`;
            
            const percentage = (powerInfo.used / powerInfo.max * 100).toFixed(1);
            tooltip.textContent = `${powerInfo.used.toFixed(1)}W / ${powerInfo.max}W (${percentage}%)`;
            
            if (powerInfo.used > powerInfo.max) {
                tooltip.classList.add('overloaded');
            }
            
            console.log(`‚úÖ Tooltip erstellt: ${tooltip.textContent}`);
            document.body.appendChild(tooltip);
            updatePowerTooltipPosition(e);
        }
        
        function hidePowerTooltip(e) {
            const trafoId = e.currentTarget.id;
            const tooltip = document.getElementById(`tooltip-${trafoId}`);
            if (tooltip) {
                tooltip.remove();
            }
        }
        
        function updatePowerTooltipPosition(e) {
            const trafoId = e.currentTarget.id;
            const tooltip = document.getElementById(`tooltip-${trafoId}`);
            if (tooltip) {
                tooltip.style.left = e.clientX + 'px';
                tooltip.style.top = e.clientY + 'px';
            }
        }
        
        function getPowerInfoForTrafo(trafoId) {
            debugLog(`üîç getPowerInfoForTrafo: ${trafoId}`);
            
            if (!window.circuit || !window.circuit.physics) {
                console.log(`‚ùå circuit oder physics nicht verf√ºgbar`);
                return null;
            }
            
            const trafoElement = document.getElementById(trafoId);
            if (!trafoElement) {
                console.log(`‚ùå Trafo Element ${trafoId} nicht gefunden`);
                return null;
            }
            
            const componentType = trafoElement.dataset.componentType;
            debugLog(`üîç componentType: ${componentType}`);
            
            const trafoSpecs = ComponentSpecs[componentType];
            if (!trafoSpecs) {
                console.log(`‚ùå Keine Specs f√ºr ${componentType}`);
                return null;
            }
            
            debugLog(`üîç trafoSpecs:`, trafoSpecs);
            
            const totalPower = window.circuit.physics.calculateTotalLoadOnTransformer(trafoId);
            debugLog(`üîç totalPower: ${totalPower}`);
            
            return {
                used: totalPower,
                max: trafoSpecs.power
            };
        }

        // ===== DEBUG-MODUS =====
        const DEBUG_MODE = false; // üîá AUS f√ºr saubere Console!
        
        function debugLog(message) {
            if (DEBUG_MODE) console.log(message);
        }

        // ===== ANWENDUNGS-INITIALISIERUNG =====
        function initializeApplication() {
                            console.log('üöÄ LED Foundation v0.01.46 - COMPONENTSPECS LOOKUP REPARIERT: Klemmen finden jetzt korrekt die Trafo-Ausgangsspannung!');
            
            // 1. Circuit Simulation initialisieren
            try {
                circuit = new RealtimeSimulation();
                // Globalen Zugriff f√ºr Component-Klassen erm√∂glichen
                window.circuit = circuit;
                circuit.addComponent('power-source-svg', ComponentTypes.POWER_SOURCE, {x: 20, y: 20});
                circuit.start();
                console.log('‚úÖ Circuit Simulation initialisiert');
            } catch (error) {
                console.error('‚ùå Fehler bei Circuit Simulation:', error);
            }
            
            // 2. WorkspaceManager initialisieren
            try {
                workspaceManager = new WorkspaceManager();
                window.workspaceManager = workspaceManager; // Global setzen
                console.log('‚úÖ WorkspaceManager initialisiert');
            } catch (error) {
                console.error('‚ùå Fehler bei WorkspaceManager:', error);
            }
            
            // 3. Drag & Drop initialisieren
            try {
                initializeDragAndDrop();
                console.log('‚úÖ Drag & Drop initialisiert');
            } catch (error) {
                console.error('‚ùå Fehler bei Drag & Drop:', error);
            }
            
            // 4. Connection Hover Effects initialisieren
            try {
                setupConnectionHoverEffects();
                console.log('‚úÖ Connection Hover Effects initialisiert');
            } catch (error) {
                console.error('‚ùå Fehler bei Connection Hover Effects:', error);
            }
            
            // 5. Initial Power State setzen
            try {
                if (circuit) {
                    circuit.powerStateChanged();
                }
                console.log('‚úÖ Initial Power State gesetzt');
            } catch (error) {
                console.error('‚ùå Fehler bei Initial Power State:', error);
            }
            
            // 6. Datasheet Toggle initialisieren
            try {
                const toggle = document.getElementById('datasheet-toggle');
                if (toggle) {
                    toggle.title = 'Datenblatt einklappen';
                }
                console.log('‚úÖ Datasheet Toggle initialisiert');
            } catch (error) {
                console.error('‚ùå Fehler bei Datasheet Toggle:', error);
            }
            
            console.log('üéâ LED-Lernspiel vollst√§ndig initialisiert!');
            
            // Kategorien-Status wiederherstellen
            restoreCategoryStates();
            console.log('üìÇ Kategorien-Status wiederhergestellt');
            
            // üö® CACHE-BUST TEST: Pr√ºfe ob neue hasRequiredLEDConnections da ist
            if (window.workspaceManager && window.workspaceManager.hasRequiredLEDConnections) {
                console.log('üö® CACHE-BUST: hasRequiredLEDConnections Funktion gefunden!');
                console.log('üö® CACHE-BUST: Funktionsl√§nge:', window.workspaceManager.hasRequiredLEDConnections.toString().length);
            } else {
                console.log('‚ùå CACHE-BUST: hasRequiredLEDConnections NICHT gefunden!');
            }
            
            // ‚ö° POWER TOOLTIP: Setup f√ºr Trafo-Leistungsanzeige
            setupPowerTooltips();
            
            // Status-Report ausgeben
            outputStatusReport();
        }

        // ===== ELEKTRISCHE SICHERHEITS-FUNKTIONEN =====
        
        function triggerElectricalDanger(event, message = "‚ö†Ô∏è GEFAHR! Niemals an stromf√ºhrenden Anlagen arbeiten!") {
            // Verhindere die urspr√ºngliche Aktion
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('‚ö°üí• ELEKTRISCHE GEFAHR AUSGEL√ñST!', message);
            
            // 1. Bildschirm-Flash Effekt
            const dangerOverlay = document.createElement('div');
            dangerOverlay.className = 'electrical-danger-overlay';
            document.body.appendChild(dangerOverlay);
            
            // 2. Funken-Effekte an der Mausposition
            if (event) {
                createSparkEffects(event.clientX, event.clientY);
            }
            
            // 3. Warnmeldung anzeigen
            const warningMessage = document.createElement('div');
            warningMessage.className = 'electrical-warning-message';
            warningMessage.innerHTML = `
                <div>‚ö°üíÄ ELEKTRISCHE GEFAHR! ‚ö°üíÄ</div>
                <div style="font-size: 14px; margin-top: 10px;">${message}</div>
                <div style="font-size: 12px; margin-top: 10px; color: #ffff00;">
                    üîí Schalte zuerst den Hauptschalter AUS!
                </div>
            `;
            document.body.appendChild(warningMessage);
            
            // 4. Sound-Effekt (wenn verf√ºgbar)
            playElectricalSound();
            
            // 5. Aufr√§umen nach Animation (3 Sekunden f√ºr bessere Lesbarkeit)
            setTimeout(() => {
                if (dangerOverlay.parentNode) {
                    dangerOverlay.parentNode.removeChild(dangerOverlay);
                }
                if (warningMessage.parentNode) {
                    warningMessage.parentNode.removeChild(warningMessage);
                }
            }, 3000);
            
            return false; // Verhindere weitere Aktionen
        }
        
        function createSparkEffects(x, y) {
            // Erstelle mehrere Funken um die Mausposition
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const spark = document.createElement('div');
                    spark.className = 'spark-effect';
                    
                    // Zuf√§llige Position um den Mausklick
                    const offsetX = (Math.random() - 0.5) * 100;
                    const offsetY = (Math.random() - 0.5) * 100;
                    
                    spark.style.left = (x + offsetX) + 'px';
                    spark.style.top = (y + offsetY) + 'px';
                    
                    document.body.appendChild(spark);
                    
                    // Funke nach Animation entfernen
                    setTimeout(() => {
                        if (spark.parentNode) {
                            spark.parentNode.removeChild(spark);
                        }
                    }, 300);
                }, i * 50);
            }
        }
        
        function playElectricalSound() {
            // Erstelle einen kurzen "Zap" Sound mit Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Elektrischer "Zap" Sound
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (error) {
                console.log('üîá Audio-Kontext nicht verf√ºgbar:', error);
            }
        }
        
        function checkElectricalSafety(event, action) {
            if (systemPower) {
                console.log(`üö® SICHERHEITSWARNUNG: Versuch ${action} bei eingeschaltetem Hauptschalter!`);
                triggerElectricalDanger(event, `Niemals ${action} bei eingeschaltetem Strom!`);
                return false;
            }
            return true;
        }

        function outputStatusReport() {
            console.log('\n=== LED-LERNSPIEL STATUS REPORT ===');
            console.log('üì¶ Module geladen:');
            console.log('   ‚úÖ Circuit Simulation Engine');
            console.log('   ‚úÖ Component Library');
            console.log('   ‚úÖ Workspace Manager');
            console.log('   ‚úÖ Main Application');
            
            console.log('\nüéÆ Verf√ºgbare Funktionen:');
            console.log('   ‚Ä¢ Drag & Drop von Bauteilen aus der Sidebar');
            console.log('   ‚Ä¢ Bauteil-Auswahl (Einzeln & Mehrfach)');
            console.log('   ‚Ä¢ Rechteck-Auswahl f√ºr Gruppen');
            console.log('   ‚Ä¢ Bauteile verschieben und rotieren (Doppelklick)');
            console.log('   ‚Ä¢ Bauteile l√∂schen (Delete/Backspace)');
            console.log('   ‚Ä¢ Verbindungen zwischen Anschlusspunkten');
            console.log('   ‚Ä¢ Verbindungen l√∂schen (Klick auf Verbindung)');
            console.log('   ‚Ä¢ Echtzeit Physik-Simulation');
            console.log('   ‚Ä¢ Technische Datenbl√§tter (Hover √ºber Bauteile)');
            console.log('   ‚Ä¢ Hauptschalter f√ºr Stromversorgung');
            
            console.log('\nüéØ Tastatur-Shortcuts:');
            console.log('   ‚Ä¢ Strg + Klick: Mehrfachauswahl');
            console.log('   ‚Ä¢ Doppelklick: 90¬∞ Rotation');
            console.log('   ‚Ä¢ Delete/Backspace: L√∂schen');
            console.log('   ‚Ä¢ Escape: Auswahl aufheben');
            console.log('   ‚Ä¢ Strg + 1/2/3: Test-Funktionen (geplant)');
            
            console.log('\nüìä Verf√ºgbare Bauteile:');
            console.log('   ‚Ä¢ LED-Module (12V 1,2W, 24V 5W)');
            console.log('   ‚Ä¢ Transformatoren (12V 40W, 24V 60W)');
            console.log('   ‚Ä¢ Schutzschalter (FI, LS)');
            console.log('   ‚Ä¢ Steuerungen (Timer, D√§mmerung)');
            
            console.log('\n‚ö° System bereit f√ºr Schaltungsaufbau!');
            console.log('===================================\n');
        }

        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('üö® JavaScript Fehler:', event.error);
            console.error('üìç Datei:', event.filename);
            console.error('üìç Zeile:', event.lineno);
            console.error('üìç Spalte:', event.colno);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('üö® Unbehandelte Promise Rejection:', event.reason);
            event.preventDefault();
        });

        // ===== DOM READY EVENT =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM Content Loaded - Starte Initialisierung...');
            
            // Kleine Verz√∂gerung f√ºr alle Module
            setTimeout(() => {
                initializeApplication();
            }, 100);
        });

        console.log('üéØ App.js geladen - Warte auf DOM Ready...');

        // ===== DEBUG: VISUELLER ZENTRUM-VERGLEICH =====
        function addRotationDebugPoints() {
            // Alle LED-Module finden
            const components = document.querySelectorAll('[data-component-type="led-12v-1.2w"]');
            
            components.forEach(component => {
                const svg = component.querySelector('svg');
                if (!svg) return;
                
                // DEBUG-PUNKT 1: CSS-Transform (echte Anschluss-Position)
                const cssPoint = document.createElement('div');
                cssPoint.style.position = 'absolute';
                cssPoint.style.width = '6px';
                cssPoint.style.height = '6px';
                cssPoint.style.backgroundColor = 'red';
                cssPoint.style.borderRadius = '50%';
                cssPoint.style.zIndex = '1000';
                cssPoint.style.pointerEvents = 'none';
                
                // Position relativ zum SVG (wie echte Anschlusspunkte)
                cssPoint.style.left = '19px'; // Bezier-Start-X aus data-attribute
                cssPoint.style.top = '12.225px'; // Bezier-Start-Y aus data-attribute
                cssPoint.style.transformOrigin = 'center center';
                
                // Gleiche Rotation wie Component
                const rotation = window.workspaceManager?.componentRotations?.get(component) || 0;
                cssPoint.style.transform = `rotate(${rotation}deg)`;
                
                svg.appendChild(cssPoint);
                
                console.log('üî¥ CSS Debug-Punkt hinzugef√ºgt f√ºr Rotation:', rotation);
            });
        }

        // DEBUG aktivieren (nach DOM-Load)
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addRotationDebugPoints();
                console.log('üéØ Rotation Debug-Punkte aktiviert! Rote Punkte = CSS Transform');
            }, 2000);
        });

        // ===== TEMPORARY DEBUG: COMPONENT SIZE ANALYSIS =====
        function debugComponentSizes() {
            const components = document.querySelectorAll('.component');
            console.log('üîç Found', components.length, 'components');
            
            components.forEach((component, index) => {
                const svg = component.querySelector('svg');
                if (svg) {
                    const isLED = svg.classList.contains('led-module-svg');
                    console.log('üîç Component #' + index + ':', svg.classList.toString(), 'isLED:', isLED);
                    
                    if (isLED) {
                        const containerRect = component.getBoundingClientRect();
                        const svgRect = svg.getBoundingClientRect();
                        const svgStyle = window.getComputedStyle(svg);
                        
                        console.log('üîç COMPONENT SIZE DEBUG #' + index + ':');
                        console.log('   Container:', containerRect.width, 'x', containerRect.height);
                        console.log('   SVG Rect:', svgRect.width, 'x', svgRect.height);
                        console.log('   SVG CSS:', svgStyle.width, 'x', svgStyle.height);
                        console.log('   ViewBox:', svg.getAttribute('viewBox'));
                        console.log('   Difference Y:', containerRect.height - svgRect.height);
                    }
                }
            });
        }

        // Debug beim Component-Drop aktivieren
        document.addEventListener('click', (e) => {
            if (e.target.closest('.component')) {
                setTimeout(debugComponentSizes, 100);
            }
        });
    </script>
</body>
</html>