<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED & EVG Drag-and-Drop Werkbank</title>
    <style>
        /* ========== DESIGN SYSTEM VARIABLEN ========== */
        :root {
            /* Schrift-Hierarchie */
            --font-family: Arial, sans-serif;
            --font-size-h1: 18px;          /* Hauptüberschriften */
            --font-size-h2: 14px;          /* Unterüberschriften, Bauteiltitel, Buttons */
            --font-size-text: 16px;        /* Fließtext */
            --font-size-small: 12px;       /* Technische Spezifikationen */
            
            --font-weight-h1: bold;
            --font-weight-h2: bold;
            --font-weight-text: normal;
            --font-weight-small: normal;
            
            /* Farben */
            --color-primary: #333;
            --color-secondary: #666;
            --color-light: #f8f9fa;
            --color-border: #dee2e6;
            --color-hover: #e8f5e8;
            --color-hover-border: #4CAF50;
            --color-background: #f0f0f0;
            --color-white: white;
            
            /* Status-Farben */
            --color-success: #008800;
            --color-error: #cc0000;
            --color-warning: #856404;
            --color-success-bg: #e6ffe6;
            --color-error-bg: #ffe6e6;
            --color-warning-bg: #fff3cd;
            
            /* Abstände */
            --spacing-xs: 5px;
            --spacing-sm: 8px;
            --spacing-md: 10px;
            --spacing-lg: 15px;
            --spacing-xl: 20px;
            
            /* Rahmen und Schatten */
            --border-radius: 8px;
            --border-width: 2px;
            --border-color: #333;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --box-shadow-hover: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        /* ========== GRUNDLEGENDE STYLES ========== */
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--color-background);
            display: flex;
            height: 100vh;
        }
        
        /* ========== TYPOGRAPHIE-SYSTEM ========== */
        .text-h1 {
            font-size: var(--font-size-h1);
            font-weight: var(--font-weight-h1);
            color: var(--color-primary);
            margin: 0;
            padding-bottom: var(--spacing-md);
            border-bottom: var(--border-width) solid #eee;
        }
        
        .text-h2 {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin: 0;
        }
        
        .text-body {
            font-size: var(--font-size-text);
            font-weight: var(--font-weight-text);
            color: var(--color-secondary);
            line-height: 1.5;
            margin: 0;
        }
        
        .text-small {
            font-size: var(--font-size-small);
            font-weight: var(--font-weight-small);
            color: var(--color-secondary);
            line-height: 1.4;
        }
        
        /* ========== LAYOUT SYSTEM ========== */
        .layout-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        .sidebar-left {
            width: 260px;
            background: var(--color-white);
            border-right: var(--border-width) solid var(--border-color);
            padding: var(--spacing-lg);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0;
            transition: width 0.3s ease, padding 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-left.collapsed {
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-xl);
            min-width: 0;
        }
        
        .task-area {
            background: var(--color-white);
            border: var(--border-width) solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--box-shadow);
            position: relative;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .task-menu-btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }
        
        .task-menu-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }
        
        .workspace {
            flex: 1;
            background: var(--color-white);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
            min-height: 400px;
        }
        
        .workspace-info-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            width: 30px;
            height: 30px;
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: bold;
            color: var(--color-primary);
            z-index: 100;
        }
        
        .workspace-info-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: scale(1.1);
        }
        
        .info-tooltip {
            position: absolute;
            top: 40px;
            right: 0;
            width: 300px;
            background: var(--color-white);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--box-shadow);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .workspace-info-btn:hover + .info-tooltip,
        .info-tooltip:hover {
            opacity: 1;
            visibility: visible;
        }
        
        .info-category {
            margin-bottom: var(--spacing-lg);
        }
        
        .info-category:last-child {
            margin-bottom: 0;
        }
        
        .info-category-title {
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            border-bottom: 1px solid #eee;
            padding-bottom: var(--spacing-xs);
        }
        
        .info-rule {
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }
        
        .info-rule:last-child {
            margin-bottom: 0;
        }
        
        /* ========== KOMPONENTEN-SYSTEM ========== */
        .components-section {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .components-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-sm);
        }
        
        .components-list {
            flex: 1;
            overflow-y: auto;
            padding-right: var(--spacing-xs);
        }
        
        .datasheet-section {
            flex-shrink: 0;
            height: 300px;
            display: flex;
            flex-direction: column;
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }
        
        .datasheet-header {
            flex-shrink: 0;
            margin-bottom: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .datasheet-toggle {
            background: var(--color-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-small);
            color: var(--color-secondary);
            min-width: 60px;
            text-align: center;
        }
        
        .datasheet-toggle:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
        }
        
        .datasheet-section.collapsed {
            height: auto;
        }
        
        .datasheet-section.collapsed .datasheet-content {
            display: none;
        }
        
        .component-item {
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .component-item:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .component-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }
        
        .component-name {
            margin-bottom: var(--spacing-xs);
        }
        
        .component-category {
            border-bottom: var(--border-width) solid #eee;
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .category-title {
            margin-bottom: var(--spacing-md);
        }
        
        /* ========== BUTTON-SYSTEM ========== */
        .btn {
            background: var(--color-light);
            color: var(--color-primary);
            border: var(--border-width) solid var(--color-border);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            margin: var(--spacing-xs);
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            font-family: var(--font-family);
            min-width: 120px;
        }
        
        .btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            border-color: #ccc;
            transform: none;
        }
        
        /* ========== FUNKTIONS-BUTTONS IM AUFGABENBEREICH ========== */
        .function-controls {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: var(--border-width) solid #eee;
            justify-content: flex-start;
            align-items: center;
        }
        
        .function-controls .btn {
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
            justify-content: center;
            min-width: 0;
        }
        
        .power-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }
        
        .power-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .btn-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        /* ========== STATUS-SYSTEM ========== */
        .status {
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            border-radius: var(--spacing-xs);
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }
        
        .status.disconnected {
            background: var(--color-error-bg);
            color: var(--color-error);
        }
        
        .status.connected {
            background: var(--color-success-bg);
            color: var(--color-success);
        }
        
        .status.partial {
            background: var(--color-warning-bg);
            color: var(--color-warning);
        }
        
        /* ========== TOGGLE BUTTONS ========== */
        .toggle-btn {
            position: absolute;
            top: var(--spacing-xl);
            z-index: 1000;
            background: var(--color-light);
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
            color: var(--color-primary);
            box-shadow: var(--box-shadow);
        }
        
        .toggle-btn:hover {
            border-color: var(--color-hover-border);
            background: var(--color-hover);
            transform: translateY(-1px);
        }
        
        .toggle-left {
            left: var(--spacing-md);
        }
        
        .component {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: border 0.3s ease;
            border: var(--border-width) solid transparent;
        }
        
        .component:hover {
            border: var(--border-width) solid var(--color-hover-border);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }
        
        .component.dragging {
            z-index: 1000;
            border: var(--border-width) solid #FF9800;
            box-shadow: 0 0 12px rgba(255, 152, 0, 0.5);
        }
        
        .power-source {
            position: absolute;
            top: var(--spacing-xl);
            left: var(--spacing-xl);
            background: var(--color-warning-bg);
            border: 3px solid #ffc107;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            color: var(--color-warning);
            box-shadow: var(--box-shadow);
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }
        
        /* ========== VERBINDUNGEN ========== */
        .connection-point {
            cursor: crosshair;
            transition: all 0.3s ease;
        }
        
        .connection-point:hover {
            transform: scale(1.5);
            opacity: 1 !important;
        }
        
        .connection-point.dragging-connection {
            opacity: 1 !important;
            transform: scale(1.8);
        }
        
        .bezier-connection {
            fill: none;
            stroke-width: 3;
            opacity: 1;
        }
        
        .bezier-connection.red-wire {
            stroke: #ff0000;
        }
        
        .bezier-connection.black-wire {
            stroke: #000000;
        }
        
        .led-cable {
            fill: none;
            stroke-width: 3;
            pointer-events: none;
        }
        
        .led-cable.plus {
            stroke: #ff0000;
        }
        
        .led-cable.minus {
            stroke: #000000;
        }
        
        .temp-line {
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 5,5;
            opacity: 0.7;
        }
        
        /* ========== TECHNISCHES DATENBLATT ========== */
        .technical-datasheet {
            flex-shrink: 0;
        }
        
        .datasheet-content {
            height: 200px;
            overflow-y: auto;
            padding: var(--spacing-md) 0;
            border: var(--border-width) solid var(--color-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            background: var(--color-light);
        }
        
        .info-box {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--color-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
        }
        
        .info-box h4 {
            margin-top: 0;
            color: var(--color-primary);
            font-size: var(--font-size-h2);
            font-weight: var(--font-weight-h2);
        }
        
        .info-box p {
            margin-bottom: var(--spacing-sm);
        }
        
        .info-box p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="layout-container">
        <!-- Linke Sidebar: Technisches Datenblatt + Bauteilmenü -->
        <div class="sidebar-left">
            <!-- Technisches Datenblatt -->
            <div class="datasheet-section" id="datasheet-section">
                <div class="datasheet-header">
                    <h3 class="text-h1">Technisches Datenblatt</h3>
                    <button class="datasheet-toggle" onclick="toggleDatasheet()" id="datasheet-toggle">
                        ▲
                    </button>
                </div>
                
                <div class="technical-datasheet">
                    <div class="datasheet-content" id="datasheet-content-wrapper">
                        <div id="datasheet-content" class="text-small">
                            <p><em>Bewege den Cursor über ein Bauteil, um technische Informationen und Schaltskizzen anzuzeigen.</em></p>
                            
                            <div class="info-box">
                                <h4>Grundlagen</h4>
                                <p class="text-small">
                                    <strong>Spannung:</strong> 12V LEDs benötigen 12V Transformatoren<br>
                                    <strong>Leistung:</strong> Gesamtleistung aller LEDs darf Transformator-Leistung nicht überschreiten<br>
                                    <strong>Polarität:</strong> Plus (+) an Plus, Minus (-) an Minus
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bauteile-Sektion -->
            <div class="components-section">
                <div class="components-header">
                    <h2 class="text-h1">Bauteile</h2>
                </div>
                
                <div class="components-list">
                    <!-- Schutzschalter -->
                    <div class="component-category">
                        <div class="category-title text-h2">Schutzschalter</div>
                        <div class="component-item" data-component-type="fi-schalter">
                            <div class="component-name text-h2">FI-Schutzschalter</div>
                            <div class="component-specs text-small">
                                30mA, 16A<br>
                                Fehlerstromschutz
                            </div>
                        </div>
                        <div class="component-item" data-component-type="ls-schalter">
                            <div class="component-name text-h2">LS-Schalter</div>
                            <div class="component-specs text-small">
                                16A, Überlastschutz<br>
                                Charakteristik B
                            </div>
                        </div>
                    </div>
                    
                    <!-- Steuerungen -->
                    <div class="component-category">
                        <div class="category-title text-h2">Steuerungen</div>
                        <div class="component-item" data-component-type="zeitschaltuhr">
                            <div class="component-name text-h2">Zeitschaltuhr</div>
                            <div class="component-specs text-small">
                                Digital, 16A<br>
                                Tages-/Wochenprogramm
                            </div>
                        </div>
                        <div class="component-item" data-component-type="daemmerungsschalter">
                            <div class="component-name text-h2">Dämmerungsschalter</div>
                            <div class="component-specs text-small">
                                10A, einstellbar<br>
                                2-200 Lux
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transformatoren -->
                    <div class="component-category">
                        <div class="category-title text-h2">Transformatoren</div>
                        <div class="component-item" data-component-type="trafo-12v-40w">
                            <div class="component-name text-h2">Trafo 12V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 12V DC, 40W
                            </div>
                        </div>
                        <div class="component-item" data-component-type="trafo-24v-60w">
                            <div class="component-name text-h2">Trafo 24V</div>
                            <div class="component-specs text-small">
                                Eingang: 230V AC<br>
                                Ausgang: 24V DC, 60W
                            </div>
                        </div>
                    </div>
                    
                    <!-- LED-Module -->
                    <div class="component-category">
                        <div class="category-title text-h2">LED-Module</div>
                        <div class="component-item" data-component-type="led-12v-3.5w">
                            <div class="component-name text-h2">LED-Modul 12V</div>
                            <div class="component-specs text-small">
                                3,5W, Warmweiß<br>
                                12V DC
                            </div>
                        </div>
                        <div class="component-item" data-component-type="led-24v-5w">
                            <div class="component-name text-h2">LED-Modul 24V</div>
                            <div class="component-specs text-small">
                                5W, Warmweiß<br>
                                24V DC
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mittlerer Bereich: Aufgabe + Arbeitsfläche -->
        <div class="main-area">
            <!-- Aufgabenstellung mit Funktions-Buttons -->
            <div class="task-area">
                <div class="task-header">
                    <h3 class="text-h1">Aufgabenstellung</h3>
                    <button class="task-menu-btn" onclick="openTaskMenu()">
                        Zum Aufgaben-Menü
                    </button>
                </div>
                
                <p class="text-body">
                    Baue eine Schaltung mit einem 12V Transformator und verbinde die LED-Module korrekt. 
                    Achte auf die richtige Polarität und die maximale Leistung des Transformators.
                </p>
                
                <!-- Funktions-Buttons -->
                <div class="function-controls">
                    <button id="powerBtn" class="btn" onclick="togglePower()">
                        <span class="power-icon">
                            <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                        <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                        <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                        <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                        <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                      x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                                <g>
                                    <g>
                                        <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                                 points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                              x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                        <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                              x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                    </g>
                                    <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                          x="5.36" y="7.68" width="11.18" height="4.98"/>
                                    <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                          transform="translate(6.36 11.7)">
                                        <tspan x="0" y="0">O</tspan>
                                        <tspan x="2.92" y="0">-</tspan>
                                        <tspan x="4.27" y="0">off</tspan>
                                    </text>
                                </g>
                            </svg>
                        </span>
                        <span class="btn-text">
                            <span>Haupt-</span>
                            <span>schalter</span>
                        </span>
                    </button>
                    
                    <button class="btn" onclick="clearWorkspace()">
                        Arbeitsfläche leeren
                    </button>
                    
                    <button class="btn" onclick="resetConnections()">
                        Verbindungen zurücksetzen
                    </button>
                </div>
            </div>
            
            <!-- Arbeitsfläche -->
            <div class="workspace" id="workspace">
                <!-- Info Button -->
                <div class="workspace-info-btn" id="info-btn">
                    i
                </div>
                <div class="info-tooltip" id="info-tooltip">
                    <div class="info-category">
                        <div class="info-category-title">Bauteile</div>
                        <div class="info-rule">• Aus Sidebar ziehen zum Platzieren</div>
                        <div class="info-rule">• Klick: Einzelnes Bauteil auswählen</div>
                        <div class="info-rule">• Strg + Klick: Mehrere Bauteile auswählen</div>
                        <div class="info-rule">• Rechteck aufziehen: Gruppenauswahl</div>
                        <div class="info-rule">• Doppelklick: 90° Drehung</div>
                        <div class="info-rule">• Ziehen: Ausgewählte Bauteile verschieben</div>
                        <div class="info-rule">• Entf-Taste: Ausgewählte Bauteile löschen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Verbindungen</div>
                        <div class="info-rule">• Anschlusspunkte verbinden durch Klicken und Ziehen</div>
                        <div class="info-rule">• Klick auf Verbindung: Auswählen</div>
                        <div class="info-rule">• Entf-Taste: Ausgewählte Verbindung löschen</div>
                    </div>
                    
                    <div class="info-category">
                        <div class="info-category-title">Allgemein</div>
                        <div class="info-rule">• Klick ins Leere: Auswahl aufheben</div>
                        <div class="info-rule">• Esc-Taste: Alle Auswahlen aufheben</div>
                        <div class="info-rule">• Strg + Z: Rückgängig (geplant)</div>
                    </div>
                </div>
                
                <!-- Feste Stromquelle -->
                <div class="power-source">
                    ⚡ 230V Netzanschluss
                </div>
                
                <!-- Connection lines SVG overlay -->
                <svg id="connectionSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <!-- Verbindungen werden hier gezeichnet -->
                </svg>
            </div>
        </div>
    </div>

    <script>
        // ========== GLOBALE VARIABLEN ==========
        let systemPower = false;
        let connections = [];
        let components = [];
        let circuit = null;
        
        // ========== BAUTEIL-DEFINITIONEN ==========
        const ComponentTypes = {
            POWER_SOURCE: 'power-source',
            TRANSFORMER_12V: 'trafo-12v-40w',
            TRANSFORMER_24V: 'trafo-24v-60w',
            LED_12V: 'led-12v-3.5w',
            LED_24V: 'led-24v-5w',
            FI_SWITCH: 'fi-schalter',
            LS_SWITCH: 'ls-schalter'
        };
        
        const ComponentSpecs = {
            [ComponentTypes.POWER_SOURCE]: {
                voltage: 230,
                maxCurrent: 16,
                type: 'source'
            },
            [ComponentTypes.TRANSFORMER_12V]: {
                inputVoltage: 230,
                outputVoltage: 12,
                maxPower: 40,
                type: 'transformer'
            },
            [ComponentTypes.TRANSFORMER_24V]: {
                inputVoltage: 230,
                outputVoltage: 24,
                maxPower: 60,
                type: 'transformer'
            },
            [ComponentTypes.LED_12V]: {
                ratedVoltage: 12,
                power: 3.5,
                tolerance: 0.2, // 20% Toleranz
                type: 'load'
            },
            [ComponentTypes.LED_24V]: {
                ratedVoltage: 24,
                power: 5,
                tolerance: 0.2,
                type: 'load'
            }
        };
        
        // ========== ZUSTANDSMASCHINEN ==========
        const ComponentStates = {
            OFF: 'off',
            ON: 'on',
            BLINKING: 'blinking',
            BROKEN: 'broken',
            OVERLOADED: 'overloaded'
        };
        
        class ComponentStateMachine {
            constructor(componentType, elementId) {
                this.type = componentType;
                this.elementId = elementId;
                this.state = ComponentStates.OFF;
                this.specs = ComponentSpecs[componentType];
                this.currentVoltage = 0;
                this.currentPower = 0;
            }
            
            updateState(voltage, current) {
                this.currentVoltage = voltage;
                this.currentPower = voltage * current;
                
                const previousState = this.state;
                
                if (this.specs.type === 'load') { // LEDs
                    this.state = this.calculateLEDState(voltage);
                } else if (this.specs.type === 'transformer') {
                    this.state = this.calculateTransformerState();
                }
                
                if (previousState !== this.state) {
                    this.animateStateChange();
                }
            }
            
            calculateLEDState(voltage) {
                if (voltage === 0) return ComponentStates.OFF;
                
                const ratedVoltage = this.specs.ratedVoltage;
                const tolerance = this.specs.tolerance;
                
                // Überspannung - LED geht kaputt
                if (voltage > ratedVoltage * (1 + tolerance * 3)) {
                    return ComponentStates.BROKEN;
                }
                
                // Leichte Überspannung - LED blinkt
                if (voltage > ratedVoltage * (1 + tolerance)) {
                    return ComponentStates.BLINKING;
                }
                
                // Korrekte Spannung - LED leuchtet
                if (voltage >= ratedVoltage * (1 - tolerance)) {
                    return ComponentStates.ON;
                }
                
                // Unterspannung - LED aus
                return ComponentStates.OFF;
            }
            
            calculateTransformerState() {
                if (this.currentPower > this.specs.maxPower * 1.2) {
                    return ComponentStates.BROKEN;
                }
                if (this.currentPower > this.specs.maxPower) {
                    return ComponentStates.OVERLOADED;
                }
                return this.currentVoltage > 0 ? ComponentStates.ON : ComponentStates.OFF;
            }
            
            animateStateChange() {
                const element = document.getElementById(this.elementId);
                if (!element) return;
                
                // Entferne alte Zustandsklassen
                element.classList.remove('state-off', 'state-on', 'state-blinking', 'state-broken', 'state-overloaded');
                
                // Füge neue Zustandsklasse hinzu
                element.classList.add(`state-${this.state}`);
                
                // Console-Log für Debugging
                console.log(`${this.type} (${this.elementId}): ${this.state} (${this.currentVoltage}V, ${this.currentPower.toFixed(2)}W)`);
            }
        }
        
        // ========== GRAPH-ANALYSE ==========
        class CircuitGraph {
            constructor() {
                this.nodes = new Map(); // componentId -> component data
                this.edges = new Map(); // connectionId -> {from, to, wire}
                this.stateMachines = new Map(); // componentId -> StateMachine
            }
            
            addComponent(id, type, position) {
                this.nodes.set(id, {
                    id: id,
                    type: type,
                    position: position,
                    connections: new Set()
                });
                
                // Erstelle Zustandsmaschine für Bauteil
                this.stateMachines.set(id, new ComponentStateMachine(type, id));
                
                console.log(`Bauteil hinzugefügt: ${type} (${id})`);
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.edges.set(id, {
                    from: fromComponent,
                    to: toComponent
                });
                
                // Verbindungen in Komponenten eintragen
                if (this.nodes.has(fromComponent)) {
                    this.nodes.get(fromComponent).connections.add(toComponent);
                }
                if (this.nodes.has(toComponent)) {
                    this.nodes.get(toComponent).connections.add(fromComponent);
                }
                
                console.log(`Verbindung erstellt: ${fromComponent} → ${toComponent}`);
            }
            
            findPath(startNode, endNode, visited = new Set()) {
                if (startNode === endNode) return [startNode];
                if (visited.has(startNode)) return null;
                
                visited.add(startNode);
                
                const component = this.nodes.get(startNode);
                if (!component) return null;
                
                for (const neighbor of component.connections) {
                    const path = this.findPath(neighbor, endNode, new Set(visited));
                    if (path) {
                        return [startNode, ...path];
                    }
                }
                
                return null;
            }
            
            getConnectedComponents(startNode) {
                const visited = new Set();
                const connected = [];
                
                const dfs = (nodeId) => {
                    if (visited.has(nodeId)) return;
                    visited.add(nodeId);
                    connected.push(nodeId);
                    
                    const component = this.nodes.get(nodeId);
                    if (component) {
                        for (const neighbor of component.connections) {
                            dfs(neighbor);
                        }
                    }
                };
                
                dfs(startNode);
                return connected;
            }
        }
        
        // ========== PHYSIK-ENGINE ==========
        class PhysicsEngine {
            constructor(graph) {
                this.graph = graph;
            }
            
            calculateCircuit() {
                if (!systemPower) {
                    this.powerOffAllComponents();
                    return;
                }
                
                // Finde Stromquelle
                const powerSource = this.findPowerSource();
                if (!powerSource) {
                    console.log('Keine Stromquelle gefunden');
                    return;
                }
                
                // Finde alle mit Stromquelle verbundenen Komponenten
                const connectedComponents = this.graph.getConnectedComponents(powerSource);
                console.log('Verbundene Komponenten:', connectedComponents);
                
                // Berechne Spannungen und Ströme
                this.calculateVoltagesAndCurrents(connectedComponents);
            }
            
            findPowerSource() {
                for (const [id, component] of this.graph.nodes) {
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        return id;
                    }
                }
                return null;
            }
            
            calculateVoltagesAndCurrents(components) {
                for (const componentId of components) {
                    const component = this.graph.nodes.get(componentId);
                    const stateMachine = this.graph.stateMachines.get(componentId);
                    
                    if (!component || !stateMachine) continue;
                    
                    let voltage = 0;
                    let current = 0;
                    
                    if (component.type === ComponentTypes.POWER_SOURCE) {
                        voltage = ComponentSpecs[component.type].voltage;
                        current = this.calculateSourceCurrent(componentId);
                    } else {
                        const result = this.calculateComponentPower(componentId);
                        voltage = result.voltage;
                        current = result.current;
                    }
                    
                    stateMachine.updateState(voltage, current);
                }
            }
            
            calculateComponentPower(componentId) {
                const component = this.graph.nodes.get(componentId);
                
                // Vereinfachte Berechnung - finde verbundene Transformatoren
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (connectedComponent && ComponentSpecs[connectedComponent.type].type === 'transformer') {
                        const specs = ComponentSpecs[connectedComponent.type];
                        return {
                            voltage: specs.outputVoltage,
                            current: ComponentSpecs[component.type].power / specs.outputVoltage
                        };
                    }
                }
                
                // Direkt an Netz angeschlossen
                for (const connectedId of component.connections) {
                    const connectedComponent = this.graph.nodes.get(connectedId);
                    if (connectedComponent && connectedComponent.type === ComponentTypes.POWER_SOURCE) {
                        return {
                            voltage: ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage,
                            current: ComponentSpecs[component.type].power / ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage
                        };
                    }
                }
                
                return { voltage: 0, current: 0 };
            }
            
            calculateSourceCurrent(sourceId) {
                // Vereinfachte Stromberechnung
                let totalCurrent = 0;
                const connectedComponents = this.graph.getConnectedComponents(sourceId);
                
                for (const componentId of connectedComponents) {
                    const component = this.graph.nodes.get(componentId);
                    if (component && ComponentSpecs[component.type].type === 'load') {
                        const specs = ComponentSpecs[component.type];
                        totalCurrent += specs.power / ComponentSpecs[ComponentTypes.POWER_SOURCE].voltage;
                    }
                }
                
                return totalCurrent;
            }
            
            powerOffAllComponents() {
                for (const [id, stateMachine] of this.graph.stateMachines) {
                    stateMachine.updateState(0, 0);
                }
            }
        }
        
        // ========== ECHTZEIT-SYSTEM ==========
        class RealtimeSimulation {
            constructor() {
                this.graph = new CircuitGraph();
                this.physics = new PhysicsEngine(this.graph);
                this.isRunning = false;
            }
            
            start() {
                this.isRunning = true;
                console.log('🔄 Echtzeit-Simulation gestartet');
            }
            
            stop() {
                this.isRunning = false;
                console.log('⏸️ Echtzeit-Simulation gestoppt');
            }
            
            update() {
                if (!this.isRunning) return;
                this.physics.calculateCircuit();
            }
            
            addComponent(id, type, position) {
                this.graph.addComponent(id, type, position);
                this.update();
            }
            
            addConnection(id, fromComponent, toComponent) {
                this.graph.addConnection(id, fromComponent, toComponent);
                this.update();
            }
            
            powerStateChanged() {
                console.log(`⚡ Hauptschalter: ${systemPower ? 'EIN' : 'AUS'}`);
                this.update();
            }
        }
        
        // ========== INITIALISIERUNG ==========
        
        // Erstelle globale Simulation
        circuit = new RealtimeSimulation();
        
        // Füge initiale Komponenten hinzu (Netzanschluss)
        circuit.addComponent('power-source-1', ComponentTypes.POWER_SOURCE, {x: 20, y: 20});
        circuit.start();
        
        // ========== ZENTRALE BEDIENREGELN ==========
        const workspaceRules = {
            components: {
                title: "Bauteile",
                rules: [
                    "Aus Sidebar ziehen zum Platzieren",
                    "Klick: Einzelnes Bauteil auswählen", 
                    "Strg + Klick: Mehrere Bauteile auswählen",
                    "Rechteck aufziehen: Gruppenauswahl",
                    "Doppelklick: 90° Drehung",
                    "Ziehen: Ausgewählte Bauteile verschieben",
                    "Entf-Taste: Ausgewählte Bauteile löschen"
                ]
            },
            connections: {
                title: "Verbindungen",
                rules: [
                    "Anschlusspunkte verbinden durch Klicken und Ziehen",
                    "Klick auf Verbindung: Auswählen",
                    "Entf-Taste: Ausgewählte Verbindung löschen"
                ]
            },
            general: {
                title: "Allgemein",
                rules: [
                    "Klick ins Leere: Auswahl aufheben",
                    "Esc-Taste: Alle Auswahlen aufheben",
                    "Strg + Z: Rückgängig (geplant)"
                ]
            }
        };
        
        // Aufgaben-Menü öffnen (Platzhalter)
        function openTaskMenu() {
            alert('Hier wird später das Aufgaben-Menü geöffnet.\n\nFunktionen:\n• Aufgaben-Übersicht\n• Schwierigkeitsgrade\n• Fortschritt anzeigen\n• Neue Aufgaben laden');
        }
        
        // Toggle für Technisches Datenblatt
        function toggleDatasheet() {
            const section = document.getElementById('datasheet-section');
            const toggle = document.getElementById('datasheet-toggle');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                toggle.textContent = '▼';
                toggle.title = 'Datenblatt ausklappen';
            } else {
                toggle.textContent = '▲';
                toggle.title = 'Datenblatt einklappen';
            }
        }
        
        // Power-Funktion
        function togglePower() {
            systemPower = !systemPower;
            const powerBtn = document.getElementById('powerBtn');
            
            if (systemPower) {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOn" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOn)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                  x="2.13" y=".91" width="17.49" height="20.74" transform="translate(22.15 .41) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                             points="5.22 8.66 5.22 17.05 16.38 17.05 16.38 8.66 18.52 8.66 18.52 .5 3.22 .5 3.22 8.66 5.22 8.66"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                          x1="16.63" y1="2.78" x2="5.5" y2="2.78"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                          x1="16.63" y1="4.46" x2="5.5" y2="4.46"/>
                                </g>
                                <rect fill="var(--color-error)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                      x="5.21" y="9.83" width="11.18" height="4.98" transform="translate(21.59 24.63) rotate(180)"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(7.47 13.58)">
                                    <tspan x="0" y="0">I</tspan>
                                    <tspan x=".99" y="0">-</tspan>
                                    <tspan x="2.34" y="0">on</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            } else {
                powerBtn.innerHTML = `
                    <span class="power-icon">
                        <svg id="power-icon" viewBox="0 0 21.74 22.48" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="powerGradientOff" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:var(--color-border);stop-opacity:1" />
                                    <stop offset="3%" style="stop-color:#c1c1c1;stop-opacity:1" />
                                    <stop offset="44%" style="stop-color:#888887;stop-opacity:1" />
                                    <stop offset="75%" style="stop-color:#646463;stop-opacity:1" />
                                    <stop offset="92%" style="stop-color:#575756;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect fill="url(#powerGradientOff)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                  x="2.13" y=".34" width="17.49" height="20.74" transform="translate(21.58 -.16) rotate(90)"/>
                            <g>
                                <g>
                                    <polygon fill="var(--color-border)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                             points="16.53 13.82 16.53 5.43 5.36 5.43 5.36 13.82 3.22 13.82 3.22 21.98 18.52 21.98 18.52 13.82 16.53 13.82"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                          x1="5.12" y1="19.7" x2="16.25" y2="19.7"/>
                                    <line fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                          x1="5.12" y1="18.02" x2="16.25" y2="18.02"/>
                                </g>
                                <rect fill="var(--color-success)" stroke="var(--color-primary)" stroke-width="2" stroke-miterlimit="10"
                                      x="5.36" y="7.68" width="11.18" height="4.98"/>
                                <text fill="var(--color-white)" font-family="Arial, sans-serif" font-size="4.15px" 
                                      transform="translate(6.36 11.7)">
                                    <tspan x="0" y="0">O</tspan>
                                    <tspan x="2.92" y="0">-</tspan>
                                    <tspan x="4.27" y="0">off</tspan>
                                </text>
                            </g>
                        </svg>
                    </span>
                    <span class="btn-text">
                        <span>Haupt-</span>
                        <span>schalter</span>
                    </span>`;
            }
            
            // Hier würde die Schaltungs-Simulation stattfinden
            simulateCircuit();
        }
        
        // ========== TEST-FUNKTIONEN ==========
        
        // Simuliere das Hinzufügen von Bauteilen (für Demo)
        function addTestComponents() {
            // Füge einen 12V Transformator hinzu
            circuit.addComponent('trafo-1', ComponentTypes.TRANSFORMER_12V, {x: 200, y: 100});
            
            // Füge eine 12V LED hinzu  
            circuit.addComponent('led-1', ComponentTypes.LED_12V, {x: 400, y: 100});
            
            // Verbinde Netzanschluss mit Transformator
            circuit.addConnection('conn-1', 'power-source-1', 'trafo-1');
            
            // Verbinde Transformator mit LED
            circuit.addConnection('conn-2', 'trafo-1', 'led-1');
            
            console.log('✅ Test-Komponenten hinzugefügt');
        }
        
        // Simuliere das Hinzufügen einer überlasteten Schaltung
        function addOverloadTest() {
            // Viele LEDs an einen kleinen Transformator
            circuit.addComponent('trafo-small', ComponentTypes.TRANSFORMER_12V, {x: 150, y: 200});
            circuit.addConnection('conn-overload-1', 'power-source-1', 'trafo-small');
            
            // 20 LEDs hinzufügen (würde 70W benötigen, aber Trafo hat nur 40W)
            for (let i = 1; i <= 20; i++) {
                circuit.addComponent(`led-overload-${i}`, ComponentTypes.LED_12V, {x: 300 + (i * 20), y: 200});
                circuit.addConnection(`conn-overload-led-${i}`, 'trafo-small', `led-overload-${i}`);
            }
            
            console.log('⚠️ Überlastungs-Test hinzugefügt');
        }
        
        // Simuliere direkten Netzanschluss (LED geht kaputt)
        function addDirectConnectionTest() {
            // LED direkt an 230V
            circuit.addComponent('led-direct', ComponentTypes.LED_12V, {x: 100, y: 300});
            circuit.addConnection('conn-direct', 'power-source-1', 'led-direct');
            
            console.log('💥 Direkt-Anschluss Test hinzugefügt (LED wird kaputtgehen!)');
        }
        
        // Arbeitsfläche leeren
        function clearWorkspace() {
            const workspace = document.getElementById('workspace');
            const powerSource = workspace.querySelector('.power-source');
            const svg = workspace.querySelector('#connectionSvg');
            
            // Alle Komponenten außer Stromquelle und SVG entfernen
            Array.from(workspace.children).forEach(child => {
                if (child !== powerSource && child !== svg) {
                    child.remove();
                }
            });
            
            connections = [];
            components = [];
        }
        
        // Verbindungen zurücksetzen
        function resetConnections() {
            const svg = document.getElementById('connectionSvg');
            svg.innerHTML = '';
            connections = [];
        }
        
        // Schaltungs-Simulation (Platzhalter)
        function simulateCircuit() {
            if (systemPower) {
                console.log('Schaltung wird simuliert...');
                // Hier würde die intelligente Feedback-Logik stehen
            }
        }
        
        // Hover-Effekt für Datenblatt
        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.component-item')) {
                const componentItem = e.target.closest('.component-item');
                const type = componentItem.getAttribute('data-component-type');
                showDatasheet(type);
            }
        });
        
        function showDatasheet(componentType) {
            const content = document.getElementById('datasheet-content');
            const typeNames = {
                'fi-schalter': 'FI-Schutzschalter',
                'ls-schalter': 'LS-Schalter',
                'zeitschaltuhr': 'Zeitschaltuhr',
                'daemmerungsschalter': 'Dämmerungsschalter',
                'trafo-12v-40w': 'Trafo 12V',
                'trafo-24v-60w': 'Trafo 24V',
                'led-12v-3.5w': 'LED-Modul 12V',
                'led-24v-5w': 'LED-Modul 24V'
            };
            
            const datasheetInfo = {
                'fi-schalter': {
                    specs: 'Nennstrom: 16A<br>Auslösestrom: 30mA<br>Schutzart: IP20<br>Einbauart: Hutschiene',
                    description: 'Schutz vor Fehlerstrom durch defekte Geräte oder Berührung spannungsführender Teile.'
                },
                'ls-schalter': {
                    specs: 'Nennstrom: 16A<br>Charakteristik: B<br>Auslösezeit: < 0,1s<br>Schutzart: IP20',
                    description: 'Schutz vor Überlast und Kurzschluss in elektrischen Anlagen.'
                },
                'trafo-12v-40w': {
                    specs: 'Eingang: 230V AC<br>Ausgang: 12V DC<br>Leistung: 40W<br>Wirkungsgrad: >85%',
                    description: 'Elektronischer Transformator für LED-Beleuchtung mit 12V Ausgangsspannung.'
                },
                'led-12v-3.5w': {
                    specs: 'Spannung: 12V DC<br>Leistung: 3,5W<br>Lichtstrom: 350lm<br>Farbtemperatur: 3000K',
                    description: 'Warmweißes LED-Modul für Niedervolt-Beleuchtungsanlagen.'
                }
            };
            
            const info = datasheetInfo[componentType] || {
                specs: 'Technische Daten werden geladen...',
                description: 'Beschreibung wird geladen...'
            };
            
            content.innerHTML = `
                <h4 class="text-h2">${typeNames[componentType] || componentType}</h4>
                <p class="text-small">${info.description}</p>
                <div class="info-box">
                    <h4>Technische Daten</h4>
                    <p class="text-small">${info.specs}</p>
                </div>
                <div class="info-box">
                    <h4>Schaltskizze</h4>
                    <p class="text-small"><em>Schaltskizze wird hier als SVG dargestellt</em></p>
                </div>
            `;
        }
        
        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle-Button Tooltip setzen
            const toggle = document.getElementById('datasheet-toggle');
            if (toggle) {
                toggle.title = 'Datenblatt einklappen';
            }
        });
        
        console.log('Lernspiel-System initialisiert');
    </script>
</body>
</html>