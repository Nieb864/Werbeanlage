<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèóÔ∏è Werbetechnik Game</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/game.css">
    <style>
        /* Werbetechnik-spezifische Game-Styles */
        .game-container {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        
        .game-header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .level-info h1 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .level-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .werbetechnik-info {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid #dc3545;
            border-radius: 8px;
            padding: 12px 20px;
            margin: 15px 20px;
            font-size: 0.9em;
            color: #721c24;
        }
        
        .game-layout {
            display: flex;
            height: calc(100vh - 140px);
        }
        
        .components-panel {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .components-header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .components-header h3 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .component-palette {
            flex: 1;
            padding: 15px;
            background: white;
        }
        
        .component-item {
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .component-item:hover {
            border-color: #FF6B35;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
            transform: translateY(-2px);
        }
        
        .component-item:active {
            cursor: grabbing;
            transform: translateY(0);
        }
        
        .component-item img {
            width: 50px;
            height: 35px;
            object-fit: contain;
            margin-right: 12px;
            border-radius: 4px;
        }
        
        .component-info {
            flex: 1;
        }
        
        .component-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .component-specs {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .power-source {
            border-color: #dc3545 !important;
        }
        
        .power-source:hover {
            border-color: #c82333 !important;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
        }
        
        .protection-device {
            border-color: #28a745 !important;
        }
        
        .protection-device:hover {
            border-color: #1e7e34 !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
        }
        
        .transformer {
            border-color: #6c757d !important;
        }
        
        .transformer:hover {
            border-color: #5a6268 !important;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3) !important;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 15px;
        }
        
        .status-panel h4 {
            margin: 0 0 10px 0;
            font-size: 1em;
            color: #495057;
        }
        
        .power-display {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid #FF6B35;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.8em;
        }
        
        .voltage-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .voltage-ac { background: #dc3545; }
        .voltage-12v { background: #007bff; }
        .voltage-24v { background: #28a745; }
        .voltage-off { background: #6c757d; }
        
        .trafo-status {
            background: rgba(108, 117, 125, 0.1);
            border-left: 3px solid #6c757d;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.8em;
        }
        
        .trafo-ok { border-color: #28a745; }
        .trafo-overload { border-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
        
        .protection-status {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.8em;
            color: #155724;
        }
        
        .game-area {
            flex: 1;
            position: relative;
            background: white;
            overflow: hidden;
        }
        
        .game-canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #wiringCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #componentsCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        .placed-component {
            position: absolute;
            pointer-events: auto;
            cursor: move;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .placed-component img {
            width: 60px;
            height: 40px;
            object-fit: contain;
            display: block;
        }
        
        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #28a745;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            z-index: 20;
            transform: translate(-50%, -50%);
        }
        
        .connection-point:hover {
            background: #34ce57;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
        }
        
        .task-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 50;
        }
        
        .task-panel h4 {
            margin: 0 0 8px 0;
            color: #495057;
            font-size: 1em;
        }
        
        .task-panel p {
            margin: 0;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .feedback-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .feedback-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .feedback-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #FF6B35;
            color: white;
        }
        
        .btn-primary:hover {
            background: #E55A2B;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .game-layout {
                flex-direction: column;
                height: auto;
            }
            
            .components-panel {
                width: 100%;
                max-height: 200px;
            }
            
            .game-area {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <header class="game-header">
            <div class="level-info">
                <h1 id="levelTitle">üèóÔ∏è Werbetechnik Level</h1>
                <p id="levelDescription">230V Installation</p>
            </div>
            <div class="header-controls">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">Zur√ºck</button>
                <button class="btn btn-primary" id="simulateBtn" onclick="runWerbetechnikSimulation()">Simulation starten</button>
                <button class="btn btn-success" id="checkBtn" onclick="checkWerbetechnikSolution()" disabled>L√∂sung pr√ºfen</button>
            </div>
        </header>

        <!-- Werbetechnik-Warnung -->
        <div class="werbetechnik-info">
            <strong>‚ö†Ô∏è 230V Werbetechnik:</strong> Verwende LS- und FI-Schutzschalter! Beachte Trafo-Leistungen und LED-Spannungen.
        </div>

        <!-- Hauptspielbereich -->
        <div class="game-layout">
            <!-- Components Panel -->
            <aside class="components-panel">
                <div class="components-header">
                    <h3>üîå 230V Komponenten</h3>
                </div>
                
                <div class="component-palette">
                    <div id="componentList">
                        <!-- Komponenten werden hier geladen -->
                    </div>
                </div>
                
                <!-- Live-Status -->
                <div class="status-panel">
                    <h4>Installation Status</h4>
                    <div id="protectionStatus"></div>
                    <div id="powerStatus"></div>
                    <div id="trafoStatus"></div>
                </div>
            </aside>

            <!-- Game Area -->
            <main class="game-area">
                <div class="game-canvas">
                    <canvas id="wiringCanvas"></canvas>
                    <div id="componentsCanvas" class="components-area"></div>
                    
                    <!-- Task Panel -->
                    <div class="task-panel">
                        <h4>Aufgabe</h4>
                        <p id="taskDescription">Verkabele die Werbetechnik-Installation</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- Feedback Panel -->
        <div id="feedbackPanel" class="feedback-panel" style="display: none;">
            <div class="feedback-content">
                <div id="feedbackIcon">‚ö°</div>
                <h3 id="feedbackTitle">Simulation</h3>
                <p id="feedbackMessage">Ergebnis wird angezeigt...</p>
                <div id="feedbackDetails"></div>
                <div class="feedback-actions">
                    <button class="btn btn-secondary" onclick="closeFeedback()">Schlie√üen</button>
                    <button class="btn btn-primary" id="nextLevelBtn" onclick="goToNextWerbetechnikLevel()" style="display: none;">N√§chstes Level</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/werbetechnik-levels.js"></script>
    <script src="js/werbetechnik-circuit.js"></script>
    <script src="js/dragdrop.js"></script>
    <script>
        // Werbetechnik Game Controller
        class WerbetechnikGame {
            constructor() {
                this.currentLevel = null;
                this.dragDropSystem = null;
                this.components = [];
                this.simulationRunning = false;
            }

            async initialize() {
                // Level laden
                const urlParams = new URLSearchParams(window.location.search);
                const levelId = parseInt(urlParams.get('level')) || 1;
                
                this.currentLevel = WerbetechnikLevels.getLevel(levelId);
                
                if (!this.currentLevel) {
                    console.error('Werbetechnik Level nicht gefunden:', levelId);
                    this.showError('Level nicht gefunden!');
                    return;
                }

                // UI initialisieren
                this.initializeUI();
                this.initializeComponentPalette();
                this.initializeDragDrop();
                this.initializeCanvas();
                
                console.log('‚úÖ Werbetechnik Game initialisiert:', this.currentLevel.title);
            }

            initializeUI() {
                document.getElementById('levelTitle').textContent = this.currentLevel.title;
                document.getElementById('levelDescription').textContent = this.currentLevel.description;
                document.getElementById('taskDescription').textContent = this.currentLevel.taskDescription || 'Verkabele die Werbetechnik-Installation sicher und korrekt.';
            }

            initializeComponentPalette() {
                const componentList = document.getElementById('componentList');
                componentList.innerHTML = '';

                this.currentLevel.components.forEach((componentDef, index) => {
                    const count = componentDef.count || 1;
                    
                    for (let i = 0; i < count; i++) {
                        const componentElement = this.createWerbetechnikComponent(componentDef, i);
                        componentList.appendChild(componentElement);
                    }
                });
            }

            createWerbetechnikComponent(componentDef, instance) {
                const div = document.createElement('div');
                div.className = `component-item ${this.getComponentClass(componentDef.type)}`;
                div.dataset.componentType = componentDef.type;
                div.dataset.instance = instance;
                div.draggable = true;
                
                // Component image und info
                div.innerHTML = `
                    <img src="${componentDef.image}" alt="${componentDef.name}" onerror="this.style.display='none'">
                    <div class="component-info">
                        <div class="component-name">${componentDef.name}</div>
                        <div class="component-specs">${this.getComponentSpecs(componentDef)}</div>
                    </div>
                `;
                
                return div;
            }

            getComponentClass(type) {
                if (type === 'power230v') return 'power-source';
                if (type.includes('switch')) return 'protection-device';
                if (type.includes('trafo_')) return 'transformer';
                if (type.includes('led_')) return 'led-load';
                return '';
            }

            getComponentSpecs(componentDef) {
                const specs = [];
                
                if (componentDef.power) specs.push(`${componentDef.power}W`);
                if (componentDef.voltage) specs.push(`${componentDef.voltage}V`);
                if (componentDef.voltage_out) specs.push(`${componentDef.voltage_out}V DC`);
                if (componentDef.rating) specs.push(`${componentDef.rating}A`);
                
                return specs.join(' ‚Ä¢ ');
            }

            initializeDragDrop() {
                const canvas = document.getElementById('componentsCanvas');
                const gameArea = document.querySelector('.game-area');
                
                if (!canvas || !gameArea) {
                    console.error('Canvas oder Game Area nicht gefunden');
                    return;
                }
                
                this.dragDropSystem = new DragDropSystem(canvas, gameArea);
                
                // Event-Handler f√ºr Komponenten-√Ñnderungen
                document.addEventListener('dragdrop:componentPlaced', (e) => {
                    this.onComponentPlaced(e.detail.component);
                });
                
                document.addEventListener('dragdrop:componentRemoved', (e) => {
                    this.onComponentRemoved(e.detail.component);
                });
            }

            initializeCanvas() {
                const wiringCanvas = document.getElementById('wiringCanvas');
                const componentsCanvas = document.getElementById('componentsCanvas');
                const gameArea = document.querySelector('.game-area');
                
                if (wiringCanvas && gameArea) {
                    const rect = gameArea.getBoundingClientRect();
                    wiringCanvas.width = rect.width;
                    wiringCanvas.height = rect.height;
                    wiringCanvas.style.width = rect.width + 'px';
                    wiringCanvas.style.height = rect.height + 'px';
                }
                
                if (componentsCanvas && gameArea) {
                    const rect = gameArea.getBoundingClientRect();
                    componentsCanvas.style.width = rect.width + 'px';
                    componentsCanvas.style.height = rect.height + 'px';
                }
            }

            onComponentPlaced(component) {
                console.log('Werbetechnik-Komponente platziert:', component.type);
                this.updateStatus();
                this.enableSimulationIfReady();
            }

            onComponentRemoved(component) {
                console.log('Werbetechnik-Komponente entfernt:', component.type);
                this.updateStatus();
                this.enableSimulationIfReady();
            }

            enableSimulationIfReady() {
                const placedComponents = this.dragDropSystem ? this.dragDropSystem.getPlacedComponents() : [];
                const hasComponents = placedComponents.length > 0;
                
                document.getElementById('simulateBtn').disabled = !hasComponents;
            }

            updateStatus() {
                this.updateProtectionStatus();
                this.updatePowerStatus();
                this.updateTrafoStatus();
            }

            updateProtectionStatus() {
                const protectionDiv = document.getElementById('protectionStatus');
                if (!protectionDiv) return;

                const placedComponents = this.dragDropSystem ? this.dragDropSystem.getPlacedComponents() : [];
                const lsSwitch = placedComponents.find(c => c.type === 'ls_switch');
                const fiSwitch = placedComponents.find(c => c.type === 'fi_switch');

                let statusHTML = '<div class="protection-status">';
                statusHTML += `<div>LS-Schalter: ${lsSwitch ? '‚úÖ Platziert' : '‚ùå Fehlt'}</div>`;
                statusHTML += `<div>FI-Schalter: ${fiSwitch ? '‚úÖ Platziert' : '‚ùå Fehlt'}</div>`;
                statusHTML += '</div>';

                protectionDiv.innerHTML = statusHTML;
            }

            updatePowerStatus() {
                const powerDiv = document.getElementById('powerStatus');
                if (!powerDiv) return;

                const placedComponents = this.dragDropSystem ? this.dragDropSystem.getPlacedComponents() : [];
                const powerSource = placedComponents.find(c => c.type === 'power230v');
                
                let statusHTML = '<div class="power-display">';
                statusHTML += `<span class="voltage-indicator voltage-ac"></span>`;
                statusHTML += `230V AC: ${powerSource ? '‚úÖ Angeschlossen' : '‚ùå Nicht angeschlossen'}`;
                statusHTML += '</div>';

                powerDiv.innerHTML = statusHTML;
            }

            updateTrafoStatus() {
                const trafoDiv = document.getElementById('trafoStatus');
                if (!trafoDiv) return;

                const placedComponents = this.dragDropSystem ? this.dragDropSystem.getPlacedComponents() : [];
                const trafos = placedComponents.filter(c => c.type && c.type.includes('trafo_'));
                
                let statusHTML = '';
                if (trafos.length > 0) {
                    trafos.forEach(trafo => {
                        const power = trafo.definition?.power || 'N/A';
                        statusHTML += '<div class="trafo-status trafo-ok">';
                        statusHTML += `${trafo.data?.name || trafo.type}: ${power}W`;
                        statusHTML += '</div>';
                    });
                } else {
                    statusHTML = '<div class="trafo-status">Keine Transformatoren platziert</div>';
                }

                trafoDiv.innerHTML = statusHTML;
            }

            showError(message) {
                alert('Fehler: ' + message);
                window.location.href = 'index.html';
            }
        }

        // Globale Funktionen
        let werbetechnikGame;

        function runWerbetechnikSimulation() {
            console.log('üîç Werbetechnik-Simulation starten...');
            
            if (!werbetechnikGame || werbetechnikGame.simulationRunning) return;

            const placedComponents = werbetechnikGame.dragDropSystem ? werbetechnikGame.dragDropSystem.getPlacedComponents() : [];
            
            if (placedComponents.length === 0) {
                alert('Platziere zuerst einige 230V Komponenten!');
                return;
            }

            werbetechnikGame.simulationRunning = true;
            const simulateBtn = document.getElementById('simulateBtn');
            
            simulateBtn.disabled = true;
            simulateBtn.textContent = 'Simuliere...';

            try {
                // Einfache Simulation f√ºr Demo
                const hasLS = placedComponents.some(c => c.type === 'ls_switch');
                const hasFI = placedComponents.some(c => c.type === 'fi_switch');
                const hasPower = placedComponents.some(c => c.type === 'power230v');
                
                const result = {
                    success: hasLS && hasFI && hasPower,
                    message: hasLS && hasFI && hasPower ? 
                        'Installation korrekt! Alle Schutzeinrichtungen vorhanden.' :
                        'Fehler: Schutzschalter (LS/FI) oder Stromversorgung fehlt!',
                    components: placedComponents.length,
                    protection: hasLS && hasFI
                };
                
                showWerbetechnikSimulationResult(result);
                
                if (result.success) {
                    document.getElementById('checkBtn').disabled = false;
                }

            } catch (error) {
                console.error('Simulation error:', error);
                showWerbetechnikSimulationResult({
                    success: false,
                    message: 'Simulationsfehler: ' + error.message
                });
            } finally {
                werbetechnikGame.simulationRunning = false;
                simulateBtn.disabled = false;
                simulateBtn.textContent = 'Simulation starten';
            }
        }

        function showWerbetechnikSimulationResult(result) {
            const feedbackPanel = document.getElementById('feedbackPanel');
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const feedbackDetails = document.getElementById('feedbackDetails');

            if (result.success) {
                feedbackIcon.textContent = '‚ö°';
                feedbackTitle.textContent = 'Simulation Erfolgreich';
                feedbackMessage.textContent = result.message;
                
                feedbackDetails.innerHTML = `
                    <div style="text-align: left; margin-top: 15px;">
                        <div>‚úÖ Komponenten: ${result.components}</div>
                        <div>‚úÖ Schutzeinrichtungen: ${result.protection ? 'OK' : 'Fehlt'}</div>
                        <div>‚ö° 230V Installation bereit</div>
                    </div>
                `;
            } else {
                feedbackIcon.textContent = '‚ùå';
                feedbackTitle.textContent = 'Simulation Fehlgeschlagen';
                feedbackMessage.textContent = result.message;
                feedbackDetails.innerHTML = '';
            }

            feedbackPanel.style.display = 'flex';
        }

        function checkWerbetechnikSolution() {
            console.log('‚úÖ Werbetechnik-L√∂sung pr√ºfen...');
            alert('L√∂sung wird gepr√ºft... (Feature in Entwicklung)');
        }

        function closeFeedback() {
            document.getElementById('feedbackPanel').style.display = 'none';
        }

        function goToNextWerbetechnikLevel() {
            console.log('‚û°Ô∏è N√§chstes Werbetechnik-Level...');
            window.location.href = 'index.html';
        }

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üèóÔ∏è Starte Werbetechnik Game');
            
            werbetechnikGame = new WerbetechnikGame();
            werbetechnikGame.initialize();
            
            // Resize-Handler
            window.addEventListener('resize', () => {
                if (werbetechnikGame) {
                    werbetechnikGame.initializeCanvas();
                }
            });
        });
    </script>
</body>
</html>